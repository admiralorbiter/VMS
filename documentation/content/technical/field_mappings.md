# Field Mappings

**Cross-system data flow specifications**

## Reference

Field definitions are in [Data Dictionary](data_dictionary). This page documents how data flows between systems.

## Normalization Rules (Apply Everywhere)

| Rule | Implementation | Notes |
|------|----------------|-------|
| **Emails** | `trim + lowercase` | Via `get_email_addresses()` in `routes/utils.py` |
| **Strings** | `trim`, collapse repeated whitespace | Applied throughout all string fields |
| **Dropdowns** | Must match controlled vocabulary; reject tampered values | Validated against enum values (GenderEnum, RaceEthnicityEnum, etc.) |
| **Dates** | ISO-8601 with explicit timezone (America/Chicago default) | Via `parse_date()` function in `routes/utils.py`; handles multiple formats |

**Date Parsing Details**:
- Handles ISO 8601 format: `2025-03-05T14:15:00.000+0000`
- Handles CSV format with time: `YYYY-MM-DD HH:MM:SS`
- Handles CSV format without seconds: `YYYY-MM-DD HH:MM`
- Handles date only: `YYYY-MM-DD`
- Returns `datetime` object with timezone support

## Canonical Join Keys

| Entity | Join Key | Format | Notes |
|--------|----------|--------|-------|
| In-person event | `Event.salesforce_id` | SF 18-char ID | Unique, indexed; required for in-person events |
| Volunteer | `Email.email` | Normalized lowercase | Primary join key; dedupe by normalized email |
| Teacher | `Email.email` or `TeacherProgress.email` | Normalized lowercase | Primary join key for roster matching; magic link eligibility |
| Pathful session | `SessionId + teacher_email` | Composite | Composite preferred for idempotent imports |

---

# Part 1: VolunTeach Integrations

## 1. Salesforce → VolunTeach (In-person Sync)

**Sync Behavior**: Idempotent on `salesforce_id`. SF edits overwrite VT. VT-owned fields preserved.

**Implementation**: `routes/upcoming_events.py`, `models/upcoming_event.py`, `sync_script.py`

**Contract**: [Contract A: Salesforce → VolunTeach](contract_a)

### Core Event Fields (Required)

| SF Field | VT Field | Notes |
|----------|----------|-------|
| `Session__c.Id` | `salesforce_id` | 18-char SF ID; unique, indexed |
| `Session__c.Name` | `name` | Event title |
| `Session__c.Start_Date__c` | `start_date` | Date only (YYYY-MM-DD), converted to ISO-8601 UTC |
| `Session__c.Available_Slots__c` | `available_slots` | Defaults to 0 |
| `Session__c.Filled_Volunteer_Jobs__c` | `filled_volunteer_jobs` | Defaults to 0 |
| `Session__c.Session_Type__c` | `event_type` | e.g., "Ignite", "Virtual Workshop" |
| `Session__c.Session_Status__c` | `session_status` | Raw SF status; not used for filtering |

### Additional Imported Fields

| SF Field | VT Field | Notes |
|----------|----------|-------|
| `Session__c.Date_and_Time_for_Cal__c` | `date_and_time` | Display string (e.g., "09/15/2025 08:00 AM to 12:00 PM") |
| `Session__c.Registration_Link__c` | `registration_link` | **CRITICAL**: The Form Assembly URL generated by SF integration. Website uses this for the "Sign Up" button. |
| `Session__c.Display_on_Website__c` | `display_on_website` | **Imported on creation only** ('Yes' → True); preserved on updates |

### VolunTeach-Managed Fields

| VT Field | Type | Notes |
|----------|------|-------|
| `status` | String | VT-managed: 'active' or 'archived'; auto-set based on slots |
| `source` | String | 'salesforce' for In-Person, 'virtual' for Virtual events |
| `note` | Text | VT-only field for internal staff notes |
| `districts` | Relationship | VT-managed via EventDistrictMapping table |

> [!NOTE]
> **Status Logic**:
> - `status = 'archived'` when `available_slots == 0 AND filled_volunteer_jobs > 0`
> - `status = 'active'` when `available_slots > 0`

> [!NOTE]
> **Multi-District Events**: VT uses the `districts` relationship (EventDistrictMapping table) to associate events with multiple districts. The SF `District__c` field is only used for Virtual events.

### Fields NOT Imported

| SF Field | Reason |
|----------|--------|
| `End_Date__c` | Not in VT model |
| `School__c` | VT uses districts instead |
| `Format__c` | VT uses `source` field instead |
| `Location_Information__c` | Not in current model |
| `Description__c` | Not in current model |
| `Additional_Information__c` | Not in current model |
| `Session_Host__c` | Not in current model |
| `Non_Scheduled_Students_Count__c` | Not in current model |
| `Total_Requested_Volunteer_Jobs__c` | Not in current model |
| `Cancellation_Reason__c` | Not in current model |
| `Legacy_Skill_Covered_for_the_Session__c` | Not in current model |
| `Legacy_Skills_Needed__c` | Not in current model |
| `Requested_Skills__c` | Not in current model |

### Sync Filters (SOQL Query)

Events are imported only if they meet ALL criteria:
- `Start_Date__c > TODAY` (future events only)
- `Available_Slots__c > 0` (available slots required)
- `Session_Status__c != 'Draft'` (draft sessions excluded)

### Automatic Cleanup

- **Past events deleted**: `start_date < yesterday`
- **Full events archived**: `available_slots == 0 AND filled_volunteer_jobs > 0`
- **Missing from SF deleted**: Events not in query results (includes Draft sessions)

**Failure Handling**: Missing required fields (Id, Name, Start_Date__c) cause event to be skipped with error logged.

---

# Part 2: Polaris Integrations

## 2. Salesforce → Polaris (Volunteer Import)

**Implementation**: `routes/salesforce/volunteer_import.py` (`/volunteers/import-from-salesforce`)

| SF Field | POL Target | Transform | Notes |
|----------|------------|-----------|-------|
| `Contact.Id` | `Volunteer.salesforce_individual_id` | direct | 18-char SF ID |
| `Contact.AccountId` | `Volunteer.salesforce_account_id` | direct | SF Account ID |
| `Contact.FirstName` | `Volunteer.first_name` | trim | Required |
| `Contact.LastName` | `Volunteer.last_name` | trim | Required |
| `Contact.MiddleName` | `Volunteer.middle_name` | trim | Optional |
| `Contact.Email` | `Email.email` | normalize: lowercase + trim | Primary email |
| `Contact.npe01__Preferred_Email__c` | `Email.email` | normalize: lowercase + trim | Preferred email (primary flag) |
| `Contact.npsp__Primary_Affiliation__c` | `Volunteer.organization_name` | trim | Organization name |
| `Contact.Title` | `Volunteer.title` | trim | Job title |
| `Contact.Department` | `Volunteer.department` | trim | Department |
| `Contact.Industry` | `Volunteer.industry` | trim | Industry |
| `Contact.Gender__c` | `Volunteer.gender` | `map_gender()` → GenderEnum | Maps to enum |
| `Contact.Birthdate` | `Contact.birthdate` | `parse_date()` | Date of birth |
| `Contact.Racial_Ethnic_Background__c` | `Volunteer.race_ethnicity` | map to RaceEthnicityEnum | Maps to enum |
| `Contact.Highest_Level_of_Educational__c` | `Volunteer.education` | map to EducationEnum | Maps to enum |
| `Contact.Age_Group__c` | `Contact.age_group` | map to AgeGroupEnum | Maps to enum |
| `Contact.Volunteer_Skills__c` | `Volunteer.skills` (many-to-many) | `parse_volunteer_skills()` | Parsed and linked to Skill table |
| `Contact.First_Volunteer_Date__c` | `Volunteer.first_volunteer_date` | `parse_date()` | First volunteer date |
| `Contact.Last_Volunteer_Date__c` | `Volunteer.last_volunteer_date` | `parse_date()` | Last volunteer date |
| `Contact.DoNotCall` | `Contact.do_not_call` | direct boolean | Phone contact preference |
| `Contact.npsp__Do_Not_Contact__c` | `Contact.do_not_contact` | direct boolean | General contact preference |
| `Contact.HasOptedOutOfEmail` | `Contact.email_opt_out` | direct boolean | Email marketing preference |
| `Contact.EmailBouncedDate` | `Contact.email_bounced_date` | `parse_date()` | Failed email delivery tracking |

**Dedupe**: Match by `salesforce_individual_id` (SF Contact.Id). If found, update existing; otherwise create new.

## 3. Salesforce → Polaris (Teacher Import)

**Implementation**: `routes/salesforce/teacher_import.py` (`/teachers/import-from-salesforce`)

| SF Field | POL Target | Transform | Notes |
|----------|------------|-----------|-------|
| `Contact.Id` | `Teacher.salesforce_individual_id` | direct | 18-char SF ID |
| `Contact.AccountId` | `Teacher.salesforce_account_id` | direct | SF Account ID |
| `Contact.FirstName` | `Teacher.first_name` | trim | Required |
| `Contact.LastName` | `Teacher.last_name` | trim | Required |
| `Contact.Email` | `Email.email` | normalize: lowercase + trim | Primary email |
| `Contact.npsp__Primary_Affiliation__c` | `Teacher.school_id` | direct | School SF ID |
| `Contact.Department` | `Teacher.department` | trim | Department |
| `Contact.Gender__c` | `Teacher.gender` | map to GenderEnum | Maps to enum |
| `Contact.Phone` | `Phone.number` | trim | Primary phone |

**Dedupe**: Match by `salesforce_individual_id` (SF Contact.Id). If found, update existing; otherwise create new.

## 4. Salesforce → Polaris (Student Participation Import)

**Implementation**: `routes/salesforce/event_import.py` (`process_student_participation_row()`)

| SF Field | POL Target | Transform | Notes |
|----------|------------|-----------|-------|
| `Session_Participant__c.Id` | `EventStudentParticipation.salesforce_id` | direct | 18-char SF ID; unique |
| `Session_Participant__c.Session__c` | `EventStudentParticipation.event_id` | match by `Event.salesforce_id` | Must match existing Event |
| `Session_Participant__c.Contact__c` | `EventStudentParticipation.student_id` | match by `Student.salesforce_individual_id` | Must match existing Student |
| `Session_Participant__c.Status__c` | `EventStudentParticipation.status` | direct | e.g., 'Registered', 'Attended', 'No Show' |
| `Session_Participant__c.Delivery_Hours__c` | `EventStudentParticipation.delivery_hours` | parse float | Delivery hours |
| `Session_Participant__c.Age_Group__c` | `EventStudentParticipation.age_group` | direct | Age group at time of event |

**Idempotency**: Unique constraint on (`event_id`, `student_id`). If pair exists, update; otherwise create new.

## 5. Website Signup → SF + Polaris

## 5. Website Signup → SF + Polaris

**Sync Behavior**: Form Assembly creates Salesforce record immediately. Polaris syncs new record daily. Dedupe by normalized email.

**Implementation**: Mediated by Form Assembly configuration (external).

**Contract**: [Contract B: Website ↔ VolunTeach API](contract_b) (Event display only)

| Website Field | SF Target | POL Target | Transform | Req | Sensitivity |
|---------------|-----------|------------|-----------|-----|-------------|
| `first_name` | `Contact.FirstName` | `Volunteer.first_name` | trim | ✅ | Sensitive (PII) |
| `last_name` | `Contact.LastName` | `Volunteer.last_name` | trim | ✅ | Sensitive (PII) |
| `middle_name` | `Contact.MiddleName` | `Volunteer.middle_name` | trim | ⛔️ | Sensitive (PII) |
| `email` | `Contact.Email` | `Email.email` | normalize: lowercase + trim | ✅ | Sensitive (PII) |
| `organization_name` | `Contact.Organization__c` | `Volunteer.organization_name` | trim | ⛔️ | Internal |
| `title` | `Contact.Title` | `Volunteer.title` | trim | ⛔️ | Internal |
| `department` | `Contact.Department` | `Volunteer.department` | trim | ⛔️ | Internal |
| `industry` | `Contact.Industry` | `Volunteer.industry` | trim | ⛔️ | Internal |
| `gender` | `Contact.Gender__c` | `Volunteer.gender` | Must match GenderEnum | ⛔️ | Highly Sensitive |
| `race_ethnicity` | `Contact.Racial_Ethnic_Background__c` | `Volunteer.race_ethnicity` | Must match RaceEthnicityEnum | ⛔️ | Highly Sensitive |
| `education` | `Contact.Highest_Level_of_Educational__c` | `Volunteer.education` | Must match EducationEnum | ⛔️ | Highly Sensitive |
| `age_group` | `Contact.Age_Group__c` | `Contact.age_group` | Must match AgeGroupEnum | ⛔️ | Highly Sensitive |
| `skills` | `Contact.Volunteer_Skills__c` | `Volunteer.skills` (many-to-many) | comma-separated, cleaned, linked to Skill table | ⛔️ | Internal |
| `salutation` | `Contact.Salutation` | `Contact.salutation` | Must match SalutationEnum | ⛔️ | Sensitive |
| `suffix` | `Contact.Suffix` | `Contact.suffix` | Must match SuffixEnum | ⛔️ | Sensitive |
| `phone` | `Contact.Phone` | `Phone.number` | trim | ⛔️ | Sensitive (PII) |
| `local_status` | n/a | `Volunteer.local_status` | Must match LocalStatusEnum | ⛔️ | Internal |

**Dedupe Rule**: Match existing volunteer by normalized email (lowercase). If found, update existing record; otherwise create new.

**Validation**:
- Required fields: first_name, last_name, email
- Enum fields must match controlled vocabulary; invalid values rejected
- Email must be valid format (validated by Flask-WTF Email validator)

## 6. Pathful Export → Polaris

**Sync Behavior**: Idempotent on `SessionId + teacher_email` composite key. Unknown teacher/event → row flagged unmatched, not auto-created.

**Implementation**: Referenced in [Data Dictionary](data_dictionary#entity-eventparticipation) and requirements.

**Contract**: [Contract D: Pathful Export → Polaris](contract_d)

| Pathful Column | POL Target | Transform | Idempotency | Notes |
|----------------|------------|-----------|-------------|-------|
| `SessionId` | `EventParticipation.external_row_id` | direct | Primary key | For idempotent imports |
| `EventId` | `Event.session_id` or match by `Event.pathful_event_id` | direct | Must match known event | Must match existing Event record |
| `TeacherEmail` | `Teacher.email` | normalize: lowercase | Join key for roster | Primary join key; must match TeacherProgress or Teacher record |
| `SessionStart` | `EventParticipation` datetime fields | ISO-8601 | — | Session start datetime |
| `AttendanceStatus` | `EventParticipation.status` | Map to enum | — | Maps to attendance status enum |
| `ParticipantType` | `EventParticipation.participant_type` | direct | — | Default: "Volunteer"; also "Presenter" for virtual events |

**Failure Handling**:
- Unknown teacher: Row flagged as unmatched; teacher not auto-created
- Unknown event: Row flagged as unmatched; event not auto-created
- Missing required columns: Import fails with clear missing-columns message

**Idempotency**: Same file imported twice results in updates only, no duplicates (based on `SessionId + teacher_email` composite key).

## 7. Teacher Roster Import

**Sync Behavior**: Creates/updates TeacherProgress records. Used for progress tracking and magic-link eligibility.

**Implementation**: `models/teacher_progress.py`, `routes/virtual/usage.py`

| Roster Column | POL Target | Transform | Req | Notes |
|---------------|-----------|-----------|-----|-------|
| `Teacher Email` | `TeacherProgress.email` | normalize: lowercase | ✅ | Primary key; primary join key for magic links + Pathful |
| `Teacher Name` | `TeacherProgress.name` | split first/last if needed | ✅ | Teacher full name |
| `School` or `Building` | `TeacherProgress.building` | direct | ✅ | School/building name |
| `District` | derived from school relationship | via School.district_id | ⛔️ | Derived from school relationship |
| `Grade` | `TeacherProgress.grade` | direct | ⛔️ | Grade level (K, 1-12, HS, etc.) |
| `Academic Year` | `TeacherProgress.academic_year` | direct | ✅ | e.g., "2024-2025" |
| `Virtual Year` | `TeacherProgress.virtual_year` | direct | ✅ | e.g., "2024-2025" |
| `Target Sessions` | `TeacherProgress.target_sessions` | int, default: 1 | ⛔️ | Target number of sessions; default: 1 |

**Usage**: Used as authoritative list for progress tracking and magic-link eligibility. See [FR-DISTRICT-524](requirements-district#fr-district-524) and [US-504](user-stories#us-504).

**Matching to Teacher Records**: TeacherProgress entries can be matched to Teacher records via:
- Automatic matching: By email (normalized lowercase)
- Manual matching: Via admin interface (`/virtual/usage/match-teacher-progress`)

**Related Models**:
- `TeacherProgress.teacher_id` (optional FK to `Teacher.id`): Links to Teacher record when matched
- `TeacherProgress.created_by` (FK to `users.id`): User who created record

---

*Last updated: February 2026*
*Version: 1.2*
