{#
  Admin Dashboard Template
  =======================

  This template provides the main administrative interface for the Volunteer Management System.
  It includes user management, password changes, data import functionality, and various
  administrative tools for system management.

  Key Features:
  - User creation and management (admin only)
  - Password change functionality
  - Salesforce data import system
  - Import progress tracking and status display
  - Modal dialogs for user editing
  - Responsive design with Bootstrap
  - Real-time import status updates

  Admin Functions:
  - Create new users with role assignment
  - Change user passwords
  - Import data from Salesforce (organizations, schools, classes)
  - Sequential import with progress tracking
  - User management and editing

  Import System:
  - Sequential import with dependency order
  - Progress bars for each import type
  - Status messages and error handling
  - Import all functionality
  - Individual import options

  Modal Features:
  - User editing modal
  - Custom modal styling
  - Form validation
  - Dynamic content loading

  Template Variables:
  - current_user: Current authenticated user object
  - users: List of system users (for management)
  - import_status: Status of import operationsadd

  Dependencies:
  - Bootstrap 5.3.3 CSS/JS
  - FontAwesome icons
  - Custom admin.css for styling
  - Custom JavaScript for import functionality

  Security Features:
  - Admin-only access controls
  - CSRF protection
  - Form validation
  - User authentication checks

  JavaScript Integration:
  - Import functionality with AJAX
  - Progress tracking
  - Modal management
  - Form submission handling
#}

{% extends "base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    /* Custom Modal Styles */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
    }

    .modal-backdrop.show {
        display: block;
    }

    .modal-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        z-index: 1010;
        max-width: 500px;
        width: 90%;
        display: none;
    }

    .modal-container.show {
        display: block;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }

    .modal-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .form-group label {
        font-weight: bold;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    .modal-container.show {
        display: block;
    }
</style>
{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1>Admin Dashboard</h1>

    {% if current_user.is_admin %}
    {# User Creation Form - Admin only #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Create New User</h5>
            <form id="createUserForm" method="POST" action="{{ url_for('auth.create_user') }}">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <input type="text" name="username" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="col-auto">
                        <input type="email" name="email" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="col-auto">
                        <input type="password" name="password" class="form-control" placeholder="Password" required>
                    </div>
                    <div class="col-auto">
                        <select name="security_level" class="form-select" required>
                            <option value="" disabled selected>Select Role</option>
                            <option value="0">User</option>
                            <option value="1">Supervisor</option>
                            <option value="2">Manager</option>
                            <option value="3">Admin</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {# Password Change Form #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Change Password</h5>
            <form id="changePasswordForm" method="POST" action="{{ url_for('auth.change_password') }}">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <input type="password" name="new_password" class="form-control" placeholder="New Password" required>
                    </div>
                    <div class="col-auto">
                        <input type="password" name="confirm_password" class="form-control" placeholder="Confirm New Password" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% if current_user.is_admin %}
    {# Regular Import Section - Admin only #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title mb-0">Regular Data Imports</h5>
            <p class="text-muted mb-3">Import data from Salesforce for regular operations. These imports can be run frequently as needed.</p>

            {# Import All button with progress tracking #}
            <div class="mb-4">
                <button onclick="importAllSequentially()" class="btn admin-btn-import" id="importAllBtn">
                    <i class="fas fa-download"></i>
                    <span>Import All Regular Data Sequentially</span>
                </button>
                <div class="import-status" id="importAllStatus"></div>
                <div class="import-progress" id="importAllProgress">
                    <div class="import-progress-bar"></div>
                </div>
            </div>

            {# Individual import options grid #}
            <div class="import-grid">
                {# Organizations import #}
                <div class="import-item">
                    <button onclick="importOrganizations()" class="btn admin-btn-import" id="importOrganizationsBtn">
                        <i class="fas fa-building"></i>
                        <span>1. Import Organizations</span>
                    </button>
                    <div class="import-status" id="importOrganizationsStatus"></div>
                    <div class="import-progress" id="importOrganizationsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Schools import #}
                <div class="import-item">
                    <button onclick="importSchools()" class="btn admin-btn-import" id="importSchoolsBtn">
                        <i class="fas fa-school"></i>
                        <span>2. Import Schools</span>
                    </button>
                    <div class="import-status" id="importSchoolsStatus"></div>
                    <div class="import-progress" id="importSchoolsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Classes import #}
                <div class="import-item">
                    <button onclick="importClasses()" class="btn admin-btn-import" id="importClassesBtn">
                        <i class="fas fa-file-import"></i>
                        <span>3. Import Classes</span>
                    </button>
                    <div class="import-status" id="importClassesStatus"></div>
                    <div class="import-progress" id="importClassesProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Teachers import #}
                <div class="import-item">
                    <button onclick="importTeachers()" class="btn admin-btn-import" id="importTeachersBtn">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>4. Import Teachers</span>
                    </button>
                    <div class="import-status" id="importTeachersStatus"></div>
                    <div class="import-progress" id="importTeachersProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Teachers Management #}
                <div class="import-item">
                    <a href="{{ url_for('teachers.list_teachers') }}" class="btn admin-btn-import" id="manageTeachersBtn" style="display: flex; align-items: center;">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Manage Teachers</span>
                    </a>
                    <div class="import-status" id="manageTeachersStatus"></div>
                </div>

                {# Volunteers import #}
                <div class="import-item">
                    <button onclick="importVolunteers()" class="btn admin-btn-import" id="importVolunteersBtn">
                        <i class="fas fa-users"></i>
                        <span>5. Import Volunteers</span>
                    </button>
                    <div class="import-status" id="importVolunteersStatus"></div>
                    <div class="import-progress" id="importVolunteersProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Volunteer-Organization Affiliations import #}
                <div class="import-item">
                    <button onclick="importAffiliations()" class="btn admin-btn-import" id="importAffiliationsBtn">
                        <i class="fas fa-link"></i>
                        <span>6. Import Affiliations</span>
                    </button>
                    <div class="import-status" id="importAffiliationsStatus"></div>
                    <div class="import-progress" id="importAffiliationsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Events import #}
                <div class="import-item">
                    <button onclick="importEvents()" class="btn admin-btn-import" id="importEventsBtn">
                        <i class="fas fa-calendar"></i>
                        <span>7. Import Events</span>
                    </button>
                    <div class="import-status" id="importEventsStatus"></div>
                    <div class="import-progress" id="importEventsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Student Participations import #}
                <div class="import-item">
                    <button onclick="importStudentParticipants()" class="btn admin-btn-import" id="importStudentParticipantsBtn">
                        <i class="fas fa-user-check"></i>
                        <span>8. Import Student Participations</span>
                    </button>
                    <div class="import-status" id="importStudentParticipantsStatus"></div>
                    <div class="import-progress" id="importStudentParticipantsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# History import #}
                <div class="import-item">
                    <button onclick="importHistory()" class="btn admin-btn-import" id="importHistoryBtn">
                        <i class="fas fa-history"></i>
                        <span>9. Import History</span>
                    </button>
                    <div class="import-status" id="importHistoryStatus"></div>
                    <div class="import-progress" id="importHistoryProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Pathways import #}
                <div class="import-item">
                    <button onclick="importPathways()" class="btn admin-btn-import" id="importPathwaysBtn">
                        <i class="fas fa-road"></i>
                        <span>10. Import Pathways</span>
                    </button>
                    <div class="import-status" id="importPathwaysStatus"></div>
                    <div class="import-progress" id="importPathwaysProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Pathway Participants import #}
                <div class="import-item">
                    <button onclick="importPathwayParticipants()" class="btn admin-btn-import" id="importPathwayParticipantsBtn">
                        <i class="fas fa-users"></i>
                        <span>11. Import Pathway Participants</span>
                    </button>
                    <div class="import-status" id="importPathwayParticipantsStatus"></div>
                    <div class="import-progress" id="importPathwayParticipantsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Virtual Events import #}
                <div class="import-item">
                    <a href="{{ url_for('management.google_sheets') }}" class="btn admin-btn-import" id="manageGoogleSheetsBtn" style="display: flex; align-items: center;">
                        <i class="fas fa-file-spreadsheet"></i>
                        <span>Manage Virtual Event Google Sheets</span>
                    </a>
                    <div class="import-status" id="importVirtualStatus"></div>
                    <div class="import-progress" id="importVirtualProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Sync Unaffiliated Events #}
                <div class="import-item">
                    <button onclick="syncUnaffiliatedEvents()" class="btn admin-btn-import" id="syncUnaffiliatedEventsBtn">
                        <i class="fas fa-sitemap"></i>
                        <span>Sync Unaffiliated Events (by Students)</span>
                    </button>
                    <div class="import-status" id="syncUnaffiliatedEventsStatus"></div>
                    <div class="import-progress" id="syncUnaffiliatedEventsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Quarterly Student Updates Section #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title mb-0">Quarterly Student Updates</h5>
            <p class="text-muted mb-3">Student data is updated quarterly. This section contains the two-phase import pipeline for comprehensive student data management.</p>

            {# Student Import Pipeline Information #}
            <div class="alert alert-info mb-3">
                <h6><i class="fas fa-info-circle"></i> Student Import Pipeline</h6>
                <p class="mb-2">The student import uses a two-phase pipeline for better reliability:</p>
                <ul class="mb-0">
                    <li><strong>Phase 1:</strong> Import all student data (names, grades, contact info) without school assignments</li>
                    <li><strong>Phase 2:</strong> Assign schools to students based on Salesforce relationships</li>
                    <li><strong>Status Check:</strong> Monitor the pipeline and get recommendations</li>
                </ul>
                <p class="mb-0 mt-2"><small>This approach ensures all students are imported even if some schools are missing, and allows for better error handling.</small></p>
            </div>

            {# Student Pipeline Status - Prominent Display #}
            <div class="mb-4">
                <button onclick="checkStudentPipelineStatus()" class="btn btn-info" id="checkPipelineStatusBtn" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-chart-line"></i>
                    <span>Check Current Student Pipeline Status</span>
                </button>
                <div class="import-status" id="checkPipelineStatusStatus"></div>
            </div>

            {# Student import options grid #}
            <div class="import-grid">
                {# Test limited student import #}
                <div class="import-item">
                    <button onclick="testStudentImportLimited()" class="btn admin-btn-import" id="testStudentImportLimitedBtn">
                        <i class="fas fa-flask"></i>
                        <span>Test Import Students (1000 limit)</span>
                    </button>
                    <div class="import-status" id="testStudentImportLimitedStatus"></div>
                    <div class="import-progress" id="testStudentImportLimitedProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Students import - Phase 1 #}
                <div class="import-item">
                    <button onclick="importStudentsPhase1()" class="btn admin-btn-import" id="importStudentsPhase1Btn">
                        <i class="fas fa-user-graduate"></i>
                        <span>Import Students (Phase 1)</span>
                    </button>
                    <div class="import-status" id="importStudentsPhase1Status"></div>
                    <div class="import-progress" id="importStudentsPhase1Progress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Student School Assignment - Phase 2 #}
                <div class="import-item">
                    <button onclick="assignSchoolsToStudents()" class="btn admin-btn-import" id="assignSchoolsBtn">
                        <i class="fas fa-link"></i>
                        <span>Assign Schools to Students (Phase 2)</span>
                    </button>
                    <div class="import-status" id="assignSchoolsStatus"></div>
                    <div class="import-progress" id="assignSchoolsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                {# Students Management #}
                <div class="import-item">
                    <a href="{{ url_for('students.view_students') }}" class="btn admin-btn-import" id="manageStudentsBtn" style="display: flex; align-items: center;">
                        <i class="fas fa-user-graduate"></i>
                        <span>Manage Students</span>
                    </a>
                    <div class="import-status" id="manageStudentsStatus"></div>
                </div>
            </div>
        </div>
    </div>

    {# Volunteer Management Section #}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Volunteer Management</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-grid gap-2">
                        <button id="updateLocalStatus" class="btn btn-primary">
                            <i class="fa-solid fa-location-dot"></i> Update Volunteer Local Statuses
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Purge Data Section #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title text-danger mb-0">Purge Data</h5>
            <p class="text-muted mb-3">Warning: These actions will permanently delete data from the system. This cannot be undone.</p>
            <div class="purge-grid">
                <div class="purge-item">
                    <button onclick="purgeVolunteers()" class="btn admin-btn-danger" id="purgeVolunteersBtn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Purge All Volunteer Data</span>
                    </button>
                    <div class="purge-status" id="purgeVolunteersStatus"></div>
                </div>
                <div class="purge-item">
                    <button onclick="purgeEvents()" class="btn admin-btn-danger" id="purgeEventsBtn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Purge All Events</span>
                    </button>
                    <div class="purge-status" id="purgeEventsStatus"></div>
                </div>
                <div class="purge-item">
                    <button onclick="purgeVirtualSessions()" class="btn admin-btn-danger" id="purgeVirtualSessionsBtn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Purge Virtual Sessions</span>
                    </button>
                    <div class="purge-status" id="purgeVirtualSessionsStatus"></div>
                </div>
            </div>
        </div>
    </div>

    {# Report Cache Management #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Report Cache Management</h5>
            <button onclick="refreshDistrictReport()" class="btn admin-btn-import" id="refreshDistrictReportBtn">
                <i class="fas fa-sync"></i>
                <span>Refresh District Year-End Report Cache</span>
            </button>
            <div class="import-status" id="refreshDistrictReportStatus"></div>
        </div>
    </div>

    {# System Management #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">System Management</h5>
            <div class="d-grid gap-2 d-md-block">
                <a href="{{ url_for('management.bug_reports') }}" class="btn btn-primary me-2">
                    <i class="fas fa-bug"></i> View Bug Reports
                </a>
                <a href="{{ url_for('management.google_sheets') }}" class="btn btn-info">
                    <i class="fas fa-file-spreadsheet"></i> Manage Google Sheets
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    {# Toast Container for Notifications #}
    <div class="toast-container" id="toastContainer"></div>

    {# Users Table #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Current Users</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Security Level</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% if user.security_level == SecurityLevel.USER %}
                                    <span class="badge bg-secondary">User</span>
                                {% elif user.security_level == SecurityLevel.SUPERVISOR %}
                                    <span class="badge bg-info">Supervisor</span>
                                {% elif user.security_level == SecurityLevel.MANAGER %}
                                    <span class="badge bg-primary">Manager</span>
                                {% elif user.security_level == SecurityLevel.ADMIN %}
                                    <span class="badge bg-danger">Admin</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at|format_date }}</td>
                            <td>
                                {# Add the Edit button with htmx #}
                                <button
                                    hx-get="/management/users/{{ user.id }}/edit"
                                    hx-target="#userEditModal"
                                    hx-trigger="click"
                                    class="btn btn-primary btn-sm me-2"
                                    _="on click add .show to #modalBackdrop">
                                    <i class="fas fa-edit"></i> Edit
                                </button>

                                {% if current_user.can_manage_user(user) %}
                                <button onclick="deleteUser('{{ user.id }}')" class="btn admin-btn-danger btn-sm">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# Simple Modal for User Editing #}
<div id="modalBackdrop" class="modal-backdrop" _="on click if target.id is 'modalBackdrop' remove .show from me"></div>
<div id="userEditModal" class="modal-container"></div>

<script>
document.getElementById('updateLocalStatus').addEventListener('click', function() {
    if (confirm('Are you sure you want to update local statuses for all volunteers? This may take a few moments.')) {
        this.disabled = true;
        this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Updating...';

        fetch('/volunteers/update-local-statuses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating local statuses: ' + error);
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fa-solid fa-location-dot"></i> Update Volunteer Local Statuses';
        });
    }
});
</script>
<script>
function deleteUser(userId) {
    console.log('Delete function called with userId:', userId);
    if (confirm('Are you sure you want to delete this user?')) {
        console.log('Delete confirmed, sending request...');
        fetch(`/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Response received:', response);
            if (response.ok) {
                window.location.reload();
            } else {
                response.json().then(data => {
                    alert(data.error || 'Error deleting user');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
    }
}

function importClasses() {
    if (confirm('Are you sure you want to import classes from Salesforce?')) {
        fetch('/management/import-classes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing classes: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing classes: ${error.message}`);
        });
    }
}

function importSchools() {
    if (confirm('Are you sure you want to import schools from Salesforce?')) {
        fetch('/management/import-schools', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing schools: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing schools: ${error.message}`);
        });
    }
}

function importVolunteers() {
    if (confirm('Are you sure you want to import volunteers from Salesforce?')) {
        fetch('/volunteers/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing volunteers: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing volunteers: ${error.message}`);
        });
    }
}

function importEvents() {
    if (confirm('Are you sure you want to import events from Salesforce?')) {
        fetch('/events/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing events: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing events: ${error.message}`);
        });
    }
}

function importOrganizations() {
    if (confirm('Are you sure you want to import organizations from Salesforce?')) {
        fetch('/organizations/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing organizations: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing organizations: ${error.message}`);
        });
    }
}

function importTeachers() {
    if (confirm('Are you sure you want to import teachers from Salesforce?')) {
        fetch('/teachers/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing teachers: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing teachers: ${error.message}`);
        });
    }
}

// New two-phase student import pipeline functions
function importStudentsPhase1() {
    if (!confirm('Are you sure you want to import students from Salesforce (Phase 1)? This will import all student data without school assignments.')) {
        return;
    }

    const btn = document.getElementById('importStudentsPhase1Btn');
    const status = document.getElementById('importStudentsPhase1Status');
    const progress = document.getElementById('importStudentsPhase1Progress');
    const progressBar = progress.querySelector('.import-progress-bar');

    btn.disabled = true;
    status.textContent = 'Starting Phase 1: Student import (without school assignments)...';
    progress.classList.add('active');
    progressBar.style.width = '0%';

    fetch('/students/import-from-salesforce', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.width = '100%';

        if (data.success) {
            const processedCount = data.statistics.processed_count || 0;
            const totalRecords = data.statistics.total_records || 0;
            const successCount = data.statistics.success_count || 0;
            const errorCount = data.statistics.error_count || 0;

            status.textContent = `Phase 1 complete: ${successCount.toLocaleString()} students imported, ${errorCount.toLocaleString()} errors`;
            showToast('Success', `Phase 1 completed: ${successCount.toLocaleString()} students imported`, 'success');

            if (data.errors && data.errors.length > 0) {
                console.log('Phase 1 errors:', data.errors);
            }

            // Show recommendation for next step
            if (data.next_phase === 'school_assignment') {
                status.innerHTML += '<br><strong>Next step:</strong> Run Phase 2 to assign schools to students.';
            }
        } else {
            throw new Error(data.error || data.message || 'Phase 1 import failed');
        }
    })
    .catch(error => {
        status.textContent = `Phase 1 Error: ${error.message}`;
        showToast('Error', `Failed to import students (Phase 1): ${error.message}`, 'error');
        console.error('Phase 1 import error:', error);
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function testStudentImportLimited() {
    if (!confirm('Are you sure you want to test import students from Salesforce (1000 limit)? This will help debug affiliation issues.')) {
        return;
    }

    const btn = document.getElementById('testStudentImportLimitedBtn');
    const status = document.getElementById('testStudentImportLimitedStatus');
    const progress = document.getElementById('testStudentImportLimitedProgress');
    const progressBar = progress.querySelector('.import-progress-bar');

    btn.disabled = true;
    status.textContent = 'Starting Test Import: Limited student import (1000 students)...';
    progress.classList.add('active');
    progressBar.style.width = '0%';

    fetch('/students/test-import-limited', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.width = '100%';

        if (data.success) {
            const successCount = data.statistics.success_count || 0;
            const errorCount = data.statistics.error_count || 0;
            const affiliationStats = data.statistics.affiliation_stats || {};
            const studentsWithAffiliations = data.statistics.students_with_affiliations || 0;
            const studentsWithoutAffiliations = data.statistics.students_without_affiliations || 0;

            status.textContent = `Test complete: ${successCount} students imported, ${errorCount} errors`;
            status.innerHTML += `<br><strong>Affiliation Stats:</strong> ${affiliationStats.with_affiliation || 0} with affiliations, ${affiliationStats.without_affiliation || 0} without`;
            status.innerHTML += `<br><strong>Imported:</strong> ${studentsWithAffiliations} with affiliations, ${studentsWithoutAffiliations} without`;

            showToast('Success', `Test import completed: ${successCount} students processed`, 'success');

            if (data.errors && data.errors.length > 0) {
                console.log('Test import errors:', data.errors);
            }
        } else {
            throw new Error(data.error || data.message || 'Test import failed');
        }
    })
    .catch(error => {
        status.textContent = `Test Error: ${error.message}`;
        showToast('Error', `Failed to test import students: ${error.message}`, 'error');
        console.error('Test import error:', error);
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function assignSchoolsToStudents() {
    if (!confirm('Are you sure you want to assign schools to students (Phase 2)? This will link students to their schools based on Salesforce data.')) {
        return;
    }

    const btn = document.getElementById('assignSchoolsBtn');
    const status = document.getElementById('assignSchoolsStatus');
    const progress = document.getElementById('assignSchoolsProgress');
    const progressBar = progress.querySelector('.import-progress-bar');

    btn.disabled = true;
    status.textContent = 'Starting Phase 2: Assigning schools to students...';
    progress.classList.add('active');
    progressBar.style.width = '0%';

    fetch('/students/assign-schools', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.width = '100%';

        if (data.success) {
            const totalStudents = data.statistics.total_students || 0;
            const studentsWithSchools = data.statistics.students_with_schools || 0;
            const studentsWithoutSchools = data.statistics.students_without_schools || 0;

            status.textContent = `Phase 2 complete: ${studentsWithSchools.toLocaleString()} students assigned to schools, ${studentsWithoutSchools.toLocaleString()} without schools`;
            showToast('Success', `Phase 2 completed: ${studentsWithSchools.toLocaleString()} students assigned to schools`, 'success');

            if (data.errors && data.errors.length > 0) {
                console.log('Phase 2 errors:', data.errors);
            }
        } else {
            throw new Error(data.error || data.message || 'Phase 2 assignment failed');
        }
    })
    .catch(error => {
        status.textContent = `Phase 2 Error: ${error.message}`;
        showToast('Error', `Failed to assign schools (Phase 2): ${error.message}`, 'error');
        console.error('Phase 2 assignment error:', error);
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function checkStudentPipelineStatus() {
    const btn = document.getElementById('checkPipelineStatusBtn');
    const status = document.getElementById('checkPipelineStatusStatus');

    btn.disabled = true;
    status.textContent = 'Checking pipeline status...';

    fetch('/students/import-pipeline-status', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const totalStudents = data.statistics.total_students || 0;
            const studentsWithSchools = data.statistics.students_with_schools || 0;
            const studentsWithoutSchools = data.statistics.students_without_schools || 0;
            const totalSchools = data.statistics.total_schools || 0;

            let statusText = `Pipeline Status:<br>`;
            statusText += `• Total Students: ${totalStudents.toLocaleString()}<br>`;
            statusText += `• Students with Schools: ${studentsWithSchools.toLocaleString()}<br>`;
            statusText += `• Students without Schools: ${studentsWithoutSchools.toLocaleString()}<br>`;
            statusText += `• Total Schools: ${totalSchools.toLocaleString()}<br>`;

            if (data.recommendations && data.recommendations.length > 0) {
                statusText += `<br><strong>Recommendations:</strong><br>`;
                data.recommendations.forEach(rec => {
                    statusText += `• ${rec}<br>`;
                });
            }

            status.innerHTML = statusText;
            showToast('Success', 'Pipeline status retrieved successfully', 'success');
        } else {
            throw new Error(data.error || data.message || 'Failed to get pipeline status');
        }
    })
    .catch(error => {
        status.textContent = `Status Error: ${error.message}`;
        showToast('Error', `Failed to get pipeline status: ${error.message}`, 'error');
        console.error('Pipeline status error:', error);
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function importHistory() {
    if (confirm('Are you sure you want to import history from Salesforce?')) {
        fetch('/history/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing history: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing history: ${error.message}`);
        });
    }
}

function importAffiliations() {
    if (confirm('Are you sure you want to import volunteer-organization affiliations from Salesforce?')) {
        fetch('/organizations/import-affiliations-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing affiliations: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing affiliations: ${error.message}`);
        });
    }
}

function purgeVolunteers() {
    if (!confirm('WARNING: This will permanently delete ALL volunteer data from the system. This action cannot be undone. Are you sure you want to continue?')) {
        return;
    }

    const btn = document.getElementById('purgeVolunteersBtn');
    const status = document.getElementById('purgeVolunteersStatus');

    btn.disabled = true;
    status.textContent = 'Purging volunteer data...';
    status.className = 'purge-status';

    fetch('/volunteers/purge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = 'Successfully purged all volunteer data';
            status.classList.add('success');
            showToast('Success', 'All volunteer data has been purged from the system', 'success');
        } else {
            throw new Error(data.error || 'Failed to purge volunteer data');
        }
    })
    .catch(error => {
        status.textContent = 'Error: ' + error.message;
        status.classList.add('error');
        showToast('Error', 'Failed to purge volunteer data: ' + error.message, 'error');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function purgeEvents() {
    if (confirm('WARNING: This will permanently delete ALL events and their participations. This action cannot be undone. Are you sure you want to continue?')) {
        document.getElementById('purgeEventsBtn').disabled = true;
        document.getElementById('purgeEventsBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Purging...';

        fetch('/events/purge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('All events have been successfully purged.');
            } else {
                alert('Error purging events: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error purging events: ' + error);
        })
        .finally(() => {
            document.getElementById('purgeEventsBtn').disabled = false;
            document.getElementById('purgeEventsBtn').innerHTML = '<i class="fas fa-trash-alt"></i> Purge All Events';
        });
    }
}

function purgeVirtualSessions() {
    if (!confirm('WARNING: This will permanently delete ALL virtual session data including events, teachers, and related records. This action cannot be undone. Are you sure you want to continue?')) {
        return;
    }

    const btn = document.getElementById('purgeVirtualSessionsBtn');
    const status = document.getElementById('purgeVirtualSessionsStatus');

    btn.disabled = true;
    status.textContent = 'Purging virtual session data...';
    status.className = 'purge-status';

    fetch('/virtual/purge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const details = [
                `${data.count || 0} virtual sessions`,
                `${data.teachers_deleted || 0} orphaned teachers`,
                `${data.event_teachers_deleted || 0} teacher associations`,
                `${data.event_participations_deleted || 0} event participations`
            ].filter(count => count !== '0').join(', ');

            status.textContent = `Successfully purged: ${details}`;
            status.classList.add('success');
            showToast('Success', `Virtual session data has been purged from the system`, 'success');
        } else {
            throw new Error(data.error || 'Failed to purge virtual session data');
        }
    })
    .catch(error => {
        status.textContent = 'Error: ' + error.message;
        status.classList.add('error');
        showToast('Error', 'Failed to purge virtual session data: ' + error.message, 'error');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

async function importAllSequentially() {
    const importAllBtn = document.getElementById('importAllBtn');
    const importAllStatus = document.getElementById('importAllStatus');
    const importAllProgress = document.getElementById('importAllProgress');
    const progressBar = importAllProgress.querySelector('.import-progress-bar');

    // Define the import sequence with routes and button IDs
    const importSequence = [
        { route: '/organizations/import-from-salesforce', name: 'Organizations', btnId: 'importOrganizationsBtn' },
        { route: '/management/import-schools', name: 'Schools', btnId: 'importSchoolsBtn' },
        { route: '/management/import-classes', name: 'Classes', btnId: 'importClassesBtn' },
        { route: '/teachers/import-from-salesforce', name: 'Teachers', btnId: 'importTeachersBtn' },
        { route: '/volunteers/import-from-salesforce', name: 'Volunteers', btnId: 'importVolunteersBtn' },
        { route: '/organizations/import-affiliations-from-salesforce', name: 'Affiliations', btnId: 'importAffiliationsBtn' },
        { route: '/events/import-from-salesforce', name: 'Events', btnId: 'importEventsBtn' },
        { route: '/history/import-from-salesforce', name: 'History', btnId: 'importHistoryBtn' },
        { route: '/pathways/import-from-salesforce', name: 'Pathways', btnId: 'importPathwaysBtn' },
        { route: '/pathways/import-participants-from-salesforce', name: 'Pathway Participants', btnId: 'importPathwayParticipantsBtn' },
        { route: '/events/sync-student-participants', name: 'Student Participations', btnId: 'importStudentParticipantsBtn' }
    ];

    // Disable all import buttons
    importSequence.forEach(item => {
        const btn = document.getElementById(item.btnId);
        if (btn) btn.disabled = true;
    });

    // Disable the main import button
    importAllBtn.disabled = true;
    importAllProgress.classList.add('active');

    let successCount = 0;
    let errorCount = 0;

    for (let i = 0; i < importSequence.length; i++) {
        const item = importSequence[i];
        const progress = ((i) / importSequence.length) * 100;
        progressBar.style.width = `${progress}%`;

        importAllStatus.textContent = `Importing ${item.name}...`;

        try {
            const response = await fetch(item.route, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                successCount++;
                const btn = document.getElementById(item.btnId);
                if (btn) {
                    btn.style.backgroundColor = 'var(--ucla-blue)';
                    btn.style.opacity = '0.7';
                }
            } else {
                errorCount++;
                throw new Error(data.message || data.error || `Failed to import ${item.name}`);
            }
        } catch (error) {
            console.error(`Error importing ${item.name}:`, error);
            errorCount++;
        }
    }

    // Complete the progress bar
    progressBar.style.width = '100%';

    // Update final status
    importAllStatus.textContent = `Import complete: ${successCount} successful, ${errorCount} failed`;

    // Re-enable all buttons
    importSequence.forEach(item => {
        const btn = document.getElementById(item.btnId);
        if (btn) btn.disabled = false;
    });
    importAllBtn.disabled = false;

    // Show completion toast
    showToast(
        errorCount === 0 ? 'Success' : 'Complete with Errors',
        `Import sequence completed: ${successCount} successful, ${errorCount} failed`,
        errorCount === 0 ? 'success' : 'error'
    );
}

// Add this helper function if you don't already have it
function showToast(title, message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <div>
            <strong>${title}</strong>
            <div>${message}</div>
        </div>
    `;

    toastContainer.appendChild(toast);

    // Remove toast after 5 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

function refreshDistrictReport() {
    if (!confirm('Are you sure you want to refresh the district year-end report cache?')) {
        return;
    }

    const btn = document.getElementById('refreshDistrictReportBtn');
    const status = document.getElementById('refreshDistrictReportStatus');

    btn.disabled = true;
    status.textContent = 'Refreshing report cache...';

    // Get current school year
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1; // JavaScript months are 0-based
    const schoolYear = month < 6 ?
        `${(year-1).toString().slice(-2)}${year.toString().slice(-2)}` :
        `${year.toString().slice(-2)}${(year+1).toString().slice(-2)}`;

    fetch(`/reports/district/year-end/refresh?school_year=${schoolYear}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = 'Successfully refreshed report cache';
            showToast('Success', `Report cache has been refreshed for ${schoolYear.slice(0,2)}-${schoolYear.slice(2)} school year`, 'success');
        } else {
            throw new Error(data.error || 'Failed to refresh report cache');
        }
    })
    .catch(error => {
        status.textContent = 'Error: ' + error.message;
        showToast('Error', 'Failed to refresh report cache: ' + error.message, 'error');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function importVirtualEvents() {
    // This function is no longer needed as the button is removed.
    // Keeping it here for now, but it will not be called by the new button.
    // The new button will navigate to the Google Sheets management page.
    alert('Virtual event import functionality is now managed via the "Manage Virtual Event Google Sheets" button.');
}

function importPathways() {
    // Disable the button and show loading state
    const button = document.getElementById('importPathwaysBtn');
    const status = document.getElementById('importPathwaysStatus');
    const progress = document.getElementById('importPathwaysProgress');

    button.disabled = true;
    status.textContent = 'Importing pathways...';
    progress.style.display = 'block';

    // Make the API call
    fetch('/pathways/import-from-salesforce', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = data.message;
            status.style.color = 'green';
        } else {
            status.textContent = data.message || 'Import failed';
            status.style.color = 'red';
        }

        // Show errors if any
        if (data.errors && data.errors.length > 0) {
            console.log('Import errors:', data.errors);
        }
    })
    .catch(error => {
        status.textContent = 'Import failed: ' + error.message;
        status.style.color = 'red';
        console.error('Import error:', error);
    })
    .finally(() => {
        button.disabled = false;
        progress.style.display = 'none';
    });
}

function importPathwayParticipants() {
    // Disable the button and show loading state
    const button = document.getElementById('importPathwayParticipantsBtn');
    const status = document.getElementById('importPathwayParticipantsStatus');
    const progress = document.getElementById('importPathwayParticipantsProgress');

    button.disabled = true;
    status.textContent = 'Importing pathway participants...';
    progress.style.display = 'block';

    // Make the API call
    fetch('/pathways/import-participants-from-salesforce', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = data.message;
            status.style.color = 'green';
        } else {
            status.textContent = data.message || 'Import failed';
            status.style.color = 'red';
        }

        // Show errors if any
        if (data.errors && data.errors.length > 0) {
            console.log('Import errors:', data.errors);
        }
    })
    .catch(error => {
        status.textContent = 'Import failed: ' + error.message;
        status.style.color = 'red';
        console.error('Import error:', error);
    })
    .finally(() => {
        button.disabled = false;
        progress.style.display = 'none';
    });
}

function importStudentParticipants() {
    if (!confirm('Are you sure you want to import student participation data from Salesforce? This will link existing students to events based on Salesforce records.')) {
        return;
    }

    const btn = document.getElementById('importStudentParticipantsBtn');
    const status = document.getElementById('importStudentParticipantsStatus');
    const progress = document.getElementById('importStudentParticipantsProgress'); // If using progress bar visual
    const progressBar = progress.querySelector('.import-progress-bar');

    btn.disabled = true;
    status.textContent = 'Importing student participations...';
    progress.classList.add('active'); // Show progress bar if applicable
    progressBar.style.width = '0%'; // Reset progress

    fetch('/events/sync-student-participants', { // Use the correct route
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.width = '100%'; // Indicate completion
        if (data.success) {
            status.textContent = `Import complete: ${data.successCount} processed, ${data.errorCount} errors.`;
            showToast('Success', data.message || 'Student participation import completed.', 'success');
            if (data.errors && data.errors.length > 0) {
                console.log("Student Participation Import Errors:", data.errors);
                // Optionally display first few errors below status
                let errorSample = data.errors.slice(0, 5).join('\n - ');
                status.innerHTML += `<br/><small class="text-danger">Errors:\n - ${errorSample}${data.errors.length > 5 ? '\n...' : ''}</small>`;
             }
        } else {
            throw new Error(data.message || data.error || 'Unknown error during student participation import.');
        }
    })
    .catch(error => {
        console.error('Import Student Participations Error:', error);
        status.textContent = `Error: ${error.message}`;
        showToast('Error', `Failed to import student participations: ${error.message}`, 'error');
    })
    .finally(() => {
        btn.disabled = false;
        // Optional: Hide progress bar after a delay
        // setTimeout(() => progress.classList.remove('active'), 2000);
    });
}

function syncUnaffiliatedEvents() {
    if (!confirm('Are you sure you want to attempt to affiliate events based on student participants? This will query Salesforce and update local events.')) {
        return;
    }

    const btn = document.getElementById('syncUnaffiliatedEventsBtn');
    const status = document.getElementById('syncUnaffiliatedEventsStatus');
    const progress = document.getElementById('syncUnaffiliatedEventsProgress'); // Assuming you have progress elements
    const progressBar = progress.querySelector('.import-progress-bar');

    btn.disabled = true;
    status.textContent = 'Syncing unaffiliated events...';
    progress.classList.add('active');
    progressBar.style.width = '0%'; // Start progress

    fetch('/pathway-events/sync-unaffiliated-events', { // Use the correct new route
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            // If you use Flask-WTF CSRF protection, uncomment and ensure csrf_token() is available in JS scope
            // 'X-CSRFToken': /* some_js_variable_holding_the_token */
        }
    })
    .then(response => {
        const contentType = response.headers.get("content-type");
        if (response.ok && contentType && contentType.indexOf("application/json") !== -1) {
            // It's likely JSON, proceed to parse
            return response.json();
        } else {
            // Not JSON or not an OK status, read as text and throw an error
            return response.text().then(text => {
                // Check for common HTML signatures or specific messages if needed
                let errorMsg = `Server returned non-JSON response (Status: ${response.status}).`;
                if (text.toLowerCase().includes('<!doctype html') || text.toLowerCase().includes('<html')) {
                   errorMsg += ' This might be a login redirect or an HTML error page.';
                } else {
                   errorMsg += ` Response body: ${text.substring(0, 200)}...`; // Show beginning of text
                }
                // Throw an error object to be caught by .catch()
                throw new Error(errorMsg);
            });
        }
    })
    .then(data => { // This block only runs if response.json() was successful
        progressBar.style.width = '100%'; // Indicate completion
        if (data.success) {
            status.textContent = `Sync complete: ${data.processed_count} processed, ${data.updated_count} updated.`;
            showToast('Success', data.message || 'Unaffiliated events sync completed.', 'success');
            console.log("Unaffiliated Event Sync Details:", data.district_map_details); // Log details
            if (data.errors && data.errors.length > 0) {
                console.log("Unaffiliated Event Sync Errors:", data.errors);
                let errorSample = data.errors.slice(0, 5).join('\n - ');
                status.innerHTML += `<br/><small class="text-danger">Errors:\n - ${errorSample}${data.errors.length > 5 ? '\n...' : ''}</small>`;
             }
        } else {
             // Handle application-level errors reported in the JSON ({'success': false, 'error': '...'})
            throw new Error(data.message || data.error || 'Sync failed according to server response.');
        }
    })
    .catch(error => { // Catches errors from fetch network issues, response parsing, or thrown exceptions
        console.error('Sync Unaffiliated Events Error:', error);
        // Use error.message which now contains more details from the .then block
        const errorMessage = error.message || 'An unexpected error occurred during the sync.';
        status.textContent = `Error: ${errorMessage}`;
        progressBar.style.width = '100%'; // Show completion even on error
        progress.classList.add('error'); // Optional: Style progress bar on error
        showToast('Error', `Failed to sync unaffiliated events: ${errorMessage}`, 'error');
    })
    .finally(() => {
        btn.disabled = false;
        // Optional: Hide progress bar after a delay, remove error styling etc.
        // setTimeout(() => {
        //     progress.classList.remove('active', 'error');
        //     progressBar.style.width = '0%';
        // }, 5000);
    });
}

// Add this to existing scripts
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.matches('.modal-form') && event.detail.xhr.status === 200) {
        const response = JSON.parse(event.detail.xhr.responseText);
        showToast('Success', response.message, 'success');
        setTimeout(() => window.location.reload(), 1000); // Reload after 1 second
    } else if (event.detail.target.matches('.modal-form') && event.detail.xhr.status !== 200) {
        try {
            const response = JSON.parse(event.detail.xhr.responseText);
            showToast('Error', response.error || 'Failed to update user', 'error');
        } catch(e) {
            showToast('Error', 'Failed to update user', 'error');
        }
    }
});
</script>
{% endblock %}
