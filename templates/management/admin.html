{#
  Admin Dashboard Template
  =======================

  This template provides the main administrative interface for the Volunteer Management System.
  It includes user management, password changes, data import functionality, and various
  administrative tools for system management.

  Key Features:
  - User creation and management (admin only)
  - Password change functionality
  - Salesforce data import system
  - Import progress tracking and status display
  - Modal dialogs for user editing
  - Responsive design with Bootstrap
  - Real-time import status updates

  Admin Functions:
  - Create new users with role assignment
  - Change user passwords
  - Import data from Salesforce (organizations, schools, classes)
  - Sequential import with progress tracking
  - User management and editing

  Import System:
  - Sequential import with dependency order
  - Progress bars for each import type
  - Status messages and error handling
  - Import all functionality
  - Individual import options

  Modal Features:
  - User editing modal
  - Custom modal styling
  - Form validation
  - Dynamic content loading

  Template Variables:
  - current_user: Current authenticated user object
  - users: List of system users (for management)
  - import_status: Status of import operationsadd

  Dependencies:
  - Bootstrap 5.3.3 CSS/JS
  - FontAwesome icons
  - Custom admin.css for styling
  - Custom JavaScript for import functionality

  Security Features:
  - Admin-only access controls
  - CSRF protection
  - Form validation
  - User authentication checks

  JavaScript Integration:
  - Import functionality with AJAX
  - Progress tracking
  - Modal management
  - Form submission handling
#}

{% extends "base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    /* Custom Modal Styles */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
    }

    .modal-backdrop.show {
        display: block;
    }

    /* Force modal styles with maximum specificity */
    .modal-container,
    div.modal-container,
    .modal-container.show {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        background: #ffffff !important;
        padding: 20px !important;
        border-radius: 8px !important;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3) !important;
        z-index: 1010 !important;
        max-width: 500px !important;
        width: 90% !important;
        display: none !important;
        border: 2px solid #dee2e6 !important;
    }

    .modal-container.show,
    div.modal-container.show {
        display: block !important;
    }

    .modal-header,
    .modal-container .modal-header,
    div.modal-container .modal-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 15px !important;
        border-bottom: 1px solid #eee !important;
        padding-bottom: 10px !important;
        background: #ffffff !important;
    }

    .modal-close,
    .modal-container .modal-close,
    div.modal-container .modal-close {
        background: none !important;
        border: none !important;
        font-size: 20px !important;
        cursor: pointer !important;
        color: #000 !important;
    }

    .modal-form,
    .modal-container .modal-form,
    div.modal-container .modal-form {
        display: flex !important;
        flex-direction: column !important;
        gap: 15px !important;
    }

    .form-group,
    .modal-container .form-group,
    div.modal-container .form-group {
        display: flex !important;
        flex-direction: column !important;
        gap: 5px !important;
    }

    .form-group label,
    .modal-container .form-group label,
    div.modal-container .form-group label {
        font-weight: bold !important;
    }

    .modal-footer,
    .modal-container .modal-footer,
    div.modal-container .modal-footer {
        display: flex !important;
        justify-content: flex-end !important;
        gap: 10px !important;
        margin-top: 20px !important;
        border-top: 1px solid #eee !important;
        padding-top: 15px !important;
        background: #ffffff !important;
    }

    .modal-body,
    .modal-container .modal-body,
    div.modal-container .modal-body {
        background: #ffffff !important;
        padding: 15px 0 !important;
        border-radius: 4px !important;
    }

    .modal-body > div,
    .modal-container .modal-body > div,
    div.modal-container .modal-body > div {
        background: #ffffff !important;
        padding: 10px !important;
        border-radius: 4px !important;
    }

    /* Override any conflicting styles from other CSS files */
    .modal-container *,
    div.modal-container * {
        background-color: transparent !important;
    }

    .modal-container .modal-header *,
    .modal-container .modal-footer *,
    .modal-container .modal-body *,
    div.modal-container .modal-header *,
    div.modal-container .modal-footer *,
    div.modal-container .modal-body * {
        background-color: transparent !important;
    }


    /* Import Section Styling */
    .import-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .import-section h6 {
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid;
    }

    .import-section h6.text-primary {
        border-bottom-color: #007bff;
    }

    .import-section h6.text-warning {
        border-bottom-color: #ffc107;
    }

    .import-section h6.text-success {
        border-bottom-color: #28a745;
    }

    .import-section h6.text-info {
        border-bottom-color: #17a2b8;
    }

    .import-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .import-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .import-item .btn {
        justify-content: flex-start;
        text-align: left;
        padding: 12px 16px;
        height: auto;
        min-height: 50px;
    }

    .import-item .btn span {
        margin-left: 8px;
        font-weight: 500;
    }

    /* Dependency Styling */
    .import-dependency {
        margin-top: 4px;
        padding: 4px 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        border-left: 3px solid #6c757d;
    }

    .import-dependency small {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .import-dependency i {
        margin-right: 4px;
        color: #007bff;
    }

    /* Volunteer Management Styling */
    .volunteer-management-content {
        padding: 10px 0;
    }

    .action-buttons {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }

    .feature-description {
        flex: 1;
        min-width: 300px;
    }

    .description-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .description-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .description-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #17a2b8;
        color: #495057;
        font-size: 1.1rem;
    }

    .description-content {
        color: #6c757d;
    }

    .feature-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .feature-list li {
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        font-size: 0.95rem;
    }

    .feature-list li:last-child {
        border-bottom: none;
    }

    .feature-list li i {
        font-size: 0.9rem;
        width: 20px;
        text-align: center;
    }

    /* Compact Features Styling */
    .compact-features {
        flex: 1;
        display: flex;
        align-items: center;
    }

    .compact-features small {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
    }

    .compact-features i {
        font-size: 0.8rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .volunteer-management-content .d-flex {
            flex-direction: column;
            align-items: stretch;
        }

        .action-buttons {
            justify-content: center;
            margin-bottom: 20px;
        }

        .feature-description {
            min-width: auto;
        }

        .compact-features {
            margin-top: 10px;
            justify-content: center;
        }
    }

</style>
{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1>Admin Dashboard</h1>

    {% if current_user.is_admin %}
    {# User Creation Form - Admin only #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Create New User</h5>
            <form id="createUserForm" method="POST" action="{{ url_for('auth.create_user') }}">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <input type="text" name="username" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="col-auto">
                        <input type="email" name="email" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="col-auto">
                        <input type="password" name="password" class="form-control" placeholder="Password" required>
                    </div>
                    <div class="col-auto">
                        <select name="security_level" class="form-select" required>
                            <option value="" disabled selected>Select Role</option>
                            <option value="0">User</option>
                            <option value="1">Supervisor</option>
                            <option value="2">Manager</option>
                            <option value="3">Admin</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {# Password Change Form #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Change Password</h5>
            <form id="changePasswordForm" method="POST" action="{{ url_for('auth.change_password') }}">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <input type="password" name="new_password" class="form-control" placeholder="New Password" required>
                    </div>
                    <div class="col-auto">
                        <input type="password" name="confirm_password" class="form-control" placeholder="Confirm New Password" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% if current_user.is_admin %}
    {# Import Section - Admin only #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title mb-0">Import Data from Salesforce</h5>
            <p class="text-muted mb-3">Select data to import from Salesforce into the system. Imports are organized by frequency.</p>



            {# Daily/Weekly Imports #}
            <div class="import-section mb-4">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-calendar-day"></i> Daily/Weekly Imports
                </h6>
                <div class="import-grid">
                    {# Organizations import #}
                    <div class="import-item">
                        <button onclick="importOrganizations()" class="btn admin-btn-import" id="importOrganizationsBtn">
                            <i class="fas fa-building"></i>
                            <span>Import Organizations</span>
                        </button>
                        <div class="import-status" id="importOrganizationsStatus"></div>
                        <div class="import-progress" id="importOrganizationsProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>

                    {# Volunteers import #}
                    <div class="import-item">
                        <button onclick="importVolunteers()" class="btn admin-btn-import" id="importVolunteersBtn">
                            <i class="fas fa-users"></i>
                            <span>Import Volunteers</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Organizations
                            </small>
                        </div>
                        <div class="import-status" id="importVolunteersStatus"></div>
                        <div class="import-progress" id="importVolunteersProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>

                    {# Volunteer-Organization Affiliations import #}
                    <div class="import-item">
                        <button onclick="importAffiliations()" class="btn admin-btn-import" id="importAffiliationsBtn">
                            <i class="fas fa-link"></i>
                            <span>Import Affiliations</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Organizations, Volunteers
                            </small>
                        </div>
                        <div class="import-status" id="importAffiliationsStatus"></div>
                        <div class="import-progress" id="importAffiliationsProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>

                    {# Events import #}
                    <div class="import-item">
                        <button onclick="importEvents()" class="btn admin-btn-import" id="importEventsBtn">
                            <i class="fas fa-calendar"></i>
                            <span>Import Events</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Organizations, Schools, Teachers
                            </small>
                        </div>
                        <div class="import-status" id="importEventsStatus"></div>
                        <div class="import-progress" id="importEventsProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>

                    {# History import #}
                    <div class="import-item">
                        <button onclick="importHistory()" class="btn admin-btn-import" id="importHistoryBtn">
                            <i class="fas fa-history"></i>
                            <span>Import History</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Events, Volunteers, Students
                            </small>
                        </div>
                        <div class="import-status" id="importHistoryStatus"></div>
                        <div class="import-progress" id="importHistoryProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>

                    {# Virtual Events Google Sheets Management #}
                    <div class="import-item">
                        <a href="{{ url_for('management.google_sheets') }}" class="btn admin-btn-import" id="manageGoogleSheetsBtn" style="display: flex; align-items: center;">
                            <i class="fas fa-file-spreadsheet"></i>
                            <span>Manage Virtual Event Google Sheets</span>
                        </a>
                        <div class="import-status" id="importVirtualStatus"></div>
                    </div>
                </div>
            </div>

            {# Quarterly Imports #}
            <div class="import-section mb-4">
                <h6 class="text-warning mb-3">
                    <i class="fas fa-calendar-week"></i> Quarterly Imports
                </h6>
                <div class="import-grid">
                    {# Schools import #}
                    <div class="import-item">
                        <button onclick="importSchools()" class="btn admin-btn-import" id="importSchoolsBtn">
                            <i class="fas fa-school"></i>
                            <span>Import Schools</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Districts (auto-imported)
                            </small>
                        </div>
                        <div class="import-status" id="importSchoolsStatus"></div>
                        <div class="import-progress" id="importSchoolsProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>

                    {# Classes import #}
                    <div class="import-item">
                        <button onclick="importClasses()" class="btn admin-btn-import" id="importClassesBtn">
                            <i class="fas fa-file-import"></i>
                            <span>Import Classes</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Schools
                            </small>
                        </div>
                        <div class="import-status" id="importClassesStatus"></div>
                        <div class="import-progress" id="importClassesProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>

                    {# Teachers import #}
                    <div class="import-item">
                        <button onclick="importTeachers()" class="btn admin-btn-import" id="importTeachersBtn">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Import Teachers</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Schools
                            </small>
                        </div>
                        <div class="import-status" id="importTeachersStatus"></div>
                        <div class="import-progress" id="importTeachersProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>

                    {# Student Participations import #}
                    <div class="import-item">
                        <button onclick="importStudentParticipants()" class="btn admin-btn-import" id="importStudentParticipantsBtn">
                            <i class="fas fa-user-check"></i>
                            <span>Import Student Participations</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Students, Events
                            </small>
                        </div>
                        <div class="import-status" id="importStudentParticipantsStatus"></div>
                        <div class="import-progress" id="importStudentParticipantsProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>

                    {# Sync Unaffiliated Events #}
                    <div class="import-item">
                        <button onclick="syncUnaffiliatedEvents()" class="btn admin-btn-import" id="syncUnaffiliatedEventsBtn">
                            <i class="fas fa-sitemap"></i>
                            <span>Sync Unaffiliated Events (by Students)</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Students, Events
                            </small>
                        </div>
                        <div class="import-status" id="syncUnaffiliatedEventsStatus"></div>
                        <div class="import-progress" id="syncUnaffiliatedEventsProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>
                </div>
            </div>

            {# Yearly Imports #}
            <div class="import-section mb-4">
                <h6 class="text-success mb-3">
                    <i class="fas fa-calendar-alt"></i> Yearly Imports
                </h6>
                <div class="import-grid">
                    {# Students import #}
                    <div class="import-item">
                        <button onclick="importStudents()" class="btn admin-btn-import" id="importStudentsBtn">
                            <i class="fas fa-user-graduate"></i>
                            <span>Import Students</span>
                        </button>
                        <div class="import-dependency">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Requires: Schools, Classes, Teachers
                            </small>
                        </div>
                        <div class="import-status" id="importStudentsStatus"></div>
                        <div class="import-progress" id="importStudentsProgress">
                            <div class="import-progress-bar"></div>
                        </div>
                    </div>
                </div>
            </div>

            {# Management Functions #}
            <div class="import-section">
                <h6 class="text-info mb-3">
                    <i class="fas fa-tools"></i> Management Functions
                </h6>
                <div class="import-grid">
                    {# Teachers Management #}
                    <div class="import-item">
                        <a href="{{ url_for('teachers.list_teachers') }}" class="btn admin-btn-import" id="manageTeachersBtn" style="display: flex; align-items: center;">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Manage Teachers</span>
                        </a>
                        <div class="import-status" id="manageTeachersStatus"></div>
                    </div>

                    {# Students Management #}
                    <div class="import-item">
                        <a href="{{ url_for('students.view_students') }}" class="btn admin-btn-import" id="manageStudentsBtn" style="display: flex; align-items: center;">
                            <i class="fas fa-user-graduate"></i>
                            <span>Manage Students</span>
                        </a>
                        <div class="import-status" id="manageStudentsStatus"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Volunteer Management Section #}
    <div class="card admin-card mt-4">
        <div class="card-header bg-primary text-white py-2">
            <h6 class="mb-0">
                <i class="fas fa-users me-2"></i>Volunteer Management
            </h6>
        </div>
        <div class="card-body py-3">
            <div class="d-flex align-items-center gap-3">
                <button id="updateLocalStatus" class="btn btn-primary">
                    <i class="fa-solid fa-location-dot me-2"></i>
                    Update Local Statuses (All Contacts)
                </button>
                <button id="localStatusInfo" class="btn btn-outline-info btn-sm" title="Click for local status matching details">
                    <i class="fas fa-info"></i>
                </button>
                <div class="compact-features">
                    <small class="text-muted">
                        <i class="fas fa-check text-success me-1"></i>Multi-source detection
                        <i class="fas fa-check text-success me-1 ms-2"></i>Event participation
                        <i class="fas fa-check text-success me-1 ms-2"></i>Zip code analysis
                        <i class="fas fa-check text-success me-1 ms-2"></i>Smart assumptions
                    </small>
                </div>
            </div>
        </div>
    </div>

    {# Purge Data Section #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title text-danger mb-0">Purge Data</h5>
            <p class="text-muted mb-3">Warning: These actions will permanently delete data from the system. This cannot be undone.</p>
            <div class="purge-grid">
                <div class="purge-item">
                    <button onclick="purgeVolunteers()" class="btn admin-btn-danger" id="purgeVolunteersBtn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Purge All Volunteer Data</span>
                    </button>
                    <div class="purge-status" id="purgeVolunteersStatus"></div>
                </div>
                <div class="purge-item">
                    <button onclick="purgeEvents()" class="btn admin-btn-danger" id="purgeEventsBtn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Purge All Events</span>
                    </button>
                    <div class="purge-status" id="purgeEventsStatus"></div>
                </div>
                <div class="purge-item">
                    <button onclick="purgeVirtualSessions()" class="btn admin-btn-danger" id="purgeVirtualSessionsBtn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Purge Virtual Sessions</span>
                    </button>
                    <div class="purge-status" id="purgeVirtualSessionsStatus"></div>
                </div>
            </div>
        </div>
    </div>

    {# Report Cache Management #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Report Cache Management</h5>
            <div class="d-grid gap-2 d-md-flex">
            <button onclick="refreshDistrictReport()" class="btn admin-btn-import me-2" id="refreshDistrictReportBtn">
                <i class="fas fa-sync"></i>
                <span>Refresh District Year-End Report Cache</span>
            </button>
            <button onclick="refreshAllCaches('all')" class="btn btn-warning" id="refreshAllCachesBtn">
                <i class="fas fa-broom"></i>
                <span>Refresh All Caches</span>
            </button>
            </div>
            <div class="import-status" id="refreshDistrictReportStatus"></div>
            <div class="import-status" id="refreshAllCachesStatus"></div>
        </div>
    </div>

    {# Student Participation Integrity #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Student Participation Integrity</h5>
            <p class="text-muted mb-3">Scan for duplicate (event_id, student_id) pairs and deduplicate safely.</p>
            <div class="d-grid gap-2 d-md-flex">
                <a href="{{ url_for('management.scan_student_participation_duplicates') }}" target="_blank" class="btn btn-outline-primary me-2">
                    <i class="fas fa-search"></i>
                    <span>View Duplicate Pairs (opens in new tab)</span>
                </a>
                <button onclick="dedupeStudentParticipations()" class="btn btn-danger" id="dedupeParticipationsBtn">
                    <i class="fas fa-compress-arrows-alt"></i>
                    <span>Deduplicate Student Participations</span>
                </button>
            </div>
            <div class="import-status" id="dedupeStudentParticipationsStatus"></div>
        </div>
    </div>

    {# System Management #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">System Management</h5>
            <div class="d-grid gap-2 d-md-block">
                <a href="{{ url_for('management.bug_reports') }}" class="btn btn-primary me-2">
                    <i class="fas fa-bug"></i> View Bug Reports
                </a>
                <a href="{{ url_for('management.google_sheets') }}" class="btn btn-info">
                    <i class="fas fa-file-spreadsheet"></i> Manage Google Sheets
                </a>
                {% if current_user.is_admin %}
                <a href="{{ url_for('management.audit_logs') }}" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-clipboard-list"></i> View Audit Logs
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    {# Toast Container for Notifications #}
    <div class="toast-container" id="toastContainer"></div>

    {# Users Table #}
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Current Users</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Security Level</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% if user.security_level == SecurityLevel.USER %}
                                    <span class="badge bg-secondary">User</span>
                                {% elif user.security_level == SecurityLevel.SUPERVISOR %}
                                    <span class="badge bg-info">Supervisor</span>
                                {% elif user.security_level == SecurityLevel.MANAGER %}
                                    <span class="badge bg-primary">Manager</span>
                                {% elif user.security_level == SecurityLevel.ADMIN %}
                                    <span class="badge bg-danger">Admin</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at|format_date }}</td>
                            <td>
                                {# Add the Edit button with htmx #}
                                <button
                                    hx-get="/management/users/{{ user.id }}/edit"
                                    hx-target="#userEditModal"
                                    hx-trigger="click"
                                    class="btn btn-primary btn-sm me-2"
                                    _="on click add .show to #modalBackdrop">
                                    <i class="fas fa-edit"></i> Edit
                                </button>

                                {% if current_user.can_manage_user(user) %}
                                <button onclick="deleteUser('{{ user.id }}')" class="btn admin-btn-danger btn-sm">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# Simple Modal for User Editing #}
<div id="modalBackdrop" class="modal-backdrop" _="on click if target.id is 'modalBackdrop' remove .show from me"></div>
<div id="userEditModal" class="modal-container"></div>

<script>
document.getElementById('updateLocalStatus').addEventListener('click', function() {
    if (confirm('Are you sure you want to update local statuses for all volunteers? This may take a few moments.')) {
        this.disabled = true;
        this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Updating...';

        fetch('/volunteers/update-local-statuses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating local statuses: ' + error);
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fa-solid fa-location-dot"></i> Update Local Statuses (All Contacts)';
        });
    }
});

// Local Status Info Button
document.getElementById('localStatusInfo').addEventListener('click', function() {
    const infoContent = `
🔍 <strong>Local Status Matching Logic</strong>

The system uses a multi-source approach to determine local status with the following priority:

<strong>1. In-Person Event Participation (Highest Priority)</strong>
• If a volunteer attended any in-person event, they're marked as LOCAL
• This is the strongest indicator of local status

<strong>2. Address-Based Calculation (Zip Code Analysis)</strong>
• LOCAL: KC Metro area (640, 641, 660, 661, 664, 665, 666)
• PARTIAL: Regional driving distance (644, 645, 646, 670, 671, 672, 673, 674)
• NON_LOCAL: Outside service area
• UNKNOWN: No valid zip code

<strong>3. Virtual Event Hints</strong>
• Uses presenter location data from virtual event imports
• Helps identify local vs. remote presenters

<strong>4. Assumptions for Educational Contacts</strong>
• Teachers: Assumed LOCAL (work in KC area schools)
• Students: Assumed LOCAL (attend KC area schools)
• These can be overridden by address data if available

<strong>5. Historical Preservation</strong>
• Maintains previously calculated status if no new data available
• Prevents unnecessary status changes

<strong>Status Definitions:</strong>
• LOCAL: Within KC Metro area
• PARTIAL: Within driving distance
• NON_LOCAL: Outside service area
• UNKNOWN: No geographic data available

This enhanced logic provides more accurate local status detection while preserving existing data.
    `;

    // Create modal with inline styles to ensure opacity
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;

    modal.innerHTML = `
        <div style="
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        ">
            <div style="
                background: white;
                padding: 20px;
                border-bottom: 1px solid #dee2e6;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <h5 style="margin: 0; color: #333;">
                    <i class="fas fa-info-circle text-info"></i> Local Status Matching Details
                </h5>
                <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()"
                        style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #666;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">&times;</button>
            </div>
            <div style="
                background: white;
                padding: 20px;
                max-height: 60vh;
                overflow-y: auto;
            ">
                <div style="
                    white-space: pre-line;
                    line-height: 1.6;
                    color: #333;
                    background: white;
                ">${infoContent}</div>
            </div>
            <div style="
                background: white;
                padding: 20px;
                border-top: 1px solid #dee2e6;
                display: flex;
                justify-content: flex-end;
            ">
                <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()"
                        class="btn btn-secondary">Close</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Close modal when clicking backdrop
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
});
</script>
<script>
function deleteUser(userId) {
    console.log('Delete function called with userId:', userId);
    if (confirm('Are you sure you want to delete this user?')) {
        console.log('Delete confirmed, sending request...');
        fetch(`/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Response received:', response);
            if (response.ok) {
                window.location.reload();
            } else {
                response.json().then(data => {
                    alert(data.error || 'Error deleting user');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
    }
}

function importClasses() {
    if (confirm('Are you sure you want to import classes from Salesforce?')) {
        fetch('/management/import-classes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing classes: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing classes: ${error.message}`);
        });
    }
}

function importSchools() {
    if (confirm('Are you sure you want to import schools from Salesforce?')) {
        fetch('/management/import-schools', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing schools: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing schools: ${error.message}`);
        });
    }
}

function importVolunteers() {
    if (confirm('Are you sure you want to import volunteers from Salesforce?')) {
        fetch('/volunteers/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing volunteers: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing volunteers: ${error.message}`);
        });
    }
}

function importEvents() {
    if (confirm('Are you sure you want to import events from Salesforce?')) {
        fetch('/events/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing events: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing events: ${error.message}`);
        });
    }
}

function importOrganizations() {
    if (confirm('Are you sure you want to import organizations from Salesforce?')) {
        fetch('/organizations/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing organizations: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing organizations: ${error.message}`);
        });
    }
}

function importTeachers() {
    if (confirm('Are you sure you want to import teachers from Salesforce?')) {
        fetch('/teachers/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing teachers: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing teachers: ${error.message}`);
        });
    }
}

function importStudents() {
    if (!confirm('Are you sure you want to import students from Salesforce? This may take several minutes.')) {
        return;
    }

    const btn = document.getElementById('importStudentsBtn');
    const status = document.getElementById('importStudentsStatus');
    const progress = document.getElementById('importStudentsProgress');
    const progressBar = progress.querySelector('.import-progress-bar');

    btn.disabled = true;
    status.textContent = 'Starting student import...';
    progress.classList.add('active');
    progressBar.style.width = '0%';

    let totalRecords = 0;
    let processedCount = 0;
    const chunkSize = 5000; // Reduced to 5000 to stay within Salesforce limits

    async function processChunk(lastId = null) {
        try {
            const response = await fetch('/students/import-from-salesforce', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chunk_size: chunkSize,
                    last_id: lastId
                })
            });

            const data = await response.json();

            if (data.status === 'error') {
                throw new Error(data.message);
            }

            // Update progress
            totalRecords = data.total_records;
            processedCount += data.processed_count;
            const progressPercent = (processedCount / totalRecords) * 100;
            progressBar.style.width = `${progressPercent}%`;

            // Update status
            status.textContent = `Processed ${processedCount.toLocaleString()} of ${totalRecords.toLocaleString()} records`;

            // If there are errors, log them to console
            if (data.errors && data.errors.length > 0) {
                console.log('Import errors:', data.errors);
            }

            // If not complete, process next chunk
            if (!data.is_complete && data.next_id) {
                await processChunk(data.next_id);
            } else {
                // Import complete
                status.textContent = `Import complete: Processed ${processedCount.toLocaleString()} records`;
                showToast('Success', `Student import completed successfully`, 'success');
                btn.disabled = false;
            }

        } catch (error) {
            status.textContent = `Error: ${error.message}`;
            showToast('Error', `Failed to import students: ${error.message}`, 'error');
            btn.disabled = false;
            console.error('Import error:', error);
        }
    }

    // Start processing with first chunk
    processChunk().catch(error => {
        status.textContent = `Fatal error: ${error.message}`;
        showToast('Error', `Failed to import students: ${error.message}`, 'error');
        btn.disabled = false;
        console.error('Import error:', error);
    });
}

function importHistory() {
    if (confirm('Are you sure you want to import history from Salesforce?')) {
        fetch('/history/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing history: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing history: ${error.message}`);
        });
    }
}

function importAffiliations() {
    if (confirm('Are you sure you want to import volunteer-organization affiliations from Salesforce?')) {
        fetch('/organizations/import-affiliations-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing affiliations: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing affiliations: ${error.message}`);
        });
    }
}

function purgeVolunteers() {
    if (!confirm('WARNING: This will permanently delete ALL volunteer data from the system. This action cannot be undone. Are you sure you want to continue?')) {
        return;
    }

    const btn = document.getElementById('purgeVolunteersBtn');
    const status = document.getElementById('purgeVolunteersStatus');

    btn.disabled = true;
    status.textContent = 'Purging volunteer data...';
    status.className = 'purge-status';

    fetch('/volunteers/purge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = 'Successfully purged all volunteer data';
            status.classList.add('success');
            showToast('Success', 'All volunteer data has been purged from the system', 'success');
        } else {
            throw new Error(data.error || 'Failed to purge volunteer data');
        }
    })
    .catch(error => {
        status.textContent = 'Error: ' + error.message;
        status.classList.add('error');
        showToast('Error', 'Failed to purge volunteer data: ' + error.message, 'error');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function purgeEvents() {
    if (confirm('WARNING: This will permanently delete ALL events and their participations. This action cannot be undone. Are you sure you want to continue?')) {
        document.getElementById('purgeEventsBtn').disabled = true;
        document.getElementById('purgeEventsBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Purging...';

        fetch('/events/purge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('All events have been successfully purged.');
            } else {
                alert('Error purging events: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error purging events: ' + error);
        })
        .finally(() => {
            document.getElementById('purgeEventsBtn').disabled = false;
            document.getElementById('purgeEventsBtn').innerHTML = '<i class="fas fa-trash-alt"></i> Purge All Events';
        });
    }
}

function purgeVirtualSessions() {
    if (!confirm('WARNING: This will permanently delete ALL virtual session data including events, teachers, and related records. This action cannot be undone. Are you sure you want to continue?')) {
        return;
    }

    const btn = document.getElementById('purgeVirtualSessionsBtn');
    const status = document.getElementById('purgeVirtualSessionsStatus');

    btn.disabled = true;
    status.textContent = 'Purging virtual session data...';
    status.className = 'purge-status';

    fetch('/virtual/purge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const details = [
                `${data.count || 0} virtual sessions`,
                `${data.teachers_deleted || 0} orphaned teachers`,
                `${data.event_teachers_deleted || 0} teacher associations`,
                `${data.event_participations_deleted || 0} event participations`
            ].filter(count => count !== '0').join(', ');

            status.textContent = `Successfully purged: ${details}`;
            status.classList.add('success');
            showToast('Success', `Virtual session data has been purged from the system`, 'success');
        } else {
            throw new Error(data.error || 'Failed to purge virtual session data');
        }
    })
    .catch(error => {
        status.textContent = 'Error: ' + error.message;
        status.classList.add('error');
        showToast('Error', 'Failed to purge virtual session data: ' + error.message, 'error');
    })
    .finally(() => {
        btn.disabled = false;
    });
}



// Add this helper function if you don't already have it
function showToast(title, message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <div>
            <strong>${title}</strong>
            <div>${message}</div>
        </div>
    `;

    toastContainer.appendChild(toast);

    // Remove toast after 5 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

function refreshDistrictReport() {
    if (!confirm('Are you sure you want to refresh the district year-end report cache?')) {
        return;
    }

    const btn = document.getElementById('refreshDistrictReportBtn');
    const status = document.getElementById('refreshDistrictReportStatus');

    btn.disabled = true;
    status.textContent = 'Refreshing report cache...';

    // Get current school year
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1; // JavaScript months are 0-based
    const schoolYear = month < 6 ?
        `${(year-1).toString().slice(-2)}${year.toString().slice(-2)}` :
        `${year.toString().slice(-2)}${(year+1).toString().slice(-2)}`;

    fetch(`/reports/district/year-end/refresh?school_year=${schoolYear}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = 'Successfully refreshed report cache';
            showToast('Success', `Report cache has been refreshed for ${schoolYear.slice(0,2)}-${schoolYear.slice(2)} school year`, 'success');
        } else {
            throw new Error(data.error || 'Failed to refresh report cache');
        }
    })
    .catch(error => {
        status.textContent = 'Error: ' + error.message;
        showToast('Error', 'Failed to refresh report cache: ' + error.message, 'error');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

async function refreshAllCaches(scope = 'all') {
    if (!confirm('Refresh caches? This will clear cached report data.')) {
        return;
    }
    const btn = document.getElementById('refreshAllCachesBtn');
    const status = document.getElementById('refreshAllCachesStatus');
    btn.disabled = true;
    status.textContent = 'Refreshing caches...';

    try {
        const response = await fetch(`/management/refresh-all-caches?scope=${encodeURIComponent(scope)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.success) {
            status.textContent = 'All caches refreshed';
            showToast('Success', 'All caches refreshed', 'success');
            console.log('Refresh result:', data.result);
        } else {
            throw new Error(data.error || 'Failed to refresh caches');
        }
    } catch (error) {
        status.textContent = 'Error: ' + error.message;
        showToast('Error', 'Failed to refresh caches: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
    }
}

function importVirtualEvents() {
    // This function is no longer needed as the button is removed.
    // Keeping it here for now, but it will not be called by the new button.
    // The new button will navigate to the Google Sheets management page.
    alert('Virtual event import functionality is now managed via the "Manage Virtual Event Google Sheets" button.');
}

async function dedupeStudentParticipations() {
    if (!confirm('Deduplicate student participations by merging duplicates and deleting extras? This cannot be undone.')) {
        return;
    }

    const btn = document.getElementById('dedupeParticipationsBtn');
    const status = document.getElementById('dedupeStudentParticipationsStatus');
    btn.disabled = true;
    status.textContent = 'Running dedupe...';

    try {
        const res = await fetch('/admin/dedupe-student-participations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        });
        const data = await res.json();
        if (res.ok && data && data.success) {
            const s = data.summary || {};
            const msg = `Pairs processed: ${s.pairs || 0}, updated: ${s.updated || 0}, deleted: ${s.deleted || 0}`;
            status.textContent = msg;
            status.classList.add('success');
            showToast('Success', msg, 'success');
        } else {
            const err = (data && (data.error || JSON.stringify(data))) || 'Unknown error';
            status.textContent = 'Error: ' + err;
            status.classList.add('error');
            showToast('Error', 'Dedupe failed: ' + err, 'error');
        }
    } catch (e) {
        status.textContent = 'Error: ' + (e && e.message ? e.message : e);
        status.classList.add('error');
        showToast('Error', 'Dedupe failed: ' + (e && e.message ? e.message : e), 'error');
    } finally {
        btn.disabled = false;
    }
}



function importStudentParticipants() {
    if (!confirm('Are you sure you want to import student participation data from Salesforce? This will link existing students to events based on Salesforce records.')) {
        return;
    }

    const btn = document.getElementById('importStudentParticipantsBtn');
    const status = document.getElementById('importStudentParticipantsStatus');
    const progress = document.getElementById('importStudentParticipantsProgress'); // If using progress bar visual
    const progressBar = progress.querySelector('.import-progress-bar');

    btn.disabled = true;
    status.textContent = 'Importing student participations...';
    progress.classList.add('active'); // Show progress bar if applicable
    progressBar.style.width = '0%'; // Reset progress

    fetch('/events/sync-student-participants', { // Use the correct route
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.width = '100%'; // Indicate completion
        if (data.success) {
            status.textContent = `Import complete: ${data.successCount} processed, ${data.errorCount} errors.`;
            showToast('Success', data.message || 'Student participation import completed.', 'success');
            if (data.errors && data.errors.length > 0) {
                console.log("Student Participation Import Errors:", data.errors);
                // Optionally display first few errors below status
                let errorSample = data.errors.slice(0, 5).join('\n - ');
                status.innerHTML += `<br/><small class="text-danger">Errors:\n - ${errorSample}${data.errors.length > 5 ? '\n...' : ''}</small>`;
             }
        } else {
            throw new Error(data.message || data.error || 'Unknown error during student participation import.');
        }
    })
    .catch(error => {
        console.error('Import Student Participations Error:', error);
        status.textContent = `Error: ${error.message}`;
        showToast('Error', `Failed to import student participations: ${error.message}`, 'error');
    })
    .finally(() => {
        btn.disabled = false;
        // Optional: Hide progress bar after a delay
        // setTimeout(() => progress.classList.remove('active'), 2000);
    });
}

function syncUnaffiliatedEvents() {
    if (!confirm('Are you sure you want to attempt to affiliate events based on student participants? This will query Salesforce and update local events.')) {
        return;
    }

    const btn = document.getElementById('syncUnaffiliatedEventsBtn');
    const status = document.getElementById('syncUnaffiliatedEventsStatus');
    const progress = document.getElementById('syncUnaffiliatedEventsProgress'); // Assuming you have progress elements
    const progressBar = progress.querySelector('.import-progress-bar');

    btn.disabled = true;
    status.textContent = 'Syncing unaffiliated events...';
    progress.classList.add('active');
    progressBar.style.width = '0%'; // Start progress

    fetch('/pathway-events/sync-unaffiliated-events', { // Use the correct new route
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            // If you use Flask-WTF CSRF protection, uncomment and ensure csrf_token() is available in JS scope
            // 'X-CSRFToken': /* some_js_variable_holding_the_token */
        }
    })
    .then(response => {
        const contentType = response.headers.get("content-type");
        if (response.ok && contentType && contentType.indexOf("application/json") !== -1) {
            // It's likely JSON, proceed to parse
            return response.json();
        } else {
            // Not JSON or not an OK status, read as text and throw an error
            return response.text().then(text => {
                // Check for common HTML signatures or specific messages if needed
                let errorMsg = `Server returned non-JSON response (Status: ${response.status}).`;
                if (text.toLowerCase().includes('<!doctype html') || text.toLowerCase().includes('<html')) {
                   errorMsg += ' This might be a login redirect or an HTML error page.';
                } else {
                   errorMsg += ` Response body: ${text.substring(0, 200)}...`; // Show beginning of text
                }
                // Throw an error object to be caught by .catch()
                throw new Error(errorMsg);
            });
        }
    })
    .then(data => { // This block only runs if response.json() was successful
        progressBar.style.width = '100%'; // Indicate completion
        if (data.success) {
            status.textContent = `Sync complete: ${data.processed_count} processed, ${data.updated_count} updated.`;
            showToast('Success', data.message || 'Unaffiliated events sync completed.', 'success');
            console.log("Unaffiliated Event Sync Details:", data.district_map_details); // Log details
            if (data.errors && data.errors.length > 0) {
                console.log("Unaffiliated Event Sync Errors:", data.errors);
                let errorSample = data.errors.slice(0, 5).join('\n - ');
                status.innerHTML += `<br/><small class="text-danger">Errors:\n - ${errorSample}${data.errors.length > 5 ? '\n...' : ''}</small>`;
             }
        } else {
             // Handle application-level errors reported in the JSON ({'success': false, 'error': '...'})
            throw new Error(data.message || data.error || 'Sync failed according to server response.');
        }
    })
    .catch(error => { // Catches errors from fetch network issues, response parsing, or thrown exceptions
        console.error('Sync Unaffiliated Events Error:', error);
        // Use error.message which now contains more details from the .then block
        const errorMessage = error.message || 'An unexpected error occurred during the sync.';
        status.textContent = `Error: ${errorMessage}`;
        progressBar.style.width = '100%'; // Show completion even on error
        progress.classList.add('error'); // Optional: Style progress bar on error
        showToast('Error', `Failed to sync unaffiliated events: ${errorMessage}`, 'error');
    })
    .finally(() => {
        btn.disabled = false;
        // Optional: Hide progress bar after a delay, remove error styling etc.
        // setTimeout(() => {
        //     progress.classList.remove('active', 'error');
        //     progressBar.style.width = '0%';
        // }, 5000);
    });
}

// Add this to existing scripts
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.matches('.modal-form') && event.detail.xhr.status === 200) {
        const response = JSON.parse(event.detail.xhr.responseText);
        showToast('Success', response.message, 'success');
        setTimeout(() => window.location.reload(), 1000); // Reload after 1 second
    } else if (event.detail.target.matches('.modal-form') && event.detail.xhr.status !== 200) {
        try {
            const response = JSON.parse(event.detail.xhr.responseText);
            showToast('Error', response.error || 'Failed to update user', 'error');
        } catch(e) {
            showToast('Error', 'Failed to update user', 'error');
        }
    }
});
</script>
{% endblock %}
