{% extends "base.html" %}
{% block title %}Import Details - {{ import_log.filename }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="fas fa-file-import text-primary me-2"></i>Import Details</h1>
            <p class="text-muted mb-0">{{ import_log.filename }}</p>
        </div>
        <div>
            <a href="{{ url_for('virtual.pathful_import') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Import
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary mb-0">{{ import_log.total_rows | default(0) }}</h3>
                    <small class="text-muted">Total Rows</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success mb-0">{{ import_log.processed_rows | default(0) }}</h3>
                    <small class="text-muted">Processed</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info mb-0">{{ import_log.events_created | default(0) }}</h3>
                    <small class="text-muted">Events Created</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-secondary mb-0">{{ import_log.events_updated | default(0) }}</h3>
                    <small class="text-muted">Events Updated</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning mb-0">{{ unmatched_count }}</h3>
                    <small class="text-muted">Unmatched</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger mb-0">{{ import_log.error_count | default(0) }}</h3>
                    <small class="text-muted">Errors</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Info -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Import Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <th width="40%">Status</th>
                            <td>
                                {% if import_log.status == 'completed' %}
                                <span class="badge bg-success">Completed</span>
                                {% elif import_log.status == 'failed' %}
                                <span class="badge bg-danger">Failed</span>
                                {% elif import_log.status == 'in_progress' %}
                                <span class="badge bg-warning">In Progress</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ import_log.status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Import Type</th>
                            <td>{{ import_log.import_type.value if import_log.import_type else 'Unknown' }}</td>
                        </tr>
                        <tr>
                            <th>Started</th>
                            <td>{{ import_log.started_at.strftime('%Y-%m-%d %H:%M:%S') if import_log.started_at else '-'
                                }}</td>
                        </tr>
                        <tr>
                            <th>Completed</th>
                            <td>{{ import_log.completed_at.strftime('%Y-%m-%d %H:%M:%S') if import_log.completed_at else
                                '-' }}</td>
                        </tr>
                        <tr>
                            <th>Duration</th>
                            <td>
                                {% if import_log.started_at and import_log.completed_at %}
                                {{ (import_log.completed_at - import_log.started_at).total_seconds() | int }} seconds
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Processing Breakdown</h5>
                </div>
                <div class="card-body">
                    <!-- Progress bar showing breakdown -->
                    {% set processed = import_log.processed_rows | default(0) %}
                    {% set skipped = import_log.skipped_rows | default(0) %}
                    {% set errors = import_log.error_count | default(0) %}
                    {% set total = import_log.total_rows | default(1) %}

                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar bg-success"
                            style="width: {{ (processed / total * 100) if total else 0 }}%">
                            {{ processed }} processed
                        </div>
                        <div class="progress-bar bg-secondary"
                            style="width: {{ (skipped / total * 100) if total else 0 }}%">
                            {{ skipped }} skipped
                        </div>
                        <div class="progress-bar bg-danger"
                            style="width: {{ (errors / total * 100) if total else 0 }}%">
                            {{ errors }} errors
                        </div>
                    </div>

                    <small class="text-muted">
                        <strong>Skipped rows:</strong> Non-PREP-KC partners, students, parents
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Unmatched Records -->
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                Unmatched Records ({{ pending_count }} pending of {{ unmatched_count }} total)
            </h5>
            {% if unmatched_count > 0 %}
            <a href="{{ url_for('virtual.pathful_unmatched') }}?import_id={{ import_log.id }}"
                class="btn btn-sm btn-warning">
                <i class="fas fa-external-link-alt me-1"></i> View All
            </a>
            {% endif %}
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-secondary">
                        <tr>
                            <th>Row</th>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Organization</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in unmatched_records %}
                        <tr>
                            <td>{{ record.row_number }}</td>
                            <td>
                                {% if record.unmatched_type.value == 'teacher' %}
                                <span class="badge bg-info">Educator</span>
                                {% elif record.unmatched_type.value == 'volunteer' %}
                                <span class="badge bg-purple" style="background-color: #9b59b6;">Professional</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ record.unmatched_type.value }}</span>
                                {% endif %}
                            </td>
                            <td>{{ record.attempted_match_name or '-' }}</td>
                            <td>{{ record.attempted_match_organization | truncate(30) if
                                record.attempted_match_organization else '-' }}</td>
                            <td>
                                {% if record.resolution_status.value == 'pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                                {% elif record.resolution_status.value == 'resolved' %}
                                <span class="badge bg-success">Resolved</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ record.resolution_status.value }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-3">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                No unmatched records
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if unmatched_count > 100 %}
            <div class="alert alert-info mb-0 rounded-0">
                <i class="fas fa-info-circle me-2"></i>
                Showing first 100 of {{ unmatched_count }} unmatched records.
                <a href="{{ url_for('virtual.pathful_unmatched') }}?import_id={{ import_log.id }}">View all</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
