{% extends "base.html" %}
{% block title %}Pathful Import{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">
                <i class="fas fa-file-import me-2"></i>Pathful Import
            </h1>
            <p class="text-muted">
                Import session data from Pathful Excel exports. Only PREP-KC partner sessions will be imported.
            </p>
        </div>
    </div>

    <!-- Upload Form Card -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-upload me-2"></i>Upload Pathful Export
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="import-form">
                        <div class="mb-3">
                            <label for="file" class="form-label">Select Excel File</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls" required>
                            <div class="form-text">
                                Supported formats: .xlsx, .xls
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-1"></i>Required Columns
                            </h6>
                            <p class="mb-0">
                                Session ID, Title, Date, Status, SignUp Role, Name
                            </p>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('virtual.pathful_import_history') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-history me-1"></i>View History
                            </a>
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <i class="fas fa-file-import me-1"></i>Import
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>Help
                    </h5>
                </div>
                <div class="card-body">
                    <h6>How it works:</h6>
                    <ol class="mb-3">
                        <li>Export session data from Pathful</li>
                        <li>Upload the Excel file here</li>
                        <li>System will match sessions and participants</li>
                        <li>Review unmatched records if any</li>
                    </ol>

                    <h6>What gets imported:</h6>
                    <ul class="mb-0">
                        <li>Sessions (as Virtual Events)</li>
                        <li>Educators (matched to Teachers)</li>
                        <li>Professionals (matched to Volunteers)</li>
                        <li>Student counts</li>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <a href="{{ url_for('virtual.pathful_events') }}" class="text-decoration-none">
                                <div class="p-3 bg-white rounded shadow-sm h-100">
                                    <i class="fas fa-calendar-alt fa-2x text-primary mb-2"></i>
                                    <h5 class="mb-1">View Events</h5>
                                    <small class="text-muted">Browse all imported sessions</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('virtual.pathful_participants') }}" class="text-decoration-none">
                                <div class="p-3 bg-white rounded shadow-sm h-100">
                                    <i class="fas fa-users fa-2x text-success mb-2"></i>
                                    <h5 class="mb-1">View Participants</h5>
                                    <small class="text-muted">Matched educators & professionals</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2">
                            <a href="{{ url_for('virtual.pathful_users') }}" class="text-decoration-none">
                                <div class="p-3 bg-white rounded shadow-sm h-100">
                                    <i class="fas fa-user-circle fa-2x mb-2" style="color: #6f42c1;"></i>
                                    <h5 class="mb-1">User Profiles</h5>
                                    <small class="text-muted">Pathful users</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('virtual.pathful_unmatched') }}" class="text-decoration-none">
                                <div class="p-3 bg-white rounded shadow-sm h-100">
                                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                                    <h5 class="mb-1">Unmatched Records</h5>
                                    <small class="text-muted">Review and resolve mismatches</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('virtual.pathful_import_history') }}" class="text-decoration-none">
                                <div class="p-3 bg-white rounded shadow-sm h-100">
                                    <i class="fas fa-history fa-2x text-info mb-2"></i>
                                    <h5 class="mb-1">Import History</h5>
                                    <small class="text-muted">View all past imports</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Recent Imports -->
    {% if recent_imports %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Recent Imports
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>File</th>
                                    <th>Status</th>
                                    <th>Rows</th>
                                    <th>Events</th>
                                    <th>Unmatched</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for imp in recent_imports %}
                                <tr style="cursor: pointer;"
                                    onclick="window.location='{{ url_for('virtual.pathful_import_detail', import_id=imp.id) }}'">
                                    <td>{{ imp.started_at.strftime('%Y-%m-%d %H:%M') if imp.started_at else 'N/A' }}
                                    </td>
                                    <td>{{ imp.filename }}</td>
                                    <td>
                                        {% if imp.completed_at %}
                                        <span class="badge bg-success">Complete</span>
                                        {% else %}
                                        <span class="badge bg-warning">In Progress</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ imp.processed_rows }} / {{ imp.total_rows }}</td>
                                    <td>
                                        <span class="text-success">+{{ imp.created_events }}</span>
                                        <span class="text-muted mx-1">/</span>
                                        <span class="text-info">~{{ imp.updated_events }}</span>
                                    </td>
                                    <td>
                                        {% if imp.unmatched_count > 0 %}
                                        <a href="{{ url_for('virtual.pathful_unmatched') }}?import_id={{ imp.id }}"
                                            class="badge bg-warning text-decoration-none"
                                            onclick="event.stopPropagation();">
                                            {{ imp.unmatched_count }}
                                        </a>
                                        {% else %}
                                        <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('virtual.pathful_import_detail', import_id=imp.id) }}"
                                            class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.getElementById('import-form').addEventListener('submit', function (e) {
        var btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Importing...';
    });
</script>
{% endblock %}
