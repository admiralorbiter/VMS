{% extends "base.html" %}

{% block title %}Virtual Session Usage Report{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reports.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/virtual_usage.css') }}">
<style>
    .district-summaries {
        margin: 30px 0;
    }

    .district-summaries h2 {
        margin-bottom: 20px;
        color: #333;
        font-size: 1.5em;
        font-weight: 600;
    }

    .district-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        /* Always 3 columns on desktop */
        gap: 32px;
    }

    .district-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
        min-width: 340px;
    }

    .district-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        row-gap: 10px;
    }

    .district-header h3 {
        margin: 0;
        font-size: 1.3em;
        font-weight: 600;
    }

    .district-link {
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        font-size: 0.9em;
        font-weight: 500;
        transition: background 0.2s;
    }

    .district-link:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        text-decoration: none;
    }

    .district-stats {
        padding: 24px 20px 20px 20px;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .stat-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 12px;
        margin-bottom: 0;
    }

    .stat-item {
        flex: 1 1 0;
        min-width: 0;
        text-align: center;
        margin: 0 2px;
        padding: 2px 0;
    }

    .stat-value {
        display: block;
        font-size: 1.5em;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 2px;
        white-space: nowrap;
    }

    .stat-label {
        color: #666;
        font-weight: 600;
        font-size: 0.8em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    @media (max-width: 1100px) {
        .district-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width: 700px) {
        .district-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 1200px) {
        .stat-value {
            font-size: 1.35em;
        }
    }

    /* Filter Actions Button Layout */
    .filter-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-top: 15px;
    }

    .filter-btn,
    .reset-btn,
    .export-btn {
        padding: 10px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-align: center;
        white-space: nowrap;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .filter-btn {
        background: #007bff;
        color: white;
    }

    .filter-btn:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }

    .reset-btn {
        background: #dc3545;
        color: white;
    }

    .reset-btn:hover {
        background: #c82333;
        color: white;
        text-decoration: none;
    }

    .export-btn {
        background: #28a745;
        color: white;
    }

    .export-btn:hover {
        background: #218838;
        color: white;
        text-decoration: none;
    }

    @media (max-width: 1200px) {
        .filter-actions {
            flex-wrap: wrap;
        }

        .filter-btn,
        .reset-btn,
        .export-btn {
            font-size: 13px;
            padding: 8px 12px;
        }
    }

    /* Link Styling for Session Titles, Teachers, and Presenters */
    .session-title-link:hover,
    .teacher-link:hover,
    .presenter-link:hover {
        color: #0056b3;
        text-decoration: underline;
    }

    .session-external-btn:hover {
        background: #218838 !important;
        color: white !important;
        text-decoration: none !important;
    }

    @media (max-width: 768px) {
        .district-grid {
            grid-template-columns: 1fr;
        }

        .district-header {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }

        .stat-row {
            grid-template-columns: repeat(2, 1fr);
        }

        .filter-actions {
            justify-content: center;
        }

        .filter-btn,
        .reset-btn,
        .export-btn {
            font-size: 12px;
            padding: 8px 10px;
        }

        /* Mobile adjustments for session links */
        .session-external-btn {
            font-size: 0.7em !important;
            padding: 3px 6px !important;
        }
    }

    /* Mobile adjustments for session links */
    .session-external-btn {
        font-size: 0.7em !important;
        padding: 3px 6px !important;
    }
    }

    .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .add-item-btn.secondary {
        background-color: #6c757d;
    }

    .add-item-btn.secondary:hover {
        background-color: #5a6268;
    }

    .create-row {
        background-color: #f8f9fa;
        border: 1px dashed #ced4da;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .create-row-label {
        font-size: 0.8em;
        font-weight: bold;
        color: #6c757d;
        margin-bottom: 5px;
        display: block;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<div class="virtual-sessions-container">
    <h1 class="page-title">Virtual Session Usage Report</h1>

    <!-- Filter Section -->
    <div class="filters-section">
        <form class="filters-form" method="GET">
            <div class="filter-group">
                <label for="year">Academic Year:</label>
                <select id="year" name="year">
                    {% for school_year in filter_options.school_years %}
                    <option value="{{ school_year }}" {% if school_year==current_filters.year %}selected{% endif %}>
                        {{ school_year }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="date_from">Date From:</label>
                <input type="date" id="date_from" name="date_from"
                    value="{{ current_filters.date_from.strftime('%Y-%m-%d') if current_filters.date_from }}">
            </div>

            <div class="filter-group">
                <label for="date_to">Date To:</label>
                <input type="date" id="date_to" name="date_to"
                    value="{{ current_filters.date_to.strftime('%Y-%m-%d') if current_filters.date_to }}">
            </div>

            <div class="filter-group">
                <label for="career_cluster">Career Cluster:</label>
                <select id="career_cluster" name="career_cluster">
                    <option value="">All Clusters</option>
                    {% for cluster in filter_options.career_clusters %}
                    <option value="{{ cluster }}" {% if cluster==current_filters.career_cluster %}selected{% endif %}>
                        {{ cluster }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="district">District:</label>
                <select id="district" name="district">
                    <option value="">All Districts</option>
                    {% for district in filter_options.districts %}
                    <option value="{{ district }}" {% if district==current_filters.district %}selected{% endif %}>
                        {{ district }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="school">School:</label>
                <select id="school" name="school">
                    <option value="">All Schools</option>
                    {% for school in filter_options.schools %}
                    <option value="{{ school }}" {% if school==current_filters.school %}selected{% endif %}>
                        {{ school }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="status">Status:</label>
                <select id="status" name="status">
                    <option value="">All Statuses</option>
                    {% for status in filter_options.statuses %}
                    <option value="{{ status }}" {% if status==current_filters.status %}selected{% endif %}>
                        {{ status }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="search">Search:</label>
                <input type="text" id="search" name="search" placeholder="Teacher, Title, or Presenter..."
                    value="{{ current_filters.search if current_filters.search }}">
            </div>
            <!-- BUTTONS BELOW FILTERS -->
            <div class="filter-actions">
                <button type="submit" class="filter-btn">Apply Filters</button>
                <a href="{{ url_for('virtual.virtual_usage') }}" class="reset-btn">Reset</a>
                {% if session_data %}
                <a href="{{ url_for('virtual.virtual_usage', refresh=1) }}{{ '&' + request.query_string.decode() if request.query_string else '' }}"
                    class="export-btn" title="Refresh Data" style="background: #28a745;">
                    üîÑ Refresh
                </a>
                <a href="{{ url_for('virtual.virtual_usage_export') }}{{ '?' + request.query_string.decode() if request.query_string else '' }}"
                    class="export-btn" title="Export to Excel">
                    üìä Export
                </a>
                <a href="{{ url_for('virtual.virtual_breakdown', year=current_filters.year, date_from=current_filters.date_from.strftime('%Y-%m-%d') if current_filters.date_from else '', date_to=current_filters.date_to.strftime('%Y-%m-%d') if current_filters.date_to else '') }}"
                    class="export-btn" title="View Detailed Breakdown">
                    üìà Breakdown
                </a>
                {% if current_user.is_admin %}
                <a href="{{ url_for('virtual.pathful_import') }}" class="export-btn"
                    title="Import data from Pathful exports" style="background: #7c4dff;">
                    <i class="fas fa-upload"></i> Pathful Import
                </a>
                <a href="{{ url_for('virtual.pathful_events') }}" class="export-btn"
                    title="View Pathful-imported events" style="background: #7c4dff;">
                    <i class="fas fa-link"></i> Pathful Events
                </a>
                {% endif %}
                {% if current_user.is_admin %}
                <button type="button" class="export-btn new-session-btn" onclick="openCreateVirtualModal()">
                    ‚ûï New Session
                </button>
                {% endif %}
                {% if current_user.is_admin or current_user.scope_type == 'global' %}
                <a href="{{ url_for('virtual.virtual_recruitment') }}" class="export-btn"
                    title="View events needing presenters" style="background: #ffc107; color: #333;">
                    <i class="fas fa-user-plus"></i> Presenter Recruitment
                </a>
                {% endif %}
                {% if current_user.is_admin %}
                {% if request.args.get('show_all_districts') == '1' %}
                <a href="{{ url_for('virtual.virtual_usage') }}{{ '?' + request.query_string.decode() if request.query_string else '' }}"
                    class="export-btn" title="Show Main Districts Only" style="background: #17a2b8;">
                    üè† Main Districts
                </a>
                {% else %}
                <a href="{{ url_for('virtual.virtual_usage', show_all_districts=1) }}{{ '&' + request.query_string.decode() if request.query_string else '' }}"
                    class="export-btn" title="Show All Districts" style="background: #6c757d;">
                    üåê All Districts
                </a>
                {% endif %}
                {% endif %}
                {% set is_grouped = request.args.get('group_manual') == '1' %}
                {% set query_params = request.args.to_dict() %}
                {% if is_grouped %}
                {% set _ = query_params.update({'group_manual': '0'}) %}
                <a href="{{ url_for('virtual.virtual_usage', **query_params) }}" class="export-btn"
                    title="Show all sessions as individual lines (one per teacher/presenter)"
                    style="background: #6c757d;">
                    üìã Lines
                </a>
                {% else %}
                {% set _ = query_params.update({'group_manual': '1'}) %}
                <a href="{{ url_for('virtual.virtual_usage', **query_params) }}" class="export-btn"
                    title="Group sessions by title + date + time (combine multiple teachers/presenters)"
                    style="background: #6c757d;">
                    üì¶ Group
                </a>
                {% endif %}
                {% endif %}

            </div>
        </form>
    </div>

    {% if current_user.is_admin %}
    <!-- Create Virtual Session Modal -->
    <div id="createVirtualModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2>New Virtual Session</h2>
                <button type="button" class="modal-close-btn" onclick="closeCreateVirtualModal()">Close</button>
            </div>

            <div class="modal-body">
                <form method="POST" action="{{ url_for('virtual.create_virtual_usage_session') }}" class="modal-form"
                    onclick="event.stopPropagation();">
                    <input type="hidden" name="year" value="{{ current_filters.year }}">

                    <div class="form-row form-row-3">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <input type="time" name="time" required>
                        </div>
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" name="duration" min="15" step="5" value="60">
                        </div>
                    </div>

                    <div class="form-row form-row-3-2-1">
                        <div class="form-group">
                            <label>Session Title</label>
                            <input type="text" name="title" required
                                placeholder="e.g., Investigating Weather Patterns...">
                        </div>
                        <div class="form-group">
                            <label>Session Type</label>
                            <input type="text" name="session_type" placeholder="e.g., Career Talk">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status" class="status-select">
                                <option value="Draft">Draft</option>
                                <option value="Requested">Requested</option>
                                <option value="Confirmed">Confirmed</option>
                                <option value="Published">Published</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                                <option value="No Show">No Show</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Topic/Theme</label>
                        <input type="text" name="topic_theme" placeholder="e.g., STEM / Health / Finance">
                    </div>

                    <div class="form-group">
                        <label>Session Link (optional)</label>
                        <input type="url" name="session_link" placeholder="https://...">
                    </div>

                    <hr class="form-divider">

                    <div class="section-header">
                        <h3>Teachers</h3>
                        <h3>Teachers</h3>
                        <div class="header-actions">
                            <button type="button" class="add-item-btn" onclick="addTeacherRow()">+ Add Teacher</button>
                            <button type="button" class="add-item-btn secondary" onclick="addTeacherCreateRow()">+ Quick
                                Create Teacher</button>
                        </div>
                    </div>
                    <div id="teacherRows" class="dynamic-rows"></div>

                    <hr class="form-divider">

                    <div class="section-header">
                        <h3>Presenters</h3>
                        <h3>Presenters</h3>
                        <div class="header-actions">
                            <button type="button" class="add-item-btn" onclick="addPresenterRow()">+ Add
                                Presenter</button>
                            <button type="button" class="add-item-btn secondary" onclick="addPresenterCreateRow()">+
                                Quick Create Presenter</button>
                        </div>
                    </div>
                    <div id="presenterRows" class="dynamic-rows"></div>

                    <div class="modal-footer">
                        <button type="submit" class="filter-btn" id="submitSessionBtn">Create Session</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let isEditMode = false;
        let editEventId = null;

        function openCreateVirtualModal() {
            isEditMode = false;
            editEventId = null;
            const m = document.getElementById('createVirtualModal');
            const form = m.querySelector('form');
            form.reset();
            form.action = "{{ url_for('virtual.create_virtual_usage_session') }}";
            m.querySelector('.modal-header h2').textContent = 'New Virtual Session';
            document.getElementById('submitSessionBtn').textContent = 'Create Session';
            document.getElementById('teacherRows').innerHTML = '';
            document.getElementById('presenterRows').innerHTML = '';
            m.classList.add('show');
            if (!document.getElementById('teacherRows').children.length) addTeacherRow();
            if (!document.getElementById('presenterRows').children.length) addPresenterRow();
        }

        function openEditVirtualModal(eventId) {
            isEditMode = true;
            editEventId = eventId;
            const m = document.getElementById('createVirtualModal');
            const form = m.querySelector('form');
            form.action = `{{ url_for('virtual.edit_virtual_usage_session', event_id=0) }}`.replace('/0', '/' + eventId);
            m.querySelector('.modal-header h2').textContent = 'Edit Virtual Session';
            document.getElementById('submitSessionBtn').textContent = 'Update Session';

            // Fetch event data
            fetch(`{{ url_for('virtual.edit_virtual_usage_session', event_id=0) }}`.replace('/0', '/' + eventId))
                .then(r => r.json())
                .then(data => {
                    // Populate form fields
                    form.querySelector('input[name="title"]').value = data.title || '';
                    form.querySelector('input[name="date"]').value = data.date || '';
                    form.querySelector('input[name="time"]').value = data.time || '';
                    form.querySelector('input[name="duration"]').value = data.duration || 60;
                    form.querySelector('input[name="session_type"]').value = data.session_type || '';
                    form.querySelector('input[name="topic_theme"]').value = data.topic_theme || '';
                    form.querySelector('input[name="session_link"]').value = data.session_link || '';
                    if (data.status) {
                        const statusSelect = form.querySelector('select[name="status"]');
                        if (statusSelect) {
                            statusSelect.value = data.status;
                        }
                    }

                    // Clear and populate teachers
                    const teacherRows = document.getElementById('teacherRows');
                    teacherRows.innerHTML = '';
                    if (data.teachers && data.teachers.length > 0) {
                        data.teachers.forEach(teacher => {
                            addTeacherRow();
                            const lastRow = teacherRows.lastElementChild;
                            lastRow.querySelector('.teacher-id-input').value = teacher.id;
                            lastRow.querySelector('.teacher-search-input').value = teacher.name;
                            lastRow.querySelector('.teacher-school-input').value = teacher.school || '';
                        });
                    } else {
                        addTeacherRow();
                    }

                    // Clear and populate presenters
                    const presenterRows = document.getElementById('presenterRows');
                    presenterRows.innerHTML = '';
                    if (data.presenters && data.presenters.length > 0) {
                        data.presenters.forEach(presenter => {
                            addPresenterRow();
                            const lastRow = presenterRows.lastElementChild;
                            lastRow.querySelector('.presenter-id-input').value = presenter.id;
                            lastRow.querySelector('.presenter-search-input').value = presenter.name;
                            lastRow.querySelector('.presenter-org-input').value = presenter.organization || '';
                        });
                    } else {
                        addPresenterRow();
                    }

                    m.classList.add('show');
                })
                .catch(err => {
                    console.error('Error loading event:', err);
                    alert('Error loading event data. Please try again.');
                });
        }

        function closeCreateVirtualModal() {
            const m = document.getElementById('createVirtualModal');
            m.classList.remove('show');
            isEditMode = false;
            editEventId = null;
        }

        function deleteVirtualSession(eventId) {
            // Show confirmation dialog
            if (!confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
                return;
            }

            // Make POST request to delete route
            fetch(`{{ url_for('virtual.delete_virtual_usage_session', event_id=0) }}`.replace('/0', '/' + eventId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (response.redirected) {
                        // Success - redirect will handle the flash message
                        window.location.href = response.url;
                    } else {
                        return response.json().catch(() => {
                            // If not JSON, assume success and reload
                            window.location.reload();
                        });
                    }
                })
                .then(data => {
                    if (data && data.error) {
                        alert('Error deleting session: ' + data.error);
                    } else {
                        // Reload page to show updated table
                        window.location.reload();
                    }
                })
                .catch(err => {
                    console.error('Error deleting session:', err);
                    alert('Error deleting session. Please try again.');
                });
        }

        function updateEventStatus(eventId, newStatus) {
            fetch(`{{ url_for('virtual.update_virtual_session_status', event_id=0) }}`.replace('/0', '/' + eventId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        // Optionally show a success message or update the UI
                        // The page will refresh on next load to show the new status
                    } else {
                        alert('Error updating status: ' + (data.error || 'Unknown error'));
                        // Reload to reset the dropdown
                        location.reload();
                    }
                })
                .catch(err => {
                    console.error('Error updating status:', err);
                    alert('Error updating status. Please try again.');
                    location.reload();
                });
        }

        // Setup modal click handlers - close only when clicking backdrop
        (function setupModalHandlers() {
            const modal = document.getElementById('createVirtualModal');
            if (!modal) {
                setTimeout(setupModalHandlers, 50);
                return;
            }

            // Single event handler that checks if click is on backdrop
            modal.addEventListener('click', function (e) {
                if (!modal.classList.contains('show')) return;

                const dialog = modal.querySelector('.modal-dialog');

                // If click is inside the dialog, do nothing (don't close)
                if (dialog && dialog.contains(e.target)) {
                    return;
                }

                // Only close if clicking directly on the backdrop (modal element itself)
                if (e.target === modal) {
                    closeCreateVirtualModal();
                }
            });
        })();

        function addTeacherRow() {
            const container = document.getElementById('teacherRows');
            const row = document.createElement('div');
            row.className = 'dynamic-row';
            const rowId = 'teacher-row-' + Date.now();
            row.id = rowId;
            row.innerHTML = `
          <div class="form-group" style="position: relative;">
            <label>Teacher Name</label>
            <input type="hidden" name="teacher_id[]" class="teacher-id-input" />
            <input type="text" name="teacher_name[]" class="teacher-search-input" placeholder="Search or type name..." autocomplete="off" />
            <div class="search-results" style="display: none;"></div>
          </div>
          <div class="form-group">
            <label>School</label>
            <input type="text" name="teacher_school[]" class="teacher-school-input" placeholder="Auto-filled from database" readonly />
          </div>
          <div class="form-group" style="display: none;">
            <label>District</label>
            <input type="text" class="teacher-district-display" placeholder="Auto-filled from database" readonly style="background: #f0f0f0;" />
          </div>
          <div>
            <button type="button" class="remove-item-btn" onclick="this.closest('.dynamic-row').remove()">Remove</button>
          </div>
        `;
            container.appendChild(row);
            setupTeacherSearch(row.querySelector('.teacher-search-input'));
        }

        function addTeacherCreateRow() {
            const container = document.getElementById('teacherRows');
            const row = document.createElement('div');
            row.className = 'dynamic-row create-row';
            row.innerHTML = `
            <span class="create-row-label">New Teacher Creation</span>
            <div class="form-row form-row-2">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" class="new-teacher-first" name="new_teacher_first_name[]" required placeholder="First Name">
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" class="new-teacher-last" name="new_teacher_last_name[]" required placeholder="Last Name">
                </div>
            </div>
            <div class="form-group">
                <label>School</label>
                <input type="text" class="new-teacher-school" name="new_teacher_school[]" required placeholder="School Name">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="add-item-btn" onclick="createTeacher(this)">Save & Add</button>
                <button type="button" class="remove-item-btn" onclick="this.closest('.dynamic-row').remove()">Cancel</button>
            </div>
        `;
            container.appendChild(row);
        }

        function createTeacher(btn) {
            const row = btn.closest('.dynamic-row');
            const fName = row.querySelector('.new-teacher-first').value.trim();
            const lName = row.querySelector('.new-teacher-last').value.trim();
            const school = row.querySelector('.new-teacher-school').value.trim();

            if (!fName || !lName) {
                alert('First and Last Name are required.');
                return;
            }

            // Disable button
            btn.disabled = true;
            btn.textContent = 'Saving...';

            fetch('{{ url_for("virtual.create_teacher_api") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    first_name: fName,
                    last_name: lName,
                    school: school
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        // Remove create row
                        row.remove();
                        // Add standard row
                        addTeacherRow();
                        // Populate last added row
                        const container = document.getElementById('teacherRows');
                        const newRow = container.lastElementChild;
                        newRow.querySelector('.teacher-id-input').value = data.id;
                        newRow.querySelector('.teacher-search-input').value = data.name;
                        newRow.querySelector('.teacher-school-input').value = data.school || '';
                        // district is auto-filled if available, though handled by search usually.
                        // We can manually set it if we had a field for it, currently display only.
                    } else {
                        alert('Error creating teacher: ' + (data.error || 'Unknown error'));
                        btn.disabled = false;
                        btn.textContent = 'Save & Add';
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error processing request.');
                    btn.disabled = false;
                    btn.textContent = 'Save & Add';
                });
        }

        function setupTeacherSearch(input) {
            let searchTimeout;
            const row = input.closest('.dynamic-row');
            const idInput = row.querySelector('.teacher-id-input');
            const schoolInput = row.querySelector('.teacher-school-input');
            const districtDisplay = row.querySelector('.teacher-district-display');
            const resultsDiv = input.parentElement.querySelector('.search-results');

            input.addEventListener('input', function () {
                clearTimeout(searchTimeout);
                const query = this.value.trim();

                if (query.length < 2) {
                    resultsDiv.style.display = 'none';
                    idInput.value = '';
                    schoolInput.value = '';
                    districtDisplay.value = '';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    fetch(`{{ url_for('virtual.search_teachers') }}?q=${encodeURIComponent(query)}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.length === 0) {
                                resultsDiv.style.display = 'none';
                                // Clear fields if no results
                                idInput.value = '';
                                schoolInput.value = '';
                                districtDisplay.value = '';
                                return;
                            }

                            // Check for exact match (case-insensitive)
                            const exactMatch = data.find(t => t.name.toLowerCase() === query.toLowerCase());
                            if (exactMatch) {
                                // Auto-fill if exact match found
                                idInput.value = exactMatch.id;
                                input.value = exactMatch.name;
                                schoolInput.value = exactMatch.school || '';
                                districtDisplay.value = exactMatch.district || '';
                                resultsDiv.style.display = 'none';
                                return;
                            }

                            resultsDiv.innerHTML = data.map(t => `
                  <div class="search-result-item" data-id="${t.id}" data-name="${t.name}" data-school="${t.school || ''}" data-district="${t.district || ''}">
                    <strong>${t.name}</strong>
                    ${t.school ? `<br><small>${t.school}</small>` : ''}
                    ${t.district ? `<br><small style="color: #666;">${t.district}</small>` : ''}
                  </div>
                `).join('');
                            resultsDiv.style.display = 'block';

                            // Add click handlers
                            resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
                                item.addEventListener('click', function () {
                                    idInput.value = this.dataset.id;
                                    input.value = this.dataset.name;
                                    schoolInput.value = this.dataset.school || '';
                                    districtDisplay.value = this.dataset.district || '';
                                    resultsDiv.style.display = 'none';
                                });
                            });
                        })
                        .catch(err => {
                            console.error('Search error:', err);
                            resultsDiv.style.display = 'none';
                        });
                }, 300);
            });

            // Hide results when clicking outside
            document.addEventListener('click', function (e) {
                if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        function addPresenterRow() {
            const container = document.getElementById('presenterRows');
            const row = document.createElement('div');
            row.className = 'dynamic-row';
            const rowId = 'presenter-row-' + Date.now();
            row.id = rowId;
            row.innerHTML = `
          <div class="form-group" style="position: relative;">
            <label>Presenter Name</label>
            <input type="hidden" name="presenter_id[]" class="presenter-id-input" />
            <input type="text" name="presenter_name[]" class="presenter-search-input" placeholder="Search or type name..." autocomplete="off" />
            <div class="search-results" style="display: none;"></div>
          </div>
          <div class="form-group">
            <label>Presenter Organization</label>
            <input type="text" name="presenter_org[]" class="presenter-org-input" placeholder="Auto-filled from database" readonly />
          </div>
          <div>
            <button type="button" class="remove-item-btn" onclick="this.closest('.dynamic-row').remove()">Remove</button>
          </div>
        `;
            container.appendChild(row);
        }

        function addPresenterCreateRow() {
            const container = document.getElementById('presenterRows');
            const row = document.createElement('div');
            row.className = 'dynamic-row create-row';
            row.innerHTML = `
            <span class="create-row-label">New Presenter Creation</span>
            <div class="form-row form-row-2">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" class="new-presenter-first" name="new_presenter_first_name[]" required placeholder="First Name">
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" class="new-presenter-last" name="new_presenter_last_name[]" required placeholder="Last Name">
                </div>
            </div>
            <div class="form-group">
                <label>Organization</label>
                <input type="text" class="new-presenter-org" name="new_presenter_org[]" required placeholder="Organization">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="add-item-btn" onclick="createPresenter(this)">Save & Add</button>
                <button type="button" class="remove-item-btn" onclick="this.closest('.dynamic-row').remove()">Cancel</button>
            </div>
        `;
            container.appendChild(row);
        }

        function createPresenter(btn) {
            const row = btn.closest('.dynamic-row');
            const fName = row.querySelector('.new-presenter-first').value.trim();
            const lName = row.querySelector('.new-presenter-last').value.trim();
            const org = row.querySelector('.new-presenter-org').value.trim();

            if (!fName) {
                alert('First Name is required.');
                return;
            }

            // Disable button
            btn.disabled = true;
            btn.textContent = 'Saving...';

            fetch('{{ url_for("virtual.create_presenter_api") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    first_name: fName,
                    last_name: lName,
                    organization: org
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        // Remove create row
                        row.remove();
                        // Add standard row
                        addPresenterRow();
                        // Populate last added row
                        const container = document.getElementById('presenterRows');
                        const newRow = container.lastElementChild;
                        newRow.querySelector('.presenter-id-input').value = data.id;
                        newRow.querySelector('.presenter-search-input').value = data.name;
                        newRow.querySelector('.presenter-org-input').value = data.organization || '';
                    } else {
                        alert('Error creating presenter: ' + (data.error || 'Unknown error'));
                        btn.disabled = false;
                        btn.textContent = 'Save & Add';
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error processing request.');
                    btn.disabled = false;
                    btn.textContent = 'Save & Add';
                });
        }


        function setupPresenterSearch(input) {
            let searchTimeout;
            const row = input.closest('.dynamic-row');
            const idInput = row.querySelector('.presenter-id-input');
            const orgInput = row.querySelector('.presenter-org-input');
            const resultsDiv = input.parentElement.querySelector('.search-results');

            input.addEventListener('input', function () {
                clearTimeout(searchTimeout);
                const query = this.value.trim();

                if (query.length < 2) {
                    resultsDiv.style.display = 'none';
                    idInput.value = '';
                    orgInput.value = '';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    fetch(`{{ url_for('virtual.search_presenters') }}?q=${encodeURIComponent(query)}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.length === 0) {
                                resultsDiv.style.display = 'none';
                                return;
                            }

                            resultsDiv.innerHTML = data.map(p => `
                  <div class="search-result-item" data-id="${p.id}" data-name="${p.name}" data-org="${p.organization || ''}">
                    <strong>${p.name}</strong>
                    ${p.organization ? `<br><small>${p.organization}</small>` : ''}
                  </div>
                `).join('');
                            resultsDiv.style.display = 'block';

                            // Add click handlers
                            resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
                                item.addEventListener('click', function () {
                                    idInput.value = this.dataset.id;
                                    input.value = this.dataset.name;
                                    orgInput.value = this.dataset.org || '';
                                    resultsDiv.style.display = 'none';
                                });
                            });
                        })
                        .catch(err => console.error('Search error:', err));
                }, 300);
            });

            // Hide results when clicking outside
            document.addEventListener('click', function (e) {
                if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

    </script>
    {% endif %}

    <!-- Last Refreshed Info -->
    {% if session_data %}
    <div class="data-info" style="text-align: center; margin: 20px 0; color: #666; font-size: 0.9em;">
        {% if last_refreshed %}
        Data last refreshed: {{ last_refreshed.strftime('%B %d, %Y at %I:%M %p') }}
        {% if is_cached %}
        <span style="color: #28a745; font-weight: bold;">‚óè Cached</span>
        {% else %}
        <span style="color: #dc3545; font-weight: bold;">‚óè Fresh</span>
        {% endif %}
        {% else %}
        Data freshly loaded
        {% endif %}
    </div>
    {% endif %}

    <!-- Summary Stats -->
    {% if session_data %}
    <div class="summary-stats">
        <div class="stat-card">
            <div class="stat-value">{{ overall_summary.student_count }}</div>
            <div class="stat-label">STUDENTS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ overall_summary.teacher_count }}</div>
            <div class="stat-label">TEACHERS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ overall_summary.session_count }}</div>
            <div class="stat-label">SESSIONS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ overall_summary.experience_count }}</div>
            <div class="stat-label">EXPS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ overall_summary.organization_count }}</div>
            <div class="stat-label">ORG</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ overall_summary.professional_count }}</div>
            <div class="stat-label">PROS</div>
        </div>
        <div class="stat-card" title="Sessions led by a Local professional">
            <div class="stat-value">{{ overall_summary.local_session_count or 0 }}</div>
            <div class="stat-subvalue">{{ overall_summary.local_session_percent or 0 }}% of sessions</div>
            <div class="stat-label">LOCAL SESS</div>
        </div>
        <div class="stat-card" title="Sessions led by a Professional of Color">
            <div class="stat-value">{{ overall_summary.poc_session_count or 0 }}</div>
            <div class="stat-subvalue">{{ overall_summary.poc_session_percent or 0 }}% of sessions</div>
            <div class="stat-label">POC SESS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ overall_summary.local_professional_count or 0 }}</div>
            <div class="stat-label">LOCAL PROS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ overall_summary.professional_of_color_count }}</div>
            <div class="stat-label">POC</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ overall_summary.school_count }}</div>
            <div class="stat-label">SCHOOLS</div>
        </div>
    </div>

    <!-- District Summaries -->
    {% if district_summaries %}
    <div class="district-summaries">
        <h2>District Breakdown</h2>
        <div class="district-grid">
            {% for district_name, summary in district_summaries.items() %}
            <div class="district-card">
                <div class="district-header">
                    <h3>{{ district_name }}</h3>
                    <div style="display: flex; gap: 8px;">
                        <a href="{{ url_for('virtual.virtual_usage_district', district_name=district_name, year=current_filters.year, date_from=current_filters.date_from.strftime('%Y-%m-%d') if current_filters.date_from else '', date_to=current_filters.date_to.strftime('%Y-%m-%d') if current_filters.date_to else '') }}"
                            class="district-link">View Details</a>
                        {% if district_name == "Kansas City Kansas Public Schools" %}
                        <a href="{{ url_for('virtual.virtual_district_teacher_progress', district_name=district_name, year=current_filters.year, date_from=current_filters.date_from.strftime('%Y-%m-%d') if current_filters.date_from else '', date_to=current_filters.date_to.strftime('%Y-%m-%d') if current_filters.date_to else '') }}"
                            class="district-link" style="background: rgba(40, 167, 69, 0.3);"
                            title="Teacher Progress Tracking">
                            üìà Progress</a>
                        {% endif %}
                        <a href="{{ url_for('virtual.get_district_google_sheet', district_name=district_name, year=current_filters.year) }}"
                            class="district-link" style="background: rgba(255, 255, 255, 0.1);"
                            title="View Google Sheet">
                            üìä Sheet</a>
                    </div>
                </div>
                <div class="district-stats">
                    <div class="stat-row">
                        <div class="stat-item">
                            <span class="stat-value">{{ summary.teacher_count }}</span>
                            <span class="stat-label">TEACHERS</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ summary.total_students }}</span>
                            <span class="stat-label">STUDENTS</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ summary.session_count }}</span>
                            <span class="stat-label">SESSIONS</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ summary.total_experiences }}</span>
                            <span class="stat-label">EXPS</span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-item">
                            <span class="stat-value">{{ summary.organization_count }}</span>
                            <span class="stat-label">ORG</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ summary.professional_count }}</span>
                            <span class="stat-label">PROS</span>
                        </div>
                        <div class="stat-item" title="Local-led sessions">
                            <span class="stat-value">{{ summary.local_session_count or 0 }}</span>
                            <span class="stat-subvalue"><span class="percent-pill">{{ summary.local_session_percent or 0
                                    }}%</span></span>
                            <span class="stat-label">LOCAL SESS</span>
                        </div>
                        <div class="stat-item" title="POC-led sessions">
                            <span class="stat-value">{{ summary.poc_session_count or 0 }}</span>
                            <span class="stat-subvalue"><span class="percent-pill">{{ summary.poc_session_percent or 0
                                    }}%</span></span>
                            <span class="stat-label">POC SESS</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ summary.professional_of_color_count }}</span>
                            <span class="stat-label">POC</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ summary.school_count }}</span>
                            <span class="stat-label">SCHOOLS</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Sessions Table -->


    <div class="orgs-table-container">
        <table class="orgs-table">
            <thead>
                <tr>
                    <th class="sortable-header" data-column="status">
                        Status
                        <span
                            class="sort-indicator {% if current_filters.sort == 'status' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="date">
                        Date
                        <span
                            class="sort-indicator {% if current_filters.sort == 'date' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="time">
                        Time
                        <span
                            class="sort-indicator {% if current_filters.sort == 'time' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="session_type">
                        Session Type
                        <span
                            class="sort-indicator {% if current_filters.sort == 'session_type' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="teacher_name">
                        Teacher Name
                        <span
                            class="sort-indicator {% if current_filters.sort == 'teacher_name' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="school_name">
                        School Name
                        <span
                            class="sort-indicator {% if current_filters.sort == 'school_name' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="school_level">
                        School Level
                        <span
                            class="sort-indicator {% if current_filters.sort == 'school_level' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="district">
                        District
                        <span
                            class="sort-indicator {% if current_filters.sort == 'district' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="session_title">
                        Session Title
                        <span
                            class="sort-indicator {% if current_filters.sort == 'session_title' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="presenter">
                        Presenter
                        <span
                            class="sort-indicator {% if current_filters.sort == 'presenter' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="presenter_organization">
                        Presenter Organization
                        <span
                            class="sort-indicator {% if current_filters.sort == 'presenter_organization' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                    <th class="sortable-header" data-column="topic_theme">
                        Topic/Theme
                        <span
                            class="sort-indicator {% if current_filters.sort == 'topic_theme' %}active {{ current_filters.order }}{% endif %}"></span>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for session in session_data %}
                <tr>
                    <td>
                        {% if session.source_host == 'APP' and current_user.is_admin %}
                        <select class="status-quick-change" data-event-id="{{ session.event_id }}"
                            onchange="updateEventStatus({{ session.event_id }}, this.value)"
                            style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ced4da; font-size: 0.85em; cursor: pointer;">
                            <option value="Draft" {% if session.status=='Draft' %}selected{% endif %}>Draft</option>
                            <option value="Requested" {% if session.status=='Requested' %}selected{% endif %}>Requested
                            </option>
                            <option value="Confirmed" {% if session.status=='Confirmed' %}selected{% endif %}>Confirmed
                            </option>
                            <option value="Published" {% if session.status=='Published' %}selected{% endif %}>Published
                            </option>
                            <option value="Completed" {% if session.status=='Completed' %}selected{% endif %}>Completed
                            </option>
                            <option value="Cancelled" {% if session.status=='Cancelled' %}selected{% endif %}>Cancelled
                            </option>
                            <option value="No Show" {% if session.status=='No Show' %}selected{% endif %}>No Show
                            </option>
                        </select>
                        {% else %}
                        <span class="status-badge status-{{ session.status|lower|replace(' ', '-') }}">
                            {{ session.status }}
                        </span>
                        {% endif %}
                    </td>
                    <td>{{ session.date }}</td>
                    <td>{{ session.time }}</td>
                    <td>{{ session.session_type }}</td>
                    <td>
                        {% if session.teacher_id and session.teacher_name %}
                        <a href="{{ url_for('teachers.view_teacher', teacher_id=session.teacher_id) }}"
                            class="teacher-link" style="color: #007bff; text-decoration: none;">
                            {{ session.teacher_name }}
                        </a>
                        {% else %}
                        {{ session.teacher_name }}
                        {% endif %}
                    </td>
                    <td>{{ session.school_name }}</td>
                    <td>{{ session.school_level }}</td>
                    <td>{{ session.district }}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <a href="{{ url_for('events.view_event', id=session.event_id) }}" class="session-title-link"
                                style="flex: 1; color: #007bff; text-decoration: none;">
                                {{ session.session_title }}
                            </a>
                            {% if session.source_host == 'APP' %}
                            <span
                                style="font-size: 0.75em; background: #6f42c1; color: #fff; padding: 2px 6px; border-radius: 10px; white-space: nowrap;">
                                APP
                            </span>
                            {% if current_user.is_admin %}
                            <button type="button" class="edit-session-btn"
                                onclick="openEditVirtualModal({{ session.event_id }})"
                                style="background: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; white-space: nowrap;"
                                title="Edit this session">
                                ‚úèÔ∏è Edit
                            </button>
                            <button type="button" class="delete-session-btn"
                                onclick="deleteVirtualSession({{ session.event_id }})"
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; white-space: nowrap;"
                                title="Delete this session">
                                üóëÔ∏è Delete
                            </button>
                            {% endif %}
                            {% endif %}
                            {% if session.session_link %}
                            <a href="{{ session.session_link }}" target="_blank" class="session-external-btn"
                                style="background: #28a745; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 0.8em; white-space: nowrap;"
                                title="Go to session website">
                                üîó Link
                            </a>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if session.presenter_data %}
                        {% for presenter in session.presenter_data %}
                        <a href="{{ url_for('volunteers.view_volunteer', id=presenter.id) }}" class="presenter-link"
                            style="color: #007bff; text-decoration: none;">
                            {{ presenter.name }}
                        </a>
                        {% if presenter.is_local %}
                        <i class="fa-solid fa-location-dot" title="Local (KS/MO)"
                            style="color: #28a745; margin-left: 4px;"></i>
                        {% endif %}
                        {% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% else %}
                        {{ session.presenter }}
                        {% endif %}
                    </td>
                    <td>{{ session.presenter_organization if session.presenter_organization else "" }}</td>
                    <td>{{ session.topic_theme }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Pagination Controls -->
    <div class="pagination-bar-wrapper"
        style="margin-top: 20px; display: flex; flex-direction: column; align-items: center;">
        <div style="width: 100%; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
            <form method="get" class="pagination-perpage">
                {% for key, value in request.args.items() %}
                {% if key != 'per_page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
                {% endfor %}
                <label for="per_page">Rows per page:</label>
                <select name="per_page" id="per_page" onchange="this.form.submit()">
                    {% for n in [10, 25, 50, 100] %}
                    <option value="{{ n }}" {% if pagination.per_page==n %}selected{% endif %}>{{ n }}</option>
                    {% endfor %}
                </select>
            </form>
            <div class="pagination-info">
                Showing {{ (pagination.current_page-1)*pagination.per_page + 1 }}
                - {{ [pagination.current_page*pagination.per_page, pagination.total_records]|min }}
                of {{ pagination.total_records }} records
            </div>
        </div>
        <nav aria-label="Pagination" class="pagination-bar">
            {% set page = pagination.current_page %}
            {% set total = pagination.total_pages %}
            {% set args = request.args.to_dict() %}
            {# Prev #}
            {% set args_prev = args.copy() %}
            {% set _ = args_prev.update({'page': page-1}) %}
            <a href="?{{ args_prev|urlencode }}" class="page-btn{% if page == 1 %} disabled{% endif %}" {% if page==1
                %}tabindex="-1" aria-disabled="true" {% endif %}>Prev</a>
            {# Page numbers with ellipsis #}
            {% set window = 2 %}
            {% for p in range(1, total+1) %}
            {% if p == 1 or p == total or (p >= page-window and p <= page+window) %} {% set args_p=args.copy() %} {% set
                _=args_p.update({'page': p}) %} <a href="?{{ args_p|urlencode }}"
                class="page-btn{% if p == page %} active{% endif %}">{{ p }}</a>
                {% elif p == 2 and page-window > 2 %}
                <span class="page-ellipsis">‚Ä¶</span>
                {% elif p == total-1 and page+window < total-1 %} <span class="page-ellipsis">‚Ä¶</span>
                    {% endif %}
                    {% endfor %}
                    {# Next #}
                    {% set args_next = args.copy() %}
                    {% set _ = args_next.update({'page': page+1}) %}
                    <a href="?{{ args_next|urlencode }}" class="page-btn{% if page == total %} disabled{% endif %}" {%
                        if page==total %}tabindex="-1" aria-disabled="true" {% endif %}>Next</a>
        </nav>
    </div>
    {% else %}
    <div class="no-data">
        No virtual session data available for the selected filters.
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle column header clicks for sorting
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', function () {
                const column = this.dataset.column;
                const currentSort = '{{ current_filters.sort }}';
                const currentOrder = '{{ current_filters.order }}';
                let newOrder = 'asc';
                if (column === currentSort && currentOrder === 'asc') {
                    newOrder = 'desc';
                }
                // Build new URL with sorting parameters, preserving filters and pagination
                const url = new URL(window.location);
                url.searchParams.set('sort', column);
                url.searchParams.set('order', newOrder);
                url.searchParams.set('page', 1); // Reset to first page on sort
                window.location.href = url.toString();
            });
        });
    });
</script>
{% endblock %}
