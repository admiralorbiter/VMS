{#
Salesforce Import Dashboard Template
===================================

Dedicated dashboard for managing all Salesforce data imports.
Organized by import frequency with delta sync controls and progress tracking.
#}

{% extends "base.html" %}
{% block title %}Salesforce Import Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    .import-dashboard {
        background: linear-gradient(135deg, #f0f9ff 0%, #e8f4f8 100%);
        min-height: 100vh;
        padding: 2rem;
    }

    .dashboard-header {
        background: white;
        border-radius: 12px;
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .dashboard-header h1 {
        color: #1a5276;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .dashboard-header h1 i {
        color: #3498db;
    }

    .last-sync-global {
        background: #f8f9fa;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #666;
    }

    .last-sync-global .sync-time {
        font-weight: 600;
        color: #1a5276;
    }

    .sync-section {
        margin-bottom: 2rem;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding-left: 0.5rem;
    }

    .section-header h3 {
        color: #2c3e50;
        font-weight: 600;
        margin: 0;
        font-size: 1.1rem;
    }

    .section-header i {
        color: #3498db;
    }

    .import-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }

    .import-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
    }

    .import-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .import-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .import-card-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .import-card-title h5 {
        margin: 0;
        font-weight: 600;
        color: #2c3e50;
        font-size: 1rem;
    }

    .import-card-title i {
        color: #3498db;
        font-size: 1.1rem;
    }

    .delta-toggle {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
        color: #666;
        cursor: pointer;
    }

    .delta-toggle input {
        width: 14px;
        height: 14px;
        cursor: pointer;
    }

    .import-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .last-sync-info {
        font-size: 0.75rem;
        color: #888;
    }

    .last-sync-info .sync-status {
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .sync-status.success {
        background: #d4edda;
        color: #155724;
    }

    .sync-status.partial {
        background: #fff3cd;
        color: #856404;
    }

    .sync-status.failed {
        background: #f8d7da;
        color: #721c24;
    }

    .dependency-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.7rem;
        color: #6c757d;
        background: #f8f9fa;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
    }

    .dependency-badge i {
        font-size: 0.65rem;
    }

    .import-btn {
        width: 100%;
        padding: 0.6rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }

    .import-btn-primary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border: none;
        color: white;
    }

    .import-btn-primary:hover:not(:disabled) {
        background: linear-gradient(135deg, #2980b9 0%, #1a5276 100%);
        transform: translateY(-1px);
    }

    .import-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .import-progress {
        margin-top: 0.75rem;
        display: none;
    }

    .import-progress.active {
        display: block;
    }

    .progress {
        height: 6px;
        border-radius: 3px;
        background: #e9ecef;
        overflow: hidden;
    }

    .progress-bar {
        background: linear-gradient(90deg, #3498db 0%, #2ecc71 100%);
        transition: width 0.3s ease;
    }

    .import-status {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.5rem;
        min-height: 1.2rem;
    }

    .import-status.success {
        color: #155724;
    }

    .import-status.error {
        color: #721c24;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .btn-history {
        background: #6c757d;
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-history:hover {
        background: #5a6268;
        color: white;
    }

    .btn-back {
        background: #e9ecef;
        border: none;
        color: #495057;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-back:hover {
        background: #dee2e6;
        color: #495057;
    }

    /* Toast Container */
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .toast {
        background: white;
        padding: 1rem 1.25rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideIn 0.3s ease;
        min-width: 280px;
    }

    .toast.success {
        border-left: 4px solid #28a745;
    }

    .toast.error {
        border-left: 4px solid #dc3545;
    }

    .toast i {
        font-size: 1.25rem;
    }

    .toast.success i {
        color: #28a745;
    }

    .toast.error i {
        color: #dc3545;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* History Modal */
    .history-modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        display: none;
    }

    .history-modal-backdrop.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .history-modal {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 900px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .history-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    .history-modal-header h4 {
        margin: 0;
        font-weight: 600;
    }

    .history-modal-body {
        padding: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    .history-table {
        width: 100%;
        font-size: 0.85rem;
    }

    .history-table th {
        background: #f8f9fa;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        color: #495057;
    }

    .history-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }

    .btn-close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="import-dashboard">
    <div class="container-fluid">
        <!-- Header -->
        <div class="dashboard-header">
            <h1>
                <i class="fab fa-salesforce"></i>
                Salesforce Data Sync
            </h1>
            <div class="header-actions">
                <a href="{{ url_for('management.admin') }}" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Back to Admin
                </a>
                <button class="btn-history" onclick="openHistoryModal()">
                    <i class="fas fa-history"></i> Sync History
                </button>
            </div>
        </div>

        <!-- Daily/Weekly Imports Section -->
        <div class="sync-section">
            <div class="section-header">
                <i class="fas fa-calendar-day"></i>
                <h3>Daily/Weekly Imports</h3>
            </div>
            <div class="import-grid">
                <!-- Organizations -->
                <div class="import-card" data-import-type="organizations">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-building"></i>
                            <h5>Organizations</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('organizations') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['organizations'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['organizations'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['organizations'].status }}">{{
                                last_syncs['organizations'].status }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('organizations')">
                        <i class="fas fa-cloud-download-alt"></i> Import Organizations
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- Volunteers -->
                <div class="import-card" data-import-type="volunteers">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-users"></i>
                            <h5>Volunteers</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('volunteers') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['volunteers'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['volunteers'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['volunteers'].status }}">{{
                                last_syncs['volunteers'].status }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                        <span class="dependency-badge"><i class="fas fa-link"></i> Requires: Organizations</span>
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('volunteers')">
                        <i class="fas fa-cloud-download-alt"></i> Import Volunteers
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- Affiliations -->
                <div class="import-card" data-import-type="affiliations">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-link"></i>
                            <h5>Affiliations</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('affiliations') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['affiliations'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['affiliations'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['affiliations'].status }}">{{
                                last_syncs['affiliations'].status }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                        <span class="dependency-badge"><i class="fas fa-link"></i> Requires: Organizations,
                            Volunteers</span>
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('affiliations')">
                        <i class="fas fa-cloud-download-alt"></i> Import Affiliations
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- Events -->
                <div class="import-card" data-import-type="events">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-calendar-alt"></i>
                            <h5>Events</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('events') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['events'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['events'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['events'].status }}">{{ last_syncs['events'].status
                                }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                        <span class="dependency-badge"><i class="fas fa-link"></i> Requires: Organizations, Schools,
                            Teachers</span>
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('events')">
                        <i class="fas fa-cloud-download-alt"></i> Import Events
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- History -->
                <div class="import-card" data-import-type="history">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-history"></i>
                            <h5>History</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('history') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['history'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['history'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['history'].status }}">{{ last_syncs['history'].status
                                }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                        <span class="dependency-badge"><i class="fas fa-link"></i> Requires: Events, Volunteers,
                            Students</span>
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('history')">
                        <i class="fas fa-cloud-download-alt"></i> Import History
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- Virtual Events (link) -->
                <div class="import-card" data-import-type="virtual">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-video"></i>
                            <h5>Virtual Events</h5>
                        </div>
                    </div>
                    <div class="import-meta">
                        <span class="last-sync-info">Managed via Google Sheets</span>
                    </div>
                    <a href="{{ url_for('management.google_sheets') }}" class="import-btn import-btn-primary"
                        style="text-decoration: none;">
                        <i class="fas fa-external-link-alt"></i> Manage Virtual Event Sheets
                    </a>
                </div>
            </div>
        </div>

        <!-- Quarterly Imports Section -->
        <div class="sync-section">
            <div class="section-header">
                <i class="fas fa-calendar-week"></i>
                <h3>Quarterly Imports</h3>
            </div>
            <div class="import-grid">
                <!-- Schools -->
                <div class="import-card" data-import-type="schools">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-school"></i>
                            <h5>Schools</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('schools') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['schools'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['schools'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['schools'].status }}">{{ last_syncs['schools'].status
                                }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('schools')">
                        <i class="fas fa-cloud-download-alt"></i> Import Schools
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- Classes -->
                <div class="import-card" data-import-type="classes">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-chalkboard"></i>
                            <h5>Classes</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('classes') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['classes'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['classes'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['classes'].status }}">{{ last_syncs['classes'].status
                                }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                        <span class="dependency-badge"><i class="fas fa-link"></i> Requires: Schools</span>
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('classes')">
                        <i class="fas fa-cloud-download-alt"></i> Import Classes
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- Teachers -->
                <div class="import-card" data-import-type="teachers">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <h5>Teachers</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('teachers') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['teachers'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['teachers'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['teachers'].status }}">{{
                                last_syncs['teachers'].status }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                        <span class="dependency-badge"><i class="fas fa-link"></i> Requires: Schools</span>
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('teachers')">
                        <i class="fas fa-cloud-download-alt"></i> Import Teachers
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- Students -->
                <div class="import-card" data-import-type="students">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-user-graduate"></i>
                            <h5>Students</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('students') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['students'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['students'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['students'].status }}">{{
                                last_syncs['students'].status }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                        <span class="dependency-badge"><i class="fas fa-link"></i> Requires: Schools, Classes,
                            Teachers</span>
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('students')">
                        <i class="fas fa-cloud-download-alt"></i> Import Students
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- Student Participations -->
                <div class="import-card" data-import-type="student_participations">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-user-check"></i>
                            <h5>Student Participations</h5>
                        </div>
                        <label class="delta-toggle">
                            <input type="checkbox" class="delta-checkbox" checked>
                            <span>Delta</span>
                        </label>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('student_participations') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['student_participations'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['student_participations'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['student_participations'].status }}">{{
                                last_syncs['student_participations'].status }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                        <span class="dependency-badge"><i class="fas fa-link"></i> Requires: Events, Students</span>
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('student_participations')">
                        <i class="fas fa-cloud-download-alt"></i> Sync Participations
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>

                <!-- Sync Unaffiliated Events -->
                <div class="import-card" data-import-type="unaffiliated_events">
                    <div class="import-card-header">
                        <div class="import-card-title">
                            <i class="fas fa-sitemap"></i>
                            <h5>Sync Unaffiliated Events</h5>
                        </div>
                    </div>
                    <div class="import-meta">
                        {% if last_syncs.get('unaffiliated_events') %}
                        <span class="last-sync-info">
                            Last: {{ last_syncs['unaffiliated_events'].completed_at.strftime('%m/%d %H:%M') if
                            last_syncs['unaffiliated_events'].completed_at else 'N/A' }}
                            <span class="sync-status {{ last_syncs['unaffiliated_events'].status }}">{{
                                last_syncs['unaffiliated_events'].status }}</span>
                        </span>
                        {% else %}
                        <span class="last-sync-info">Never synced</span>
                        {% endif %}
                        <span class="dependency-badge"><i class="fas fa-link"></i> Requires: Events, Students</span>
                    </div>
                    <button class="import-btn import-btn-primary" onclick="runImport('unaffiliated_events')">
                        <i class="fas fa-sync"></i> Sync Affiliations
                    </button>
                    <div class="import-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="import-status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="history-modal-backdrop" id="historyModal" onclick="closeHistoryModal(event)">
    <div class="history-modal" onclick="event.stopPropagation()">
        <div class="history-modal-header">
            <h4><i class="fas fa-history"></i> Sync History</h4>
            <button class="btn-close-modal" onclick="closeHistoryModal()">&times;</button>
        </div>
        <div class="history-modal-body">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Started</th>
                        <th>Completed</th>
                        <th>Status</th>
                        <th>Processed</th>
                        <th>Failed</th>
                        <th>Delta</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="7" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
    // Import URL mapping
    const IMPORT_URLS = {
        'organizations': '/organizations/import-from-salesforce',
        'volunteers': '/volunteers/import-from-salesforce',
        'affiliations': '/organizations/import-affiliations-from-salesforce',
        'events': '/events/import-from-salesforce',
        'history': '/history/import-from-salesforce',
        'schools': '/management/import-schools',
        'classes': '/management/import-classes',
        'teachers': '/teachers/import-from-salesforce',
        'students': '/students/import-from-salesforce',
        'student_participations': '/events/sync-student-participants',
        'unaffiliated_events': '/pathway-events/sync-unaffiliated-events'
    };

    // Run an import
    async function runImport(importType) {
        const card = document.querySelector(`[data-import-type="${importType}"]`);
        const btn = card.querySelector('.import-btn');
        const status = card.querySelector('.import-status');
        const progress = card.querySelector('.import-progress');
        const progressBar = progress?.querySelector('.progress-bar');
        const deltaCheckbox = card.querySelector('.delta-checkbox');
        const isDelta = deltaCheckbox?.checked ?? true;

        // Confirmation
        if (!confirm(`Are you sure you want to import ${importType} from Salesforce?`)) {
            return;
        }

        btn.disabled = true;
        if (progress) progress.classList.add('active');
        if (progressBar) progressBar.style.width = '10%';
        status.textContent = `Starting ${importType} import...`;
        status.className = 'import-status';

        try {
            const url = IMPORT_URLS[importType];
            const params = isDelta ? '?delta=true' : '';

            // For chunked imports (students), loop until complete
            const chunkedImports = ['students'];
            if (chunkedImports.includes(importType)) {
                let totalProcessed = 0;
                let totalErrors = 0;
                let nextId = null;
                let chunkNumber = 0;
                let isComplete = false;

                while (!isComplete) {
                    chunkNumber++;
                    status.textContent = `Processing ${importType} chunk ${chunkNumber}... (${totalProcessed} so far)`;

                    // Use same params (including delta) for all chunks
                    // Backend only updates watermark on final chunk
                    const body = nextId ? { last_id: nextId } : {};
                    const response = await fetch(url + params, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || data.error || 'Import failed');
                    }

                    totalProcessed += data.processed_count || 0;
                    totalErrors += data.error_count || 0;
                    nextId = data.next_id;
                    isComplete = data.is_complete || !nextId;

                    // Update progress bar based on chunks
                    const progressPercent = Math.min(90, 10 + (chunkNumber * 20));
                    if (progressBar) progressBar.style.width = `${progressPercent}%`;
                }

                if (progressBar) progressBar.style.width = '100%';
                status.textContent = `Imported ${totalProcessed} ${importType} (${totalErrors} errors)`;
                status.classList.add('success');
                showToast('Success', `Imported ${totalProcessed} ${importType}`, 'success');
            } else {
                // Standard single-call import for other types
                const response = await fetch(url + params, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (progressBar) progressBar.style.width = '90%';

                const data = await response.json();

                if (progressBar) progressBar.style.width = '100%';

                if (data.success) {
                    status.textContent = data.message || `${importType} import completed successfully`;
                    status.classList.add('success');
                    showToast('Success', data.message || `${importType} import completed`, 'success');
                } else {
                    throw new Error(data.message || data.error || 'Import failed');
                }
            }
        } catch (error) {
            status.textContent = `Error: ${error.message}`;
            status.classList.add('error');
            showToast('Error', `Failed to import ${importType}: ${error.message}`, 'error');
        } finally {
            btn.disabled = false;
            // Keep progress bar visible for a moment
            setTimeout(() => {
                if (progress) progress.classList.remove('active');
                if (progressBar) progressBar.style.width = '0%';
            }, 2000);
        }
    }

    // Show toast notification
    function showToast(title, message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <div>
                <strong>${title}</strong>
                <div style="font-size: 0.85rem;">${message}</div>
            </div>
        `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // History modal
    async function openHistoryModal() {
        document.getElementById('historyModal').classList.add('show');
        document.getElementById('historyTableBody').innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

        try {
            const response = await fetch('/admin/salesforce/sync-history');
            const data = await response.json();

            if (data.success && data.logs.length > 0) {
                const rows = data.logs.map(log => `
                    <tr>
                        <td><strong>${log.sync_type}</strong></td>
                        <td>${log.started_at ? new Date(log.started_at).toLocaleString() : '-'}</td>
                        <td>${log.completed_at ? new Date(log.completed_at).toLocaleString() : '-'}</td>
                        <td><span class="sync-status ${log.status}">${log.status}</span></td>
                        <td>${log.records_processed || 0}</td>
                        <td>${log.records_failed || 0}</td>
                        <td>${log.is_delta_sync ? 'âœ“' : '-'}</td>
                    </tr>
                `).join('');
                document.getElementById('historyTableBody').innerHTML = rows;
            } else {
                document.getElementById('historyTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-muted">No sync history found</td></tr>';
            }
        } catch (error) {
            document.getElementById('historyTableBody').innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error loading history: ${error.message}</td></tr>`;
        }
    }

    function closeHistoryModal(event) {
        if (!event || event.target === document.getElementById('historyModal')) {
            document.getElementById('historyModal').classList.remove('show');
        }
    }
</script>
{% endblock %}
