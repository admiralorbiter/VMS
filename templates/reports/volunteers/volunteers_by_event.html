{% extends 'base.html' %}
{% block title %}Volunteers by Event{% endblock %}

{% block extra_css %}
<style>
  /* Override main container constraints for better space usage */
  main {
    max-width: none !important;
    padding: 5px !important;
    margin: 0 !important;
  }

  .report-container {
    max-width: 100%;
    margin: 0;
    padding: 0 5px;
    width: 100%;
  }
  .report-header {
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom: 16px;
  }
  .report-title {
    color:#2c5aa0;
    margin:0;
    font-size: 2rem;
  }
  .filters-card {
    background:#f8f9fa;
    border:1px solid #e5e7eb;
    border-radius:8px;
    padding:16px;
    margin-bottom:16px;
  }
  .event-types {
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    max-height: 200px;
    overflow:auto;
    padding:8px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius:6px;
  }
  .event-pill {
    --bs-btn-padding-y:.15rem;
    --bs-btn-padding-x:.5rem;
    --bs-btn-font-size:.8rem;
    border-radius:16px;
  }
  .btn-check:checked + .event-pill {
    background:#2c5aa0;
    color:#fff;
    border-color:#2c5aa0;
    box-shadow: 0 0 0 .15rem rgba(44,90,160,.25);
  }
  .event-pill:hover {
    border-color:#2c5aa0;
    color:#2c5aa0;
  }
  .export-btn {
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .table-card {
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:8px;
    overflow:hidden;
  }
  .table thead th {
    background:#2c5aa0;
    color:#fff;
    cursor:pointer;
    user-select:none;
    position:relative;
    white-space: nowrap;
    padding: 8px 6px;
    font-size: 0.85rem;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .table thead th:nth-child(1) { width: 18%; }
  .table thead th:nth-child(2) { width: 24%; }
  .table thead th:nth-child(3) { width: 20%; }
  .table thead th:nth-child(4) { width: 18%; }
  .table thead th:nth-child(5) { width: 12%; }
  .table thead th:nth-child(6) { width: 10%; }
  .table thead th:nth-child(7) { width: 8%; }
  .table thead th.sortable::after {
    content:'\2195';
    position:absolute;
    right:10px;
    opacity:.7;
  }
  .table thead th.sort-asc::after {
    content:'\2191';
    opacity:1;
  }
  .table thead th.sort-desc::after {
    content:'\2193';
    opacity:1;
  }

  /* Compact table design to fit all columns without scrolling */
  .table-responsive {
    overflow: visible;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    width: 100%;
  }
  .table {
    margin-bottom: 0;
    width: 100%;
    table-layout: fixed; /* Fixed layout for consistent column widths */
  }
  .table td {
    vertical-align: middle;
    padding: 6px 8px;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .table .cell-name { width: 18%; }
  .table .cell-email { width: 24%; }
  .table .cell-org { width: 20%; }
  .table .cell-skills { width: 18%; white-space: normal; }
  .table .cell-last { width: 12%; text-align: center; }
  .table .cell-last-email { width: 10%; }
  .table .cell-total-volunteer { width: 8%; text-align: center; }

  /* Pagination styles */
  .pagination-info {
    font-size: 0.875rem;
  }

  .pagination .page-link {
    color: #007bff;
    border-color: #dee2e6;
  }

  .pagination .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
  }

  .pagination .page-link:hover {
    color: #0056b3;
    background-color: #e9ecef;
    border-color: #dee2e6;
  }

  .pagination .page-item.disabled .page-link {
    color: #6c757d;
    background-color: #fff;
    border-color: #dee2e6;
  }

  /* Connector icon styling */
  .connector-icon-btn {
    padding: 0.25rem 0.5rem;
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
    font-size: 0.75rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
  }

  .connector-icon-btn:hover {
    background-color: #5a32a3;
    border-color: #5a32a3;
    color: white;
    transform: translateY(-1px);
  }

  .connector-icon-btn i {
    font-size: 0.75rem;
  }

  /* Connector filter checkbox styling */
  .form-check-input[type="checkbox"]:checked {
    background-color: #6f42c1;
    border-color: #6f42c1;
  }

  .form-check-label {
    font-weight: 500;
    color: #495057;
  }

  .form-check-label i {
    color: #6f42c1;
    margin-right: 0.25rem;
  }

  /* Link styling for volunteer and organization names */
  .volunteer-link, .organization-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .volunteer-link:hover, .organization-link:hover {
    color: #0056b3;
    text-decoration: underline;
    transform: translateY(-1px);
  }

  .volunteer-link:visited, .organization-link:visited {
    color: #6f42c1;
  }

  /* Date range checkbox styling */
  #allPastData:checked + label,
  #last2Years:checked + label {
    color: #2c5aa0;
    font-weight: 600;
  }

  .form-check-input:checked {
    background-color: #2c5aa0;
    border-color: #2c5aa0;
  }

  /* Compact form styling */
  .filters-card .row {
    margin-bottom: 0.5rem;
  }

  .filters-card .form-check {
    margin-bottom: 0.25rem;
  }

  .filters-card .form-text {
    margin-top: 0.125rem;
    margin-bottom: 0;
    font-size: 0.75rem;
    line-height: 1.2;
  }

  .filters-card .form-label {
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .filters-card .form-control-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }

  /* Search help styling */
  .search-fields-info {
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  .search-fields-list {
    list-style: none;
    padding-left: 0;
  }

  .search-fields-list li {
    margin-bottom: 0.25rem;
    padding-left: 0.5rem;
  }

  .search-hint {
    margin-top: 0.25rem;
    color: #6c757d;
    font-size: 0.75rem;
  }

  .search-tips {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    border-left: 4px solid #2c5aa0;
  }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
  <div class="report-header">
    <h2 class="report-title"><i class="fa-solid fa-users"></i> Volunteers by Event</h2>
    <a class="btn btn-sm btn-outline-primary export-btn" href="{{ url_for('report.volunteers_by_event_excel', **export_params) }}">
      <i class="fa-solid fa-file-excel"></i> Export Excel
    </a>
  </div>

  <form class="filters-card" method="get" action="{{ url_for('report.volunteers_by_event_report') }}">
    <div class="row g-2 align-items-end">
      <div class="col-lg-1 col-md-3 col-sm-6">
        <div class="form-check mb-1">
          <input class="form-check-input" type="checkbox" name="all_past_data" value="1" id="allPastData" {% if all_past_data %}checked{% endif %}>
          <label class="form-check-label small" for="allPastData">
            <strong>All Past Data</strong>
          </label>
        </div>
        <div class="form-text small">All historical data</div>
      </div>
      <div class="col-lg-1 col-md-3 col-sm-6">
        <div class="form-check mb-1">
          <input class="form-check-input" type="checkbox" name="last_2_years" value="1" id="last2Years" {% if last_2_years %}checked{% endif %}>
          <label class="form-check-label small" for="last2Years">
            <strong>Last 2 Years</strong>
          </label>
        </div>
        <div class="form-text small">Recent data</div>
      </div>
      <div class="col-lg-2 col-md-3 col-sm-6">
        <label class="form-label small">From</label>
        <input type="date" name="date_from" value="{{ date_from }}" class="form-control form-control-sm" {% if all_past_data or last_2_years %}disabled{% endif %}>
      </div>
      <div class="col-lg-2 col-md-3 col-sm-6">
        <label class="form-label small">To</label>
        <input type="date" name="date_to" value="{{ date_to }}" class="form-control form-control-sm" {% if all_past_data or last_2_years %}disabled{% endif %}>
      </div>
      <div class="col-lg-6 col-md-12">
        <div class="form-group">
          <label class="form-label small">Search Volunteers</label>
          <input type="text"
                 id="search"
                 name="search"
                 class="form-control form-control-sm"
                 value="{{ search_query }}"
                 placeholder="Try searching: tech edu (finds volunteers in technology and education)">
          <div class="search-hint small">
            <i class="fas fa-info-circle"></i> Searches names, organizations, skills, event titles, and event types (e.g., "tech edu" finds people in technology OR education)
          </div>
        </div>
      </div>
      <div class="col-lg-6 col-md-12">
        <div class="form-group">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
            <a href="{{ url_for('report.volunteers_by_event_report') }}" class="btn btn-secondary btn-sm">Clear</a>
            <button type="button" id="toggleSearchFields" class="btn btn-outline-info btn-sm" title="Show/hide search field explanations">
              <i class="fas fa-info-circle"></i> Search Help
            </button>

            <!-- Connector filter checkbox -->
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="connector_only" id="connector_only"
                     value="1" {% if connector_only %}checked{% endif %}>
              <label class="form-check-label" for="connector_only">
                <i class="fa-solid fa-plug"></i> Connector Only
              </label>
            </div>

            <!-- Per page selector -->
            <div class="d-flex align-items-center">
              <label for="per_page" class="form-label small mb-0 me-2">Per page:</label>
              <select name="per_page" id="per_page" class="form-select form-select-sm" style="width: auto;">
                <option value="10" {{ 'selected' if request.args.get('per_page', '25') == '10' }}>10</option>
                <option value="25" {{ 'selected' if request.args.get('per_page', '25') == '25' }}>25</option>
                <option value="50" {{ 'selected' if request.args.get('per_page', '25') == '50' }}>50</option>
                <option value="100" {{ 'selected' if request.args.get('per_page', '25') == '100' }}>100</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row g-2 align-items-end mt-2">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-2">
          <label class="form-label mb-0 small">Event Types</label>
          <div class="event-pills-actions d-flex align-items-center">
            <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="btnSelectAll">Select all</button>
            <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="btnClearAll">Clear</button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnDefaults">Defaults</button>
          </div>
        </div>
        <div class="event-types mt-2" id="eventTypePills">
          {% for value, label in type_choices %}
            <input class="btn-check" type="checkbox" name="event_types" value="{{ value }}" id="type_{{ value }}" {% if value in selected_types %}checked{% endif %}>
            <label class="btn btn-outline-secondary event-pill" for="type_{{ value }}" data-label="{{ label|lower }}">{{ label }}</label>
          {% endfor %}
        </div>
      </div>
    </div>
  </form>

  <!-- Search Fields Explanation -->
  <div class="search-fields-info" id="searchFieldsInfo">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-search"></i>
          Search Fields & Capabilities
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6><i class="fas fa-user"></i> Volunteer Information</h6>
            <ul class="search-fields-list">
              <li><strong>First Name</strong> - Exact or partial matches</li>
              <li><strong>Last Name</strong> - Exact or partial matches</li>
              <li><strong>Title/Position</strong> - Job title or role</li>
            </ul>

            <h6><i class="fas fa-building"></i> Organization & Affiliation</h6>
            <ul class="search-fields-list">
              <li><strong>Organization Name</strong> - Company, school, or institution</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6><i class="fas fa-tools"></i> Skills & Expertise</h6>
            <ul class="search-fields-list">
              <li><strong>Skill Names</strong> - Programming, teaching, mentoring, etc.</li>
            </ul>

            <h6><i class="fas fa-calendar"></i> Event Participation</h6>
            <ul class="search-fields-list">
              <li><strong>Event Titles</strong> - Past events the volunteer participated in</li>
              <li><strong>Event Types</strong> - Career Fair, Data Viz, etc.</li>
            </ul>
          </div>
        </div>

        <div class="search-tips mt-3">
          <h6><i class="fas fa-lightbulb"></i> Search Tips</h6>
          <ul class="search-fields-list">
            <li><strong>OR Search:</strong> "tech edu" finds volunteers in technology OR education</li>
            <li><strong>Partial Matches:</strong> "prog" will find "programming", "programmer", etc.</li>
            <li><strong>Multiple Terms:</strong> Use spaces to separate different search concepts</li>
            <li><strong>Organization Search:</strong> Search by company, school, or institution names</li>
            <li><strong>Event Search:</strong> Find volunteers by event titles or event types (Career Fair, Data Viz, etc.)</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="table-card">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Name</th>
            <th class="sortable" data-sort="email">Email</th>
            <th class="sortable" data-sort="organization">Organization</th>
            <th class="sortable" data-sort="skills">Skills</th>
            <th class="sortable" data-sort="last">Last Volunteered</th>
            <th class="sortable" data-sort="last_email">Last Email</th>
            <th class="sortable" data-sort="total_volunteer">Past Events</th>
          </tr>
        </thead>
        <tbody>
          {% for v in volunteers %}
          <tr>
          <td class="cell-name">
            <div class="d-flex align-items-center">
              <a href="{{ url_for('volunteers.view_volunteer', id=v.id) }}" class="volunteer-link me-2">
                {{ v.name }}
              </a>
              {% if v.connector_profile_url %}
                <a href="{{ v.connector_profile_url }}" class="btn btn-sm connector-icon-btn" target="_blank" title="Connector Profile">
                  <i class="fa-solid fa-plug"></i>
                </a>
              {% endif %}
            </div>
          </td>
            <td class="cell-email">{{ v.email }}</td>
            <td class="cell-org">
              {% if v.organization_id %}
                <a href="{{ url_for('organizations.view_organization', id=v.organization_id) }}" class="organization-link">
                  {{ v.organization }}
                </a>
              {% else %}
                {{ v.organization }}
              {% endif %}
            </td>
            <td class="cell-skills">{{ v.skills }}</td>
            <td class="cell-last" data-count="{{ v.future_events_count }}">
              <div>{{ v.last_event_date.strftime('%m/%d/%y') if v.last_event_date }}</div>
              {% if v.future_events_count > 0 %}
                <div class="text-success small">{{ v.future_events_count }} upcoming</div>
              {% endif %}
            </td>
            <td class="cell-last-email">{{ v.last_email_date.strftime('%m/%d/%y') if v.last_email_date }}</td>
            <td class="cell-total-volunteer" data-count="{{ v.total_volunteer_count }}">{{ v.total_volunteer_count }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">No results found for the selected filters.</td>
          </tr>
          {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination Controls -->
{% if pagination and pagination.total_pages > 1 %}
<div class="row mt-3">
  <div class="col-12">
    <nav aria-label="Volunteers pagination">
      <div class="d-flex justify-content-between align-items-center">
        <!-- Results info -->
        <div class="pagination-info">
          <small class="text-muted">
            Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} to
            {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total_count else pagination.total_count }}
            of {{ pagination.total_count }} volunteers
          </small>
        </div>

        <!-- Pagination controls -->
        <ul class="pagination pagination-sm mb-0">
          <!-- Previous button -->
          <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
            <a class="page-link"
               href="{{ url_for('report.volunteers_by_event_report',
                              page=pagination.prev_num,
                              search=search_query,
                              event_types=selected_types,
                              all_past_data=all_past_data,
                              last_2_years=last_2_years,
                              connector_only=connector_only,
                              date_from=date_from,
                              date_to=date_to,
                              sort=sort_by,
                              order=sort_order) if pagination.has_prev else '#' }}"
               aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          <!-- Page numbers -->
          {% set start_page = [1, pagination.page - 2] | max %}
          {% set end_page = [pagination.total_pages, pagination.page + 2] | min %}

          {% if start_page > 1 %}
            <li class="page-item">
              <a class="page-link"
                 href="{{ url_for('report.volunteers_by_event_report',
                                page=1,
                                search=search_query,
                                event_types=selected_types,
                                all_past_data=all_past_data,
                                last_2_years=last_2_years,
                                connector_only=connector_only,
                                date_from=date_from,
                                date_to=date_to,
                                sort=sort_by,
                                order=sort_order) }}">1</a>
            </li>
            {% if start_page > 2 %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
          {% endif %}

          {% for page_num in range(start_page, end_page + 1) %}
            <li class="page-item {{ 'active' if page_num == pagination.page }}">
              <a class="page-link"
                 href="{{ url_for('report.volunteers_by_event_report',
                                page=page_num,
                                search=search_query,
                                event_types=selected_types,
                                all_past_data=all_past_data,
                                last_2_years=last_2_years,
                                connector_only=connector_only,
                                date_from=date_from,
                                date_to=date_to,
                                sort=sort_by,
                                order=sort_order) }}">{{ page_num }}</a>
            </li>
          {% endfor %}

          {% if end_page < pagination.total_pages %}
            {% if end_page < pagination.total_pages - 1 %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            <li class="page-item">
              <a class="page-link"
                 href="{{ url_for('report.volunteers_by_event_report',
                                page=pagination.total_pages,
                                search=search_query,
                                event_types=selected_types,
                                all_past_data=all_past_data,
                                last_2_years=last_2_years,
                                connector_only=connector_only,
                                date_from=date_from,
                                date_to=date_to,
                                sort=sort_by,
                                order=sort_order) }}">{{ pagination.total_pages }}</a>
            </li>
          {% endif %}

          <!-- Next button -->
          <li class="page-item {{ 'disabled' if not pagination.has_next }}">
            <a class="page-link"
               href="{{ url_for('report.volunteers_by_event_report',
                              page=pagination.next_num,
                              search=search_query,
                              event_types=selected_types,
                              all_past_data=all_past_data,
                              last_2_years=last_2_years,
                              connector_only=connector_only,
                              date_from=date_from,
                              date_to=date_to,
                              sort=sort_by,
                              order=sort_order) if pagination.has_next else '#' }}"
               aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>
  </div>
</div>
{% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle date range options (mutually exclusive)
  const allPastDataCheckbox = document.getElementById('allPastData');
  const last2YearsCheckbox = document.getElementById('last2Years');
  const dateFromInput = document.querySelector('input[name="date_from"]');
  const dateToInput = document.querySelector('input[name="date_to"]');

  if (allPastDataCheckbox && last2YearsCheckbox && dateFromInput && dateToInput) {
    function updateDateFields() {
      const allPastChecked = allPastDataCheckbox.checked;
      const last2YearsChecked = last2YearsCheckbox.checked;

      // Disable date fields if either option is checked
      const shouldDisable = allPastChecked || last2YearsChecked;
      dateFromInput.disabled = shouldDisable;
      dateToInput.disabled = shouldDisable;

      // Clear date values when either option is checked
      if (shouldDisable) {
        dateFromInput.value = '';
        dateToInput.value = '';
      }
    }

    function handleAllPastDataChange() {
      if (allPastDataCheckbox.checked) {
        last2YearsCheckbox.checked = false;
      }
      updateDateFields();
    }

    function handleLast2YearsChange() {
      if (last2YearsCheckbox.checked) {
        allPastDataCheckbox.checked = false;
      }
      updateDateFields();
    }

    // Ensure mutual exclusivity on page load
    if (allPastDataCheckbox.checked && last2YearsCheckbox.checked) {
      // If both are checked, default to last_2_years
      allPastDataCheckbox.checked = false;
    }

    // Set initial state
    updateDateFields();

    // Add event listeners
    allPastDataCheckbox.addEventListener('change', handleAllPastDataChange);
    last2YearsCheckbox.addEventListener('change', handleLast2YearsChange);
  }

  // Handle search help toggle
  const toggleButton = document.getElementById('toggleSearchFields');
  const searchFieldsInfo = document.getElementById('searchFieldsInfo');

  if (toggleButton && searchFieldsInfo) {
    // Initially hide the section
    searchFieldsInfo.classList.add('d-none');

    toggleButton.addEventListener('click', function() {
      if (searchFieldsInfo.classList.contains('d-none')) {
        // Show the section
        searchFieldsInfo.classList.remove('d-none');
        // Add a small delay to ensure the element is visible before adding the show class
        setTimeout(() => {
          searchFieldsInfo.classList.add('show');
        }, 10);

        toggleButton.innerHTML = '<i class="fas fa-times-circle"></i> Hide Help';
        toggleButton.classList.remove('btn-outline-info');
        toggleButton.classList.add('btn-info');
      } else {
        // Hide the section
        searchFieldsInfo.classList.remove('show');
        // Wait for the transition to complete before hiding
        setTimeout(() => {
          searchFieldsInfo.classList.add('d-none');
        }, 300);

        toggleButton.innerHTML = '<i class="fas fa-info-circle"></i> Search Help';
        toggleButton.classList.remove('btn-info');
        toggleButton.classList.add('btn-outline-info');
      }
    });
  }

  // Event type pills behavior
  const btnSelectAll = document.getElementById('btnSelectAll');
  const btnClearAll = document.getElementById('btnClearAll');
  const btnDefaults = document.getElementById('btnDefaults');
  const container = document.getElementById('eventTypePills');

  function allInputs(){ return Array.from(container.querySelectorAll('input.btn-check')); }
  if (btnSelectAll) btnSelectAll.addEventListener('click', () => { allInputs().forEach(i => i.checked = true); });
  if (btnClearAll) btnClearAll.addEventListener('click', () => { allInputs().forEach(i => i.checked = false); });
  if (btnDefaults) btnDefaults.addEventListener('click', () => {
    // Select all event types as default
    allInputs().forEach(i => { i.checked = true; });
  });

  // Server-side sorting logic for table
  const table = document.querySelector('.table');
  if (!table) return;
  const headers = table.querySelectorAll('th.sortable');

  // Get current sort parameters from URL
  const urlParams = new URLSearchParams(window.location.search);
  const currentSort = urlParams.get('sort') || 'name';
  const currentOrder = urlParams.get('order') || 'asc';

  headers.forEach(h => {
    h.addEventListener('click', () => {
      const key = h.dataset.sort;
      let newOrder = 'asc';

      // If clicking the same column, toggle order
      if (currentSort === key) {
        newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
      }

      // Build new URL with sort parameters
      const newUrlParams = new URLSearchParams(window.location.search);
      newUrlParams.set('sort', key);
      newUrlParams.set('order', newOrder);
      newUrlParams.set('page', '1'); // Reset to first page when sorting

      // Navigate to new URL
      window.location.href = window.location.pathname + '?' + newUrlParams.toString();
    });
  });

  // Set visual indicators for current sort
  headers.forEach(h => {
    const key = h.dataset.sort;
    if (currentSort === key) {
      h.classList.add(currentOrder === 'asc' ? 'sort-asc' : 'sort-desc');
    }
  });

});
</script>
{% endblock %}
