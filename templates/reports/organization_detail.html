{% extends "base.html" %}

{% block title %}{{ organization.name }} - Organization Report{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/organization_detail.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/organization_reports.js') }}"></script>
{% endblock %}

{% block content %}
<div class="organization-detail-container">
    <!-- Header Section -->
    <div class="detail-header">
        <div class="detail-header-content">
            <div>
                <h1 class="organization-title">{{ organization.name }}</h1>
                <p class="subtitle">Volunteer Engagement Report</p>
            </div>
            <div class="header-controls">
                <a href="{{ url_for('report.organization_reports', school_year=school_year) }}" class="back-link">
                    <i class="fas fa-arrow-left"></i>
                    Back to Organization Reports
                </a>
                <form method="GET" style="margin: 0;">
                    <select name="school_year" class="year-selector" onchange="this.form.submit()">
                        {% for y in school_years %}
                        <option value="{{ y }}" {% if y == school_year %}selected{% endif %}>
                            {{ y[:2] }}-{{ y[2:] }} School Year
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>
    </div>

    <!-- Cache Info Panel -->
    {% if cache_is_fresh is defined %}
    <div class="cache-info">
        <div class="cache-status">
            {% if cache_is_fresh %}
                <span class="cache-fresh">âš¡ Using cached data</span>
                {% if last_updated %}
                    <span>â€¢ Last updated: {{ last_updated.strftime('%m/%d/%y %I:%M %p') }}</span>
                {% endif %}
            {% else %}
                <span class="cache-refreshed">ðŸ”„ Data refreshed</span>
            {% endif %}
        </div>
        <button onclick="refreshDetailData()" data-org-id="{{ organization.id }}" class="refresh-btn">
            Refresh Data
        </button>
        <a href="{{ url_for('report.export_organization_detail_excel', org_id=organization.id, school_year=school_year) }}" 
           class="refresh-btn export-btn" style="margin-left: 0.5rem;">
            <i class="fas fa-file-excel"></i> Export Excel
        </a>
    </div>
    {% endif %}

    <!-- Tip Section -->
    <div class="tip-section">
        <div class="tip-content">
            <strong>Tip:</strong> Click on any column header in the tables below to sort by that column. Click again to reverse the sort order.
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="summary-grid">
        <div class="stat-card">
            <div class="stat-number">{{ summary.total_volunteers }}</div>
            <div class="stat-label">{{ organization.name }} volunteers engaged</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ summary.total_in_person_events }}</div>
            <div class="stat-label">in-person experiences</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ summary.total_in_person_students }}</div>
            <div class="stat-label">students reached</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ summary.total_virtual_events }}</div>
            <div class="stat-label">virtual sessions</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ summary.total_virtual_classrooms }}</div>
            <div class="stat-label">classrooms reached</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ summary.total_cancelled_events }}</div>
            <div class="stat-label">cancelled events</div>
        </div>
    </div>

    <!-- In-person experiences -->
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-users"></i>
            In-person experiences
        </h2>
    </div>
    
    {% if in_person_events %}
    <div class="section-subtitle">
        <strong>Total:</strong> {{ summary.total_in_person_events }} in-person sessions reaching {{ summary.total_in_person_students }} students.
    </div>
    
    <div class="enhanced-table-container">
        <table class="enhanced-table">
            <thead>
                <tr>
                    <th class="sortable {% if sort_by == 'students' %}active {{ sort_order }}{% endif %}" data-sort="students">No. students reached</th>
                    <th class="sortable {% if sort_by == 'date' %}active {{ sort_order }}{% endif %}" data-sort="date">Date</th>
                    <th class="sortable {% if sort_by == 'volunteer' %}active {{ sort_order }}{% endif %}" data-sort="volunteer">Volunteer</th>
                    <th>Session</th>
                    <th class="sortable {% if sort_by == 'event_type' %}active {{ sort_order }}{% endif %}" data-sort="event_type">Event Type</th>
                </tr>
            </thead>
            <tbody>
                {% for event in in_person_events %}
                <tr>
                    <td><strong>{{ event.students_reached }}</strong></td>
                    <td>{{ event.date }}</td>
                    <td>
                        {% if event.volunteer_id %}
                        <a href="{{ url_for('volunteers.view_volunteer', id=event.volunteer_id) }}">
                            {{ event.volunteer }}
                        </a>
                        {% else %}
                        {{ event.volunteer }}
                        {% endif %}
                    </td>
                    <td>
                        {% if event.event_id %}
                        <a href="{{ url_for('events.view_event', id=event.event_id) }}">
                            {{ event.session }}
                        </a>
                        {% else %}
                        {{ event.session }}
                        {% endif %}
                    </td>
                    <td><span class="badge badge-primary">{{ event.event_type }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ“‹</div>
        <div class="empty-state-message">No in-person events found for this organization in the selected time period.</div>
    </div>
    {% endif %}

    <!-- Virtual experiences -->
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-video"></i>
            Virtual experiences
        </h2>
    </div>
    
    {% if virtual_events %}
    <div class="section-subtitle virtual">
        <strong>Total:</strong> {{ summary.total_virtual_events }} virtual sessions reaching approximately {{ summary.total_virtual_classrooms }} students.<br>
        <strong>Note:</strong> Virtual events include Virtual Sessions, Connector Sessions, Data Visualization, and other remote learning activities. Includes completed sessions even when there was a teacher no-show.
    </div>
    
    <div class="enhanced-table-container">
        <table class="enhanced-table">
            <thead>
                <tr>
                    <th class="sortable {% if sort_by == 'date' %}active {{ sort_order }}{% endif %}" data-sort="date">Date</th>
                    <th>Time</th>
                    <th class="sortable {% if sort_by == 'students' %}active {{ sort_order }}{% endif %}" data-sort="students">No. students</th>
                    <th>Session Name</th>
                    <th class="sortable {% if sort_by == 'volunteer' %}active {{ sort_order }}{% endif %}" data-sort="volunteer">Volunteer</th>
                    <th class="sortable {% if sort_by == 'event_type' %}active {{ sort_order }}{% endif %}" data-sort="event_type">Event Type</th>
                    <th>Session ID</th>
                </tr>
            </thead>
            <tbody>
                {% for event in virtual_events %}
                <tr>
                    <td>{{ event.date }}</td>
                    <td>{{ event.time }}</td>
                    <td><strong>{{ event.classrooms }}</strong></td>
                    <td>
                        {% if event.event_id %}
                        <a href="{{ url_for('events.view_event', id=event.event_id) }}">
                            {{ event.session }}
                        </a>
                        {% else %}
                        {{ event.session }}
                        {% endif %}
                    </td>
                    <td>
                        {% if event.volunteer_id %}
                        <a href="{{ url_for('volunteers.view_volunteer', id=event.volunteer_id) }}">
                            {{ event.volunteer }}
                        </a>
                        {% else %}
                        {{ event.volunteer }}
                        {% endif %}
                    </td>
                    <td><span class="badge badge-info">{{ event.event_type }}</span></td>
                    <td><code>{{ event.session_id }}</code></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ’»</div>
        <div class="empty-state-message">No virtual events found for this organization in the selected time period.</div>
    </div>
    {% endif %}

    <!-- Volunteers for cancelled events -->
    {% if cancelled_events %}
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-exclamation-triangle"></i>
            Volunteers for cancelled events
        </h2>
    </div>
    
    <div class="enhanced-table-container">
        <table class="enhanced-table">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Volunteer Name</th>
                    <th>Cancellation Reason</th>
                </tr>
            </thead>
            <tbody>
                {% for event in cancelled_events %}
                <tr>
                    <td>
                        {% if event.event_id %}
                        <a href="{{ url_for('events.view_event', id=event.event_id) }}">
                            {{ event.event }}
                        </a>
                        {% else %}
                        {{ event.event }}
                        {% endif %}
                    </td>
                    <td>
                        {% if event.volunteer_id %}
                        <a href="{{ url_for('volunteers.view_volunteer', id=event.volunteer_id) }}">
                            {{ event.volunteer }}
                        </a>
                        {% else %}
                        {{ event.volunteer }}
                        {% endif %}
                    </td>
                    <td><span class="badge badge-warning">{{ event.cancellation_reason }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Volunteer Summary -->
    {% if volunteers %}
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-chart-bar"></i>
            Volunteer Summary
        </h2>
    </div>
    
    <div class="enhanced-table-container">
        <table class="enhanced-table">
            <thead>
                <tr>
                    <th>Volunteer Name</th>
                    <th>Number of Events</th>
                    <th>Total Hours</th>
                </tr>
            </thead>
            <tbody>
                {% for volunteer in volunteers %}
                <tr>
                    <td><strong>{{ volunteer.name }}</strong></td>
                    <td><span class="badge badge-success">{{ volunteer.events }}</span></td>
                    <td><strong>{{ volunteer.hours }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Report Summary -->
    <div class="report-summary">
        <div class="section-header" style="margin: 0 0 1.5rem 0; box-shadow: none; background: transparent; padding: 0;">
            <h2 class="section-title">
                <i class="fas fa-file-alt"></i>
                Report Summary
            </h2>
        </div>
        <div class="summary-content">
            <p><strong>Total:</strong> <span class="summary-highlight">{{ summary.total_volunteers }} {{ organization.name }} volunteers</span> led <span class="summary-highlight">{{ summary.total_in_person_events + summary.total_virtual_events }} sessions</span> reaching approximately <span class="summary-highlight">{{ summary.total_in_person_students + summary.total_virtual_classrooms }} students</span>.</p>
            
            {% if summary.total_cancelled_events > 0 %}
            <p style="margin-top: 1rem;"><strong>Note:</strong> <span class="summary-highlight">{{ summary.total_cancelled_events }} event(s)</span> were cancelled during this time period.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
function refreshDetailData() {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Refreshing...';
    button.disabled = true;
    
    const schoolYear = new URLSearchParams(window.location.search).get('school_year') || '{{ school_year }}';
    
    fetch(`{{ url_for('report.refresh_organization_detail', org_id=0) }}`.replace('0', button.getAttribute('data-org-id')) + `?school_year=${schoolYear}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show fresh data
            window.location.reload();
        } else {
            alert('Error refreshing data: ' + data.error);
            button.textContent = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        alert('Error refreshing data: ' + error);
        button.textContent = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %} 