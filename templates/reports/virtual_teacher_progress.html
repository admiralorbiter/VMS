{% extends "base.html" %}

{% block title %}{{ district_name }} - Teacher Progress Tracking{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reports.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/virtual_usage.css') }}">
<style>
/* Updated: 2025-09-09 - Mustard yellow for in-progress status */
.teacher-progress-container {
    max-width: 98vw;
    margin: 0 auto;
    padding: 8px 8px 20px 8px;
}

.district-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 30px;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.back-link {
    color: white;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
    font-weight: 500;
}

.back-link:hover {
    color: #f0f0f0;
    text-decoration: underline;
}

.district-title {
    margin: 0 0 10px 0;
    font-size: 2.5em;
    font-weight: 700;
}

.district-subtitle {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1em;
}

.progress-description {
    background: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    color: #155724;
}

.progress-description h3 {
    margin: 0 0 10px 0;
    color: #155724;
    font-size: 1.2em;
}

.progress-description p {
    margin: 0;
    line-height: 1.5;
}

.filters-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.filters-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: 600;
    color: #333;
    font-size: 0.9em;
}

.filter-group select,
.filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.filter-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    grid-column: 1 / -1;
    margin-top: 15px;
}

.filter-btn, .reset-btn {
    padding: 10px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-align: center;
    white-space: nowrap;
    font-size: 14px;
    transition: all 0.2s ease;
}

.filter-btn {
    background: #28a745;
    color: white;
}

.filter-btn:hover {
    background: #218838;
    color: white;
    text-decoration: none;
}

.reset-btn {
    background: #dc3545;
    color: white;
}

.reset-btn:hover {
    background: #c82333;
    color: white;
    text-decoration: none;
}

.teacher-progress-table {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 30px;
    width: 100%;
}

.progress-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.progress-table th {
    background: #f8f9fa;
    padding: 15px 10px;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
    border-right: 1px solid #dee2e6;
    vertical-align: top;
    position: sticky;
    top: 0;
    z-index: 10;
}

.progress-table th:last-child {
    border-right: none;
}

.school-header {
    text-align: center;
    font-size: 1em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 20px 10px;
    background: #28a745;
    color: white;
}

.school-stats {
    font-size: 0.8em;
    font-weight: normal;
    opacity: 0.9;
    margin-top: 5px;
}

.progress-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #dee2e6;
    border-right: 1px solid #dee2e6;
    vertical-align: top;
}

.progress-table td:last-child {
    border-right: none;
}

.teacher-cell {
    min-height: 40px;
    background: #fafafa;
}

.teacher-name {
    font-weight: 500;
    margin-bottom: 2px;
}

.teacher-link {
    color: #28a745;
    text-decoration: none;
}

.teacher-link:hover {
    color: #218838;
    text-decoration: underline;
}

.progress-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 5px;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #28a745;
    transition: width 0.3s ease;
}

.progress-fill.warning {
    background: #ffc107;
}

.progress-fill.danger {
    background: #dc3545;
}

.progress-text {
    font-size: 0.8em;
    font-weight: 600;
    color: #495057;
    min-width: 50px;
    text-align: right;
}

.goal-status {
    font-size: 0.8em;
    font-weight: 600;
    margin-top: 2px;
    padding: 2px 6px;
    border-radius: 3px;
    display: inline-block;
}

.goal-status.achieved {
    background: #d4edda;
    color: #155724;
}

.goal-status.in-progress {
    background: #ffd700 !important;
    color: #8b4513 !important;
}

/* More specific selector to override any conflicts */
.teacher-progress-container .goal-status.in-progress {
    background: #ffd700 !important;
    color: #8b4513 !important;
    border: 1px solid #b8860b !important;
}

.goal-status.not-started {
    background: #f8d7da;
    color: #721c24;
}

.no-data {
    text-align: center;
    padding: 60px 20px;
    color: #666;
    font-size: 1.1em;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.setup-message {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    color: #856404;
}

.setup-message h3 {
    margin: 0 0 10px 0;
    color: #856404;
    font-size: 1.2em;
}

.setup-message p {
    margin: 0;
    line-height: 1.5;
}

@media (max-width: 768px) {
    .progress-table {
        font-size: 12px;
    }

    .progress-table th,
    .progress-table td {
        padding: 6px 8px;
    }

    .school-header {
        font-size: 0.9em;
        padding: 15px 8px;
    }

    .filters-form {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="teacher-progress-container">
    <div class="district-header">
        <a href="{{ url_for('report.virtual_usage_district', district_name=district_name, year=current_filters.year) }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to District Report
        </a>
        <h1 class="district-title">{{ district_name }}</h1>
        <p class="district-subtitle">Teacher Progress Tracking - Virtual Year: {{ current_filters.year }}</p>
        <p class="district-subtitle">Date Range: {{ current_filters.date_from.strftime('%Y-%m-%d') }} to {{ current_filters.date_to.strftime('%Y-%m-%d') }}</p>
    </div>

    <!-- Description Section -->
    <div class="progress-description">
        <h3>Teacher Progress Tracking</h3>
        <p>This view tracks the progress of specific teachers in Kansas City Kansas Public Schools to ensure district goals are being met. Teachers are tracked by school and their completion status is monitored against predefined targets.</p>
        <p style="margin-top: 15px;">
            <a href="{{ url_for('report.virtual_teacher_progress_google_sheets', district_name=district_name, year=current_filters.year) }}"
               style="color: #155724; font-weight: 600; text-decoration: underline;">
                <i class="fas fa-cog"></i> Manage Google Sheets & Import Data
            </a>
        </p>
    </div>

    <!-- Filter Section -->
    <div class="filters-section">
        <form class="filters-form" method="GET">
            <div class="filter-group">
                <label for="year">Virtual Year:</label>
                <select id="year" name="year">
                    {% for virtual_year in virtual_year_options %}
                        <option value="{{ virtual_year }}" {% if virtual_year == current_filters.year %}selected{% endif %}>
                            {{ virtual_year }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="date_from">From:</label>
                <input type="date" id="date_from" name="date_from"
                       value="{{ current_filters.date_from.strftime('%Y-%m-%d') if current_filters.date_from }}">
            </div>
            <div class="filter-group">
                <label for="date_to">To:</label>
                <input type="date" id="date_to" name="date_to"
                       value="{{ current_filters.date_to.strftime('%Y-%m-%d') if current_filters.date_to }}">
            </div>
            <div class="filter-actions">
                <button type="submit" class="filter-btn">Apply Filters</button>
                <a href="{{ url_for('report.virtual_district_teacher_progress', district_name=district_name) }}"
                   class="reset-btn">Reset</a>
            </div>
        </form>
    </div>

    {% if teacher_progress_data %}
        <!-- Summary Section -->
        {% set total_teachers = teacher_progress_data.values() | map(attribute='total_teachers') | sum %}
        {% set total_achieved = teacher_progress_data.values() | map(attribute='goals_achieved') | sum %}
        {% set total_in_progress = teacher_progress_data.values() | map(attribute='goals_in_progress') | sum %}
        {% set total_not_started = teacher_progress_data.values() | map(attribute='goals_not_started') | sum %}

        <div class="summary-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card" style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); text-align: center; border-left: 4px solid #28a745;">
                <span class="stat-value" style="display: block; font-size: 2.5em; font-weight: 700; color: #28a745; margin-bottom: 5px;">
                    {{ teacher_progress_data|length }}
                </span>
                <span class="stat-label" style="color: #666; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">
                    Schools
                </span>
            </div>
            <div class="stat-card" style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); text-align: center; border-left: 4px solid #007bff;">
                <span class="stat-value" style="display: block; font-size: 2.5em; font-weight: 700; color: #007bff; margin-bottom: 5px;">
                    {{ total_teachers }}
                </span>
                <span class="stat-label" style="color: #666; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">
                    Total Teachers
                </span>
            </div>
            <div class="stat-card" style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); text-align: center; border-left: 4px solid #28a745;">
                <span class="stat-value" style="display: block; font-size: 2.5em; font-weight: 700; color: #28a745; margin-bottom: 5px;">
                    {{ total_achieved }}
                </span>
                <span class="stat-percentage" style="display: block; font-size: 1.2em; font-weight: 600; color: #28a745; margin-bottom: 5px;">
                    {{ "%.1f"|format((total_achieved / total_teachers * 100) if total_teachers > 0 else 0) }}%
                </span>
                <span class="stat-label" style="color: #666; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">
                    Goals Achieved
                </span>
            </div>
            <div class="stat-card" style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); text-align: center; border-left: 4px solid #ffd700;">
                <span class="stat-value" style="display: block; font-size: 2.5em; font-weight: 700; color: #ffd700; margin-bottom: 5px;">
                    {{ total_in_progress }}
                </span>
                <span class="stat-percentage" style="display: block; font-size: 1.2em; font-weight: 600; color: #ffd700; margin-bottom: 5px;">
                    {{ "%.1f"|format((total_in_progress / total_teachers * 100) if total_teachers > 0 else 0) }}%
                </span>
                <span class="stat-label" style="color: #666; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">
                    In Progress
                </span>
            </div>
            <div class="stat-card" style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); text-align: center; border-left: 4px solid #dc3545;">
                <span class="stat-value" style="display: block; font-size: 2.5em; font-weight: 700; color: #dc3545; margin-bottom: 5px;">
                    {{ total_not_started }}
                </span>
                <span class="stat-percentage" style="display: block; font-size: 1.2em; font-weight: 600; color: #dc3545; margin-bottom: 5px;">
                    {{ "%.1f"|format((total_not_started / total_teachers * 100) if total_teachers > 0 else 0) }}%
                </span>
                <span class="stat-label" style="color: #666; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">
                    Not Started
                </span>
            </div>
        </div>
        <!-- School Overview Cards -->
        <div class="school-overview-grid">
            {% for school_name, school_data in teacher_progress_data.items() %}
            <div class="school-card" onclick="toggleSchoolDetail('{{ school_name|replace(' ', '_') }}')">
                <div class="school-card-header">
                    <h3 class="school-card-title">{{ school_name }}</h3>
                    <div class="school-card-stats">
                        <div class="stat-item">
                            <span class="stat-number">{{ school_data.total_teachers }}</span>
                            <span class="stat-label">Teachers</span>
                        </div>
                    </div>
                </div>

                <div class="progress-summary">
                    <div class="progress-item">
                        <div class="progress-bar-mini">
                            <div class="progress-fill achieved" style="width: {{ (school_data.goals_achieved / school_data.total_teachers * 100) if school_data.total_teachers > 0 else 0 }}%"></div>
                        </div>
                        <div class="progress-info">
                            <span class="progress-percentage">{{ "%.1f"|format((school_data.goals_achieved / school_data.total_teachers * 100) if school_data.total_teachers > 0 else 0) }}%</span>
                            <span class="progress-label">Completed</span>
                        </div>
                    </div>

                    <div class="progress-item">
                        <div class="progress-bar-mini">
                            <div class="progress-fill in-progress" style="width: {{ (school_data.goals_in_progress / school_data.total_teachers * 100) if school_data.total_teachers > 0 else 0 }}%"></div>
                        </div>
                        <div class="progress-info">
                            <span class="progress-percentage">{{ "%.1f"|format((school_data.goals_in_progress / school_data.total_teachers * 100) if school_data.total_teachers > 0 else 0) }}%</span>
                            <span class="progress-label">In Progress</span>
                        </div>
                    </div>

                    <div class="progress-item">
                        <div class="progress-bar-mini">
                            <div class="progress-fill not-started" style="width: {{ (school_data.goals_not_started / school_data.total_teachers * 100) if school_data.total_teachers > 0 else 0 }}%"></div>
                        </div>
                        <div class="progress-info">
                            <span class="progress-percentage">{{ "%.1f"|format((school_data.goals_not_started / school_data.total_teachers * 100) if school_data.total_teachers > 0 else 0) }}%</span>
                            <span class="progress-label">Not Started</span>
                        </div>
                    </div>
                </div>

                <div class="school-card-footer">
                    <span class="click-hint">Click to view details</span>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- School Detail Views (Hidden by default) -->
        {% for school_name, school_data in teacher_progress_data.items() %}
        <div id="school-detail-{{ school_name|replace(' ', '_') }}" class="school-detail" style="display: none;">
            <div class="school-detail-header">
                <h2>{{ school_name }} - Teacher Details</h2>
                <button class="close-detail" onclick="toggleSchoolDetail('{{ school_name|replace(' ', '_') }}')">×</button>
            </div>

            <div class="teacher-list">
                {% for teacher in school_data.teachers %}
                <div class="teacher-item">
                    <div class="teacher-info">
                        <div class="teacher-name">
                            <a href="{{ url_for('teachers.view_teacher', teacher_id=teacher.id) }}" class="teacher-link">
                                {{ teacher.name }}
                            </a>
                            <span class="teacher-grade">Grade {{ teacher.grade }}</span>
                        </div>
                        <div class="teacher-email">{{ teacher.email }}</div>
                    </div>

                    <div class="teacher-progress">
                        <div class="progress-indicator">
                            <div class="progress-bar">
                                <div class="progress-fill {{ teacher.progress_class }}" style="width: {{ teacher.progress_percentage }}%"></div>
                            </div>
                            <div class="progress-text">{{ teacher.completed_sessions }}/{{ teacher.target_sessions }}</div>
                        </div>
                        <div class="goal-status {{ teacher.goal_status_class }}"
                             {% if teacher.goal_status_class == 'in_progress' %}
                             style="background: #ffd700 !important; color: #8b4513 !important; border: 1px solid #b8860b !important; font-weight: bold !important;"
                             {% endif %}>
                            {{ teacher.goal_status_text }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="setup-message">
            <h3>Teacher Progress Tracking Setup Required</h3>
            <p>Teacher progress tracking is not yet configured. This feature requires importing a list of specific teachers from a spreadsheet to track their progress against district goals. Please contact the system administrator to set up the teacher list for Kansas City Kansas Public Schools.</p>
        </div>
    {% endif %}
</div>

<!-- Final CSS override to ensure mustard yellow shows -->
<style>
/* Final override - must be last */
.goal-status.in-progress,
.teacher-progress-container .goal-status.in-progress,
div.goal-status.in-progress {
    background: #ffd700 !important;
    color: #8b4513 !important;
    border: 1px solid #b8860b !important;
    font-weight: bold !important;
}

/* School Overview Cards */
.school-overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.school-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 4px solid #28a745;
}

.school-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.school-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.school-card-title {
    margin: 0;
    font-size: 1.2em;
    font-weight: 600;
    color: #333;
}

.school-card-stats .stat-item {
    text-align: center;
}

.school-card-stats .stat-number {
    display: block;
    font-size: 1.5em;
    font-weight: 700;
    color: #28a745;
}

.school-card-stats .stat-label {
    font-size: 0.8em;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.progress-summary {
    margin-bottom: 15px;
}

.progress-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.progress-bar-mini {
    width: 60px;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin-right: 10px;
}

.progress-fill.achieved {
    background: #28a745;
}

.progress-fill.in-progress {
    background: #ffd700;
}

.progress-fill.not-started {
    background: #dc3545;
}

.progress-info {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.progress-percentage {
    font-weight: 600;
    color: #333;
    font-size: 0.9em;
}

.progress-label {
    font-size: 0.8em;
    color: #666;
}

.school-card-footer {
    text-align: center;
    padding-top: 10px;
    border-top: 1px solid #eee;
}

.click-hint {
    font-size: 0.8em;
    color: #28a745;
    font-style: italic;
}

/* School Detail View */
.school-detail {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
    overflow: hidden;
}

.school-detail-header {
    background: #f8f9fa;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
}

.school-detail-header h2 {
    margin: 0;
    color: #333;
    font-size: 1.4em;
}

.close-detail {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 1.2em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-detail:hover {
    background: #c82333;
}

.teacher-list {
    padding: 20px;
}

.teacher-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #eee;
    transition: background 0.2s ease;
}

.teacher-item:hover {
    background: #f8f9fa;
}

.teacher-item:last-child {
    border-bottom: none;
}

.teacher-info {
    flex: 1;
}

.teacher-name {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
}

.teacher-grade {
    background: #e9ecef;
    color: #495057;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
}

.teacher-email {
    font-size: 0.9em;
    color: #666;
}

.teacher-progress {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
}
</style>

<script>
function toggleSchoolDetail(schoolId) {
    const detailElement = document.getElementById('school-detail-' + schoolId);
    if (detailElement.style.display === 'none' || detailElement.style.display === '') {
        // Hide all other detail views
        const allDetails = document.querySelectorAll('.school-detail');
        allDetails.forEach(detail => {
            detail.style.display = 'none';
        });

        // Show the selected detail view
        detailElement.style.display = 'block';

        // Scroll to the detail view
        detailElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // Hide the detail view
        detailElement.style.display = 'none';
    }
}
</script>
{% endblock %}
