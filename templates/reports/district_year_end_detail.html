{% extends "base.html" %}

{% block title %}{{ district.name }} Year-End Report{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/district_year_end_detail.css') }}">
<style>


    /* Event type filtering styles */
    .event-types-section {
        margin-bottom: 2rem;
    }

    .event-types-header {
        background: var(--ucla-blue);
        color: white;
        padding: 0.75rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .event-types-header:hover {
        background: var(--delft-blue);
    }

    .event-types-header h3 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .toggle-icon {
        transition: transform 0.3s ease;
    }

    .toggle-icon.rotated {
        transform: rotate(90deg);
    }

    .event-types-content {
        padding: 1rem 1.25rem;
        background: white;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .event-types-content.collapsed {
        max-height: 0;
        padding: 0 1.25rem;
        opacity: 0;
        overflow: hidden;
    }

    .event-types-content.expanded {
        max-height: 1000px;
        opacity: 1;
        padding: 1rem 1.25rem;
        overflow: visible;
    }

    /* Month card collapsible styles */
    .month-header.collapsible-header {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .month-header.collapsible-header:hover {
        background-color: rgba(158, 216, 219, 0.1);
    }

    .month-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .month-title h3 {
        margin: 0;
    }

    .month-toggle-icon {
        transition: transform 0.3s ease;
        color: var(--ucla-blue);
    }

    .month-toggle-icon.rotated {
        transform: rotate(90deg);
    }

    .events-table-wrapper.collapsed {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .events-table-wrapper.expanded {
        max-height: 2000px;
        overflow: visible;
        opacity: 1;
        transition: all 0.3s ease;
    }

    .event-type-card.filterable {
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        min-height: 50px;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }

    .event-type-card.filterable:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: var(--ucla-blue);
    }

    .event-type-card.filterable.selected {
        background-color: var(--ucla-blue);
        color: white;
        border-color: var(--ucla-blue);
        box-shadow: 0 4px 12px rgba(70, 117, 153, 0.3);
    }

    .event-type-card.filterable.selected::after {
        content: "âœ“";
        position: absolute;
        top: 4px;
        right: 6px;
        font-weight: bold;
        font-size: 10px;
        background: rgba(255, 255, 255, 0.9);
        color: var(--ucla-blue);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .clear-filter-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .clear-filter-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .filter-tip {
        font-size: 11px;
        color: #666;
        font-style: italic;
        margin: 0.75rem 0 0 0;
        padding: 0.4rem 0.6rem;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 3px solid var(--ucla-blue);
    }

    .filter-tip::before {
        content: "ðŸ’¡";
        margin-right: 0.4rem;
    }

    .event-types-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .event-types-grid::before {
        content: "ðŸ’¡ Tip: Hold Ctrl/Cmd to select multiple event types";
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
        font-style: italic;
    }

    .download-button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        transition: background-color 0.2s ease;
    }
    
    .download-button:hover {
        background-color: #218838;
        color: white;
        text-decoration: none;
    }

    /* Host Filter Styles */
    .host-filter-toggle {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 1.5rem 0;
    }

    .host-filter-btn {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        color: #495057;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }

    .host-filter-btn:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        color: #495057;
        text-decoration: none;
    }

    .host-filter-btn.selected {
        background: var(--ucla-blue);
        border-color: var(--ucla-blue);
        color: white;
        box-shadow: 0 2px 4px rgba(70, 117, 153, 0.3);
    }

    .host-filter-btn.selected:hover {
        background: var(--delft-blue);
        border-color: var(--delft-blue);
        color: white;
    }

    /* Event title link styles (matching events.html) */
    .event-title-link {
        color: var(--delft-blue);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
        position: relative;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        display: inline-block;
    }

    .event-title-link:hover {
        color: var(--ucla-blue);
        background-color: rgba(70, 117, 153, 0.08);
        transform: translateX(2px);
        text-decoration: none;
    }

    .event-title-link:active {
        transform: translateX(1px);
        background-color: rgba(70, 117, 153, 0.12);
    }

    /* No events message styling */
    .no-events-message {
        padding: 2rem;
        text-align: center;
        color: #6c757d;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-top: 1rem;
    }

    .no-events-message i {
        margin-right: 0.5rem;
        color: var(--ucla-blue);
    }

    /* School card collapsible styling */
    .school-header.collapsible-header {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .school-header.collapsible-header:hover {
        background-color: rgba(70, 117, 153, 0.05);
    }

    .school-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .school-toggle-icon {
        font-size: 0.875rem;
        color: var(--ucla-blue);
        transition: transform 0.3s ease;
        flex-shrink: 0;
    }

    .school-toggle-icon.rotated {
        transform: rotate(90deg);
    }

    .school-card .events-table-wrapper.collapsed,
    .school-card .no-events-message.collapsed {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .school-card .events-table-wrapper.expanded,
    .school-card .no-events-message.expanded {
        max-height: 1000px;
        opacity: 1;
        transition: all 0.3s ease;
    }

    /* Enhanced Summary Stats Styles */
    .enhanced-summary-stats {
        margin-bottom: 2rem;
    }

    .summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .summary-header h2 {
        color: var(--ucla-blue);
        margin: 0;
    }

    .summary-toggle-btn {
        background: var(--ucla-blue);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .summary-toggle-btn:hover {
        background: var(--delft-blue);
        transform: translateY(-1px);
    }

    .quick-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .overview-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.2s ease;
    }

    .overview-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .detailed-breakdown {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 2rem;
        margin-top: 1rem;
    }

    .breakdown-section {
        margin-bottom: 2rem;
    }

    .breakdown-section h3 {
        color: var(--ucla-blue);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .breakdown-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .breakdown-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid var(--ucla-blue);
    }

    .breakdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }

    .breakdown-title {
        font-weight: 600;
        color: #495057;
    }

    .breakdown-total {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--ucla-blue);
    }

    .breakdown-details {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .breakdown-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8f9fa;
    }

    .breakdown-item:last-child {
        border-bottom: none;
    }

    .breakdown-label {
        color: #6c757d;
        font-weight: 500;
    }

    .breakdown-value {
        font-weight: 600;
        color: #495057;
    }

    .breakdown-percent {
        color: var(--ucla-blue);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .breakdown-note {
        color: #6c757d;
        font-size: 0.75rem;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="district-detail-container">
    <div class="header-section">
        <div class="back-nav">
            <a href="{{ url_for('report.district_year_end', school_year=school_year, host_filter=host_filter) }}" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to Districts
            </a>
        </div>
        <h1>{{ district.name }}</h1>
        <div class="school-year">{{ school_year[:2] }}-{{ school_year[2:] }} School Year</div>
    </div>

    <!-- Host Filter Toggle -->
    <div class="host-filter-toggle">
        <form method="get" id="hostFilterForm">
            <input type="hidden" name="school_year" value="{{ school_year }}">
            <button type="submit" name="host_filter" value="all" class="host-filter-btn{% if host_filter == 'all' %} selected{% endif %}">All Events</button>
            <button type="submit" name="host_filter" value="prepkc" class="host-filter-btn{% if host_filter == 'prepkc' %} selected{% endif %}">PREPKC Events Only</button>
        </form>
    </div>

    <!-- Enhanced Summary Stats -->
    <div class="enhanced-summary-stats">
        <div class="summary-header">
            <h2>District Overview</h2>
            <div class="summary-toggle">
                <button id="summary-toggle-btn" class="summary-toggle-btn" onclick="toggleSummaryView()">
                    <i class="fas fa-chart-bar"></i> Show Detailed Breakdown
                </button>
            </div>
        </div>
        
        <!-- Quick Overview (always visible) -->
        <div class="quick-overview">
            <div class="stat-card overview-card">
                <div class="stat-value">{{ total_events }}</div>
                <div class="stat-label">Total Events</div>
            </div>
            <div class="stat-card overview-card">
                <div class="stat-value">{{ unique_student_count }}</div>
                <div class="stat-label">Unique Students Reached</div>
            </div>
            <div class="stat-card overview-card">
                <div class="stat-value">{{ stats.total_volunteers }}</div>
                <div class="stat-label">Volunteer Engagements</div>
                <div class="stat-sublabel">{{ unique_volunteer_count }} unique</div>
            </div>
            <div class="stat-card overview-card">
                <div class="stat-value">{{ stats.total_volunteer_hours }}</div>
                <div class="stat-label">Volunteer Hours</div>
            </div>
            <div class="stat-card overview-card">
                <div class="stat-value">{{ unique_organization_count }}</div>
                <div class="stat-label">Volunteer Organizations</div>
            </div>
        </div>
        
        <!-- Detailed Breakdown (collapsible) -->
        <div class="detailed-breakdown" id="detailed-breakdown" style="display: none;">
            {% if stats.enhanced %}
            
            <!-- Events Breakdown -->
            <div class="breakdown-section">
                <h3><i class="fas fa-calendar-alt"></i> Events Breakdown</h3>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Total Events</div>
                            <div class="breakdown-total">{{ stats.enhanced.events.total }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">In-Person</span>
                                <span class="breakdown-value">{{ stats.enhanced.events.in_person }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.events.in_person_pct }}%)</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Virtual</span>
                                <span class="breakdown-value">{{ stats.enhanced.events.virtual }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.events.virtual_pct }}%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Students Breakdown -->
            <div class="breakdown-section">
                <h3><i class="fas fa-user-graduate"></i> Students Breakdown</h3>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Total Student Engagements</div>
                            <div class="breakdown-total">{{ stats.enhanced.students.total }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">In-Person</span>
                                <span class="breakdown-value">{{ stats.enhanced.students.in_person }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.students.in_person_pct }}%)</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Virtual</span>
                                <span class="breakdown-value">{{ stats.enhanced.students.virtual }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.students.virtual_pct }}%)</span>
                            </div>
                        </div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Unique Students Reached</div>
                            <div class="breakdown-total">{{ stats.enhanced.students.unique_total }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">In-Person</span>
                                <span class="breakdown-value">{{ stats.enhanced.students.unique_in_person }}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Virtual</span>
                                <span class="breakdown-value">{{ stats.enhanced.students.unique_virtual }}</span>
                                <span class="breakdown-note">*Virtual unique tracking limited</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

            
            <!-- Enhanced Volunteers Breakdown -->
            <div class="breakdown-section">
                <h3><i class="fas fa-users"></i> Enhanced Volunteers Breakdown</h3>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Volunteer Engagements</div>
                            <div class="breakdown-total">{{ stats.enhanced.volunteers.total }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">In-Person</span>
                                <span class="breakdown-value">{{ stats.enhanced.volunteers.in_person }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.volunteers.in_person_pct }}%)</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Virtual</span>
                                <span class="breakdown-value">{{ stats.enhanced.volunteers.virtual }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.volunteers.virtual_pct }}%)</span>
                            </div>
                        </div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Unique Volunteers</div>
                            <div class="breakdown-total">{{ stats.enhanced.volunteers.unique_total }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">In-Person Events</span>
                                <span class="breakdown-value">{{ stats.enhanced.volunteers.unique_in_person }}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Virtual Events</span>
                                <span class="breakdown-value">{{ stats.enhanced.volunteers.unique_virtual }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Total Volunteer Hours</div>
                            <div class="breakdown-total">{{ "%.1f"|format(stats.enhanced.volunteers.hours_total) }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">In-Person</span>
                                <span class="breakdown-value">{{ "%.1f"|format(stats.enhanced.volunteers.hours_in_person) }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.volunteers.hours_in_person_pct }}%)</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Virtual</span>
                                <span class="breakdown-value">{{ "%.1f"|format(stats.enhanced.volunteers.hours_virtual) }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.volunteers.hours_virtual_pct }}%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Organizations Breakdown -->
            <div class="breakdown-section">
                <h3><i class="fas fa-building"></i> Enhanced Organizations Breakdown</h3>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Unique Organizations</div>
                            <div class="breakdown-total">{{ stats.enhanced.organizations.unique_total }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">In-Person Events</span>
                                <span class="breakdown-value">{{ stats.enhanced.organizations.unique_in_person }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.organizations.unique_in_person_pct }}%)</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Virtual Events</span>
                                <span class="breakdown-value">{{ stats.enhanced.organizations.unique_virtual }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.organizations.unique_virtual_pct }}%)</span>
                            </div>
                        </div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Organization Volunteer Hours</div>
                            <div class="breakdown-total">{{ "%.1f"|format(stats.enhanced.organizations.volunteer_hours_total) }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">In-Person</span>
                                <span class="breakdown-value">{{ "%.1f"|format(stats.enhanced.organizations.volunteer_hours_in_person) }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.organizations.volunteer_hours_in_person_pct }}%)</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Virtual</span>
                                <span class="breakdown-value">{{ "%.1f"|format(stats.enhanced.organizations.volunteer_hours_virtual) }}</span>
                                <span class="breakdown-percent">({{ stats.enhanced.organizations.volunteer_hours_virtual_pct }}%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Virtual Sessions Breakdown -->
            <div class="breakdown-section">
                <h3><i class="fas fa-video"></i> Virtual Sessions Breakdown</h3>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Classrooms Reached</div>
                            <div class="breakdown-total">{{ stats.enhanced.virtual_sessions.classrooms_reached }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Registered Teachers</span>
                                <span class="breakdown-value">{{ stats.enhanced.virtual_sessions.registered_teachers }}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Confirmed Teachers</span>
                                <span class="breakdown-value">{{ stats.enhanced.virtual_sessions.confirmed_teachers }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Unique Teachers</div>
                            <div class="breakdown-total">{{ stats.enhanced.virtual_sessions.unique_teachers }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Total Registrations</span>
                                <span class="breakdown-value">{{ stats.enhanced.virtual_sessions.registered_teachers }}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Confirmed Attendance</span>
                                <span class="breakdown-value">{{ stats.enhanced.virtual_sessions.confirmed_teachers }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% else %}
            <!-- Fallback to original stats display -->
            <div class="breakdown-section">
                <h3>Basic Stats</h3>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <div class="breakdown-header">
                            <div class="breakdown-title">Students</div>
                            <div class="breakdown-total">{{ stats.total_in_person_students + stats.total_virtual_students }}</div>
                        </div>
                        <div class="breakdown-details">
                            <div class="breakdown-item">
                                <span class="breakdown-label">In-Person</span>
                                <span class="breakdown-value">{{ stats.total_in_person_students }}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Virtual</span>
                                <span class="breakdown-value">{{ stats.total_virtual_students }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Event Type Breakdown and Filtering -->
    <div class="breakdown-section">
        <div class="event-types-section">
            <div class="event-types-header" onclick="toggleEventTypeFilter()">
                <h3>
                    <i class="fas fa-chevron-right toggle-icon" id="event-filter-toggle"></i>
                    Event Types Filter
                </h3>
                <button class="clear-filter-btn" onclick="event.stopPropagation(); clearEventTypeFilter()">
                    <i class="fas fa-times"></i> Clear Filter
                </button>
            </div>
            <div class="event-types-content collapsed" id="event-types-filter-content">
                <div class="event-types-grid">
                    {% for type, count in stats.event_types.items() %}
                    <div class="event-type-card filterable" data-type="{{ type }}">
                        <div class="type-count">{{ count }}</div>
                        <div class="type-name">{{ type|replace('_', ' ')|title }}</div>
                    </div>
                    {% endfor %}
                </div>
                <p class="filter-tip">Click event types to filter the data below. Hold Ctrl/Cmd to select multiple types.</p>
            </div>
        </div>
    </div>

    <!-- Activity Breakdown -->
    <div class="activity-breakdown">
        <div class="activity-header">
            <h2>Activity Breakdown</h2>
            <div class="view-toggle">
                <button class="view-toggle-button" data-view="monthly">
                    <i class="fas fa-calendar-alt"></i> Monthly
                </button>
                <button class="view-toggle-button" data-view="schools">
                    <i class="fas fa-school"></i> By School
                </button>
                <button class="view-toggle-button active" data-view="all-types">
                    <i class="fas fa-th-large"></i> All Types
                </button>
                <a href="{{ url_for('report.district_year_end_excel', district_name=district.name, school_year=school_year, host_filter=host_filter) }}" class="download-button">
                    <i class="fas fa-file-excel"></i> Download Excel
                </a>
            </div>
        </div>

        <!-- Monthly view -->
        <div id="monthly-view" class="view-content">
            {% for month, data in events_by_month.items() %}
            <div class="month-card">
                <div class="month-header collapsible-header" onclick="toggleMonthCard('{{ month|replace(' ', '_') }}')">
                    <div class="month-title">
                        <i class="fas fa-chevron-right month-toggle-icon" id="month-toggle-{{ month|replace(' ', '_') }}"></i>
                        <h3>{{ month }}</h3>
                    </div>
                    <div class="month-stats">
                        <span>{{ data.events|length }} Events</span>
                        <span>{{ data.total_students }} Students</span>
                        {% if data.unique_student_count is defined %}
                        <span>{{ data.unique_student_count }} Unique Students</span>
                        {% endif %}
                        <span>{{ data.volunteer_engagements }} Volunteer Engagements</span>
                        <span>{{ data.unique_volunteer_count }} Unique Volunteers</span>
                        <span>{{ "%.1f"|format(data.total_volunteer_hours) }} Hours</span>
                    </div>
                </div>
                
                <div class="events-table-wrapper collapsed" id="month-content-{{ month|replace(' ', '_') }}">
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Event</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Students</th>
                                <th>Volunteers</th>
                                <th>Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in data.events %}
                            <tr>
                                <td>{{ event.date }}</td>
                                <td>{{ event.time }}</td>
                                <td>
                                    <a href="{{ url_for('events.view_event', id=event.id) }}" class="event-title-link">
                                        {{ event.title }}
                                    </a>
                                </td>
                                <td class="event-type-cell">
                                    <span class="event-type-badge {{ event.type|replace('_', '-') }}">{{ event.type|replace('_', ' ')|title }}</span>
                                </td>
                                <td>{{ event.location }}</td>
                                <td>{{ event.students }}</td>
                                <td>{{ event.volunteers }}</td>
                                <td>{{ "%.1f"|format(event.volunteer_hours) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Schools view -->
        <div id="schools-view" class="view-content">
            {% for level in ['High', 'Middle', 'Elementary', None] %}
            {% set level_schools = schools_by_level.get(level, []) %}
            {% if level_schools %}
            <div class="school-group">
                <div class="school-group-header">
                    <i class="fas fa-{% if level == 'High' %}graduation-cap{% elif level == 'Middle' %}book{% elif level == 'Elementary' %}pencil-alt{% else %}school{% endif %}"></i>
                    {{ level if level else 'Other' }} Schools
                </div>
                {% for school_data in level_schools %}
                <div class="school-card">
                    <div class="school-header collapsible-header" onclick="toggleSchoolCard('{{ school_data.name|replace(' ', '_')|replace('-', '_')|replace('.', '_') }}')">
                        <div class="school-title">
                            <i class="fas fa-chevron-right school-toggle-icon" id="school-toggle-{{ school_data.name|replace(' ', '_')|replace('-', '_')|replace('.', '_') }}"></i>
                            <div class="school-name">{{ school_data.name }}</div>
                        </div>
                        <div class="school-stats">
                            <div class="school-stat">
                                <i class="fas fa-calendar-check"></i>
                                {{ school_data.events|length }} Events
                            </div>
                            <div class="school-stat">
                                <i class="fas fa-user-graduate"></i>
                                {{ school_data.total_students }} Students
                            </div>
                            <div class="school-stat">
                                <i class="fas fa-users"></i>
                                {{ school_data.total_volunteers }} Volunteer Engagements
                            </div>
                            <div class="school-stat">
                                <i class="fas fa-user-friends"></i>
                                {{ school_data.unique_volunteer_count }} Unique Volunteers
                            </div>
                            <div class="school-stat">
                                <i class="fas fa-clock"></i>
                                {{ "%.1f"|format(school_data.total_volunteer_hours) }} Hours
                            </div>
                        </div>
                    </div>
                    {% if school_data.events %}
                    <div class="events-table-wrapper collapsed" id="school-content-{{ school_data.name|replace(' ', '_')|replace('-', '_')|replace('.', '_') }}">
                        <table class="events-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Event</th>
                                    <th>Type</th>
                                    <th>Students</th>
                                    <th>Volunteers</th>
                                    <th>Hours</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in school_data.events|sort(attribute='date') %}
                                <tr>
                                    <td>{{ event.date }}</td>
                                    <td>{{ event.time }}</td>
                                    <td>
                                        <a href="{{ url_for('events.view_event', id=event.id) }}" class="event-title-link">
                                            {{ event.title }}
                                        </a>
                                    </td>
                                    <td class="event-type-cell">
                                        <span class="event-type-badge {{ event.type|replace('_', '-') }}">{{ event.type|replace('_', ' ')|title }}</span>
                                    </td>
                                    <td>{{ event.students }}</td>
                                    <td>{{ event.volunteers }}</td>
                                    <td>{{ "%.1f"|format(event.volunteer_hours) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="no-events-message collapsed" id="school-content-{{ school_data.name|replace(' ', '_')|replace('-', '_')|replace('.', '_') }}">
                        <p><i class="fas fa-info-circle"></i> No events recorded for this school in the selected time period.</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButtons = document.querySelectorAll('.view-toggle-button');
    const monthlyView = document.getElementById('monthly-view');
    const schoolsView = document.getElementById('schools-view');
    const eventTypeCards = document.querySelectorAll('.event-type-card.filterable');
    let currentView = 'monthly';
    let selectedEventTypes = new Set(); // Change to Set for multiple selections

    // Store original stats for resetting
    const originalStats = {
        totalEvents: {{ total_events }},
        uniqueStudents: {{ unique_student_count }},
        totalInPersonStudents: {{ stats.total_in_person_students }},
        totalVirtualStudents: {{ stats.total_virtual_students }},
        totalVolunteers: {{ stats.total_volunteers }},
        uniqueVolunteers: {{ unique_volunteer_count }},
        totalVolunteerHours: {{ stats.total_volunteer_hours }},
        uniqueOrganizations: {{ unique_organization_count }}
    };

    // Store event data for filtering calculations
    const eventsData = {
        {% for month, data in events_by_month.items() %}
        "{{ month }}": {
            events: [
                {% for event in data.events %}
                {
                    id: {{ event.id }},
                    type: "{{ event.type }}",
                    students: {{ event.students }},
                    volunteers: {{ event.volunteers }},
                    volunteerHours: {{ event.volunteer_hours }},
                    sessionHost: "{{ event.session_host or '' }}",
                    studentIds: [], // Will be populated from backend if needed
                    volunteerIds: [] // Will be populated from backend if needed
                },
                {% endfor %}
            ]
        },
        {% endfor %}
    };

    function switchView(viewType) {
        // Update button states
        toggleButtons.forEach(btn => {
            if (btn.dataset.view === viewType || (btn.dataset.view === 'all-types' && viewType === currentView)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // Reset to all types if clicking the "All Types" button
        if (viewType === 'all-types') {
            clearEventTypeFilter();
            viewType = currentView; // Keep current view (monthly or schools)
        } else {
            currentView = viewType; // Update current view
        }

        // Handle view transitions
        if (viewType === 'monthly') {
            schoolsView.classList.remove('visible');
            setTimeout(() => {
                monthlyView.classList.add('visible');
                schoolsView.style.display = 'none';
                monthlyView.style.display = 'block';
            }, 300);
        } else {
            monthlyView.classList.remove('visible');
            setTimeout(() => {
                schoolsView.classList.add('visible');
                monthlyView.style.display = 'none';
                schoolsView.style.display = 'block';
            }, 300);
        }
    }

    function updateTopLevelStats(filteredStats) {
        // Update the overview cards
        const overviewCards = document.querySelectorAll('.overview-card .stat-value');
        if (overviewCards.length >= 5) {
            overviewCards[0].textContent = filteredStats.totalEvents;
            overviewCards[1].textContent = filteredStats.uniqueStudents;
            overviewCards[2].textContent = filteredStats.totalVolunteers;
            overviewCards[3].textContent = filteredStats.totalVolunteerHours.toFixed(1);
            overviewCards[4].textContent = filteredStats.uniqueOrganizations;
        }

        // Update the unique volunteers sub-label
        const volunteerCard = document.querySelector('.overview-card:nth-child(3) .stat-sublabel');
        if (volunteerCard) {
            volunteerCard.textContent = `${filteredStats.uniqueVolunteers} unique`;
        }
        
        // Update enhanced breakdown if available
        if (filteredStats.enhanced) {
            updateEnhancedBreakdown(filteredStats.enhanced);
        }
    }
    
    function updateEnhancedBreakdown(enhanced) {
        // Update events breakdown
        updateBreakdownCard('events', enhanced.events);
        
        // Update students breakdown
        updateBreakdownCard('students', enhanced.students);
        
        // Update volunteers breakdown (enhanced with hours)
        updateVolunteersBreakdown(enhanced.volunteers);
        
        // Update organizations breakdown (enhanced with hours)
        updateOrganizationsBreakdown(enhanced.organizations);
        
        // Update virtual sessions breakdown
        updateVirtualSessionsBreakdown(enhanced.virtual_sessions);
    }
    
    function updateBreakdownCard(category, data) {
        // Find breakdown cards by looking for specific titles
        const breakdownCards = document.querySelectorAll('.breakdown-card');
        
        breakdownCards.forEach(card => {
            const title = card.querySelector('.breakdown-title');
            if (!title) return;
            
            const titleText = title.textContent.toLowerCase();
            
            // Update based on category and title matching
            if (category === 'events' && titleText.includes('total events')) {
                updateCardValues(card, data);
            } else if (category === 'students' && titleText.includes('total student engagements')) {
                updateCardValues(card, data);
            } else if (category === 'students' && titleText.includes('unique students reached')) {
                updateCardValues(card, data, true); // Skip percentages for unique counts
            } else if (category === 'volunteers' && titleText.includes('total volunteer engagements')) {
                updateCardValues(card, data);
            } else if (category === 'volunteers' && titleText.includes('unique volunteers')) {
                updateCardValues(card, data, true); // Skip percentages for unique counts
            } else if (category === 'volunteer_hours' && titleText.includes('total volunteer hours')) {
                updateCardValues(card, data, false, true); // Format as decimal
            } else if (category === 'organizations' && titleText.includes('volunteer organizations')) {
                updateCardValues(card, data);
            }
        });
    }
    
    function updateCardValues(card, data, skipPercentages = false, isDecimal = false) {
        // Update total
        const total = card.querySelector('.breakdown-total');
        if (total) {
            total.textContent = isDecimal ? data.total.toFixed(1) : data.total;
        }
        
        // Update breakdown items
        const items = card.querySelectorAll('.breakdown-item');
        items.forEach(item => {
            const label = item.querySelector('.breakdown-label');
            if (!label) return;
            
            const labelText = label.textContent.toLowerCase();
            const value = item.querySelector('.breakdown-value');
            const percent = item.querySelector('.breakdown-percent');
            
            if (labelText.includes('in-person')) {
                if (value) {
                    value.textContent = isDecimal ? data.in_person.toFixed(1) : data.in_person;
                }
                if (percent && !skipPercentages) {
                    percent.textContent = `(${data.in_person_pct}%)`;
                }
            } else if (labelText.includes('virtual')) {
                if (value) {
                    value.textContent = isDecimal ? data.virtual.toFixed(1) : data.virtual;
                }
                if (percent && !skipPercentages) {
                    percent.textContent = `(${data.virtual_pct}%)`;
                }
            }
        });
    }

    function calculateFilteredStats(selectedTypes) {
        if (selectedTypes.size === 0) {
            // No filter, return original stats
            return originalStats;
        }

        let totalEvents = 0;
        let totalStudents = 0;
        let totalInPersonStudents = 0;
        let totalVirtualStudents = 0;
        let totalVolunteers = 0;
        let totalVolunteerHours = 0;
        let uniqueStudents = new Set();
        let uniqueVolunteers = new Set();
        let uniqueOrganizations = new Set();

        // Iterate through all events and sum up filtered data
        for (const month in eventsData) {
            for (const event of eventsData[month].events) {
                if (selectedTypes.has(event.type)) {
                    totalEvents++;
                    totalStudents += event.students;
                    totalVolunteers += event.volunteers;
                    totalVolunteerHours += event.volunteerHours;
                    
                    // For virtual vs in-person, we'd need the event format
                    // For now, assume all filtered events contribute to in-person
                    // You may need to add event format to the eventsData structure
                    totalInPersonStudents += event.students;
                    
                    // Note: For true unique counting, we'd need individual IDs
                    // This is a simplified calculation
                    // You might want to make an AJAX call for precise unique counts
                }
            }
        }

        return {
            totalEvents,
            uniqueStudents: totalStudents, // Simplified - would need actual unique IDs
            totalInPersonStudents,
            totalVirtualStudents,
            totalVolunteers,
            uniqueVolunteers: Math.min(totalVolunteers, originalStats.uniqueVolunteers), // Approximation
            totalVolunteerHours,
            uniqueOrganizations: Math.min(totalVolunteers, originalStats.uniqueOrganizations) // Approximation
        };
    }

    // Add this function to fetch precise stats
    async function fetchPreciseStats(selectedTypes) {
        if (selectedTypes.size === 0) {
            return originalStats;
        }
        
        const params = new URLSearchParams();
        params.append('school_year', '{{ school_year }}');
        params.append('host_filter', '{{ host_filter }}');
        selectedTypes.forEach(type => params.append('event_types[]', type));
        
        try {
            const response = await fetch(`{{ url_for('report.get_filtered_stats', district_name=district.name) }}?${params}`);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching precise stats:', error);
            return calculateFilteredStats(selectedTypes); // Fallback to approximation
        }
    }

    // Update the filterByEventTypes function to use precise stats
    async function filterByEventTypes(eventTypes) {
        // Update card selection states
        eventTypeCards.forEach(card => {
            const type = card.dataset.type;
            if (eventTypes.has(type)) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });

        if (eventTypes.size === 0) {
            // Show all events and reset everything
            document.querySelectorAll('.events-table tbody tr').forEach(row => {
                row.style.display = '';
            });
            updateTopLevelStats(originalStats);
            updateAllStats();
            return;
        }
        
        // Filter monthly view
        document.querySelectorAll('#monthly-view .events-table tbody tr').forEach(row => {
            const typeCell = row.querySelector('td:nth-child(4)');
            if (typeCell && eventTypes.has(typeCell.textContent.trim())) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // Filter school view
        document.querySelectorAll('#schools-view .school-card').forEach(card => {
            card.style.display = '';
            
            const eventRows = card.querySelectorAll('.events-table tbody tr');
            let visibleEvents = 0;
            
            eventRows.forEach(row => {
                const typeCell = row.querySelector('td:nth-child(3)'); // Type is in the 3rd column for school view
                if (typeCell && eventTypes.has(typeCell.textContent.trim())) {
                    row.style.display = '';
                    visibleEvents++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update this school's stats based on visible events
            updateSchoolStats(card, eventRows);
        });
        
        // Update monthly view stats
        document.querySelectorAll('#monthly-view .month-card').forEach(card => {
            const visibleEvents = Array.from(card.querySelectorAll('tbody tr')).filter(row => 
                row.style.display !== 'none'
            );
            
            updateMonthlyStats(card, visibleEvents);
        });

        // Get precise stats and update top-level display
        const filteredStats = await fetchPreciseStats(eventTypes);
        updateTopLevelStats(filteredStats);
    }

    function updateSchoolStats(card, eventRows) {
        let totalEvents = 0;
        let totalStudents = 0;
        let totalVolunteers = 0;
        let totalHours = 0;
        
        eventRows.forEach(row => {
            if (row.style.display !== 'none') {
                totalEvents++;
                totalStudents += parseInt(row.querySelector('td:nth-child(4)').textContent) || 0;
                totalVolunteers += parseInt(row.querySelector('td:nth-child(5)').textContent) || 0;
                totalHours += parseFloat(row.querySelector('td:nth-child(6)').textContent) || 0;
            }
        });
        
        // Update school stats display
        const statsElements = card.querySelectorAll('.school-stat');
        if (statsElements.length >= 5) {
            statsElements[0].innerHTML = `<i class="fas fa-calendar-check"></i> ${totalEvents} Events`;
            statsElements[1].innerHTML = `<i class="fas fa-user-graduate"></i> ${totalStudents} Students`;
            statsElements[2].innerHTML = `<i class="fas fa-users"></i> ${totalVolunteers} Volunteer Engagements`;
            statsElements[3].innerHTML = `<i class="fas fa-user-friends"></i> ${Math.min(totalVolunteers, parseInt(statsElements[3].textContent.match(/\d+/)[0]))} Unique Volunteers`;
            statsElements[4].innerHTML = `<i class="fas fa-clock"></i> ${totalHours.toFixed(1)} Hours`;
        }
    }

    function updateMonthlyStats(card, visibleEvents) {
        let totalStudents = 0;
        let totalVolunteers = 0;
        let totalHours = 0;
        
        visibleEvents.forEach(row => {
            totalStudents += parseInt(row.querySelector('td:nth-child(6)').textContent) || 0; // Students column
            totalVolunteers += parseInt(row.querySelector('td:nth-child(7)').textContent) || 0; // Volunteers column  
            totalHours += parseFloat(row.querySelector('td:nth-child(8)').textContent) || 0; // Hours column
        });
        
        const statsElement = card.querySelector('.month-stats');
        if (statsElement) {
            const stats = statsElement.querySelectorAll('span');
            if (stats.length >= 6) {
                stats[0].textContent = `${visibleEvents.length} Events`;
                stats[1].textContent = `${totalStudents} Students`;
                stats[3].textContent = `${totalVolunteers} Volunteer Engagements`;
                stats[5].textContent = `${totalHours.toFixed(1)} Hours`;
            }
        }
    }
    
    function updateAllStats() {
        // Reset all stats to their original values (same as before)
        document.querySelectorAll('.school-card').forEach(card => {
            const eventRows = card.querySelectorAll('.events-table tbody tr');
            const totalEvents = eventRows.length;
            
            const eventCountElement = card.querySelector('.school-stat:first-child');
            if (eventCountElement) {
                eventCountElement.innerHTML = `<i class="fas fa-calendar-check"></i> ${totalEvents} Events`;
            }
            
            let totalStudents = 0;
            let totalVolunteers = 0;
            let totalHours = 0;
            
            eventRows.forEach(row => {
                totalStudents += parseInt(row.querySelector('td:nth-child(4)').textContent) || 0;
                totalVolunteers += parseInt(row.querySelector('td:nth-child(5)').textContent) || 0;
                totalHours += parseFloat(row.querySelector('td:nth-child(6)').textContent) || 0;
            });
            
            const statsElements = card.querySelectorAll('.school-stat');
            if (statsElements.length >= 4) {
                statsElements[1].innerHTML = `<i class="fas fa-user-graduate"></i> ${totalStudents} Students`;
                statsElements[2].innerHTML = `<i class="fas fa-users"></i> ${totalVolunteers} Volunteer Engagements`;
                statsElements[3].innerHTML = `<i class="fas fa-clock"></i> ${totalHours.toFixed(1)} Hours`;
            }
        });
        
        document.querySelectorAll('.month-card').forEach(card => {
            const totalEvents = card.querySelectorAll('tbody tr').length;
            const statsElement = card.querySelector('.month-stats');
            if (statsElement) {
                const firstStat = statsElement.querySelector('span:first-child');
                if (firstStat) {
                    firstStat.textContent = `${totalEvents} Events`;
                }
            }
        });
    }

    function clearEventTypeFilter() {
        selectedEventTypes.clear();
        eventTypeCards.forEach(card => card.classList.remove('selected'));
        filterByEventTypes(selectedEventTypes);
    }

    function toggleEventTypeFilter() {
        console.log('Toggle function called'); // Debug log
        const content = document.getElementById('event-types-filter-content');
        const toggleIcon = document.getElementById('event-filter-toggle');
        
        console.log('Content element:', content); // Debug log
        console.log('Toggle icon:', toggleIcon); // Debug log
        
        if (content && toggleIcon) {
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                toggleIcon.classList.add('rotated');
                console.log('Expanded'); // Debug log
            } else {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                toggleIcon.classList.remove('rotated');
                console.log('Collapsed'); // Debug log
            }
        } else {
            console.error('Could not find content or toggle icon elements');
        }
    }

    function toggleEventTypeSelection(eventType, event) {
        const card = document.querySelector(`[data-type="${eventType}"]`);
        if (!card) return;
        
        // Check if Ctrl/Cmd key is held for multi-select
        const isMultiSelect = event.ctrlKey || event.metaKey;
        
        if (isMultiSelect) {
            if (selectedEventTypes.has(eventType)) {
                selectedEventTypes.delete(eventType);
                card.classList.remove('selected');
            } else {
                selectedEventTypes.add(eventType);
                card.classList.add('selected');
            }
        } else {
            // Single select mode
            if (selectedEventTypes.size === 1 && selectedEventTypes.has(eventType)) {
                // Clicking the same type again clears the filter
                selectedEventTypes.clear();
                card.classList.remove('selected');
            } else {
                // Select only this type
                selectedEventTypes.clear();
                eventTypeCards.forEach(c => c.classList.remove('selected'));
                selectedEventTypes.add(eventType);
                card.classList.add('selected');
            }
        }
        
        filterByEventTypes(selectedEventTypes);
    }

    // Event handlers
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            switchView(this.dataset.view);
        });
    });
    
    // Add event listeners for filterable event type cards
    eventTypeCards.forEach(card => {
        card.addEventListener('click', function(e) {
            const type = this.dataset.type;
            toggleEventTypeSelection(type, e);
        });
    });
    


    // Initialize the view (default to monthly)
    switchView('monthly');
});

// Make functions available globally
window.toggleEventTypeFilter = function() {
    console.log('Global toggle function called'); // Debug log
    const content = document.getElementById('event-types-filter-content');
    const toggleIcon = document.getElementById('event-filter-toggle');
    
    console.log('Content element:', content); // Debug log
    console.log('Toggle icon:', toggleIcon); // Debug log
    
    if (content && toggleIcon) {
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            content.classList.add('expanded');
            toggleIcon.classList.add('rotated');
            console.log('Expanded'); // Debug log
        } else {
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            toggleIcon.classList.remove('rotated');
            console.log('Collapsed'); // Debug log
        }
    } else {
        console.error('Could not find content or toggle icon elements');
    }
};

window.clearEventTypeFilter = function() {
    console.log('Clear filter called'); // Debug log
    // We need to access the variables from the DOMContentLoaded scope
    const eventTypeCards = document.querySelectorAll('.event-type-card.filterable');
    eventTypeCards.forEach(card => card.classList.remove('selected'));
    
    // Reset all table rows to visible
    document.querySelectorAll('.events-table tbody tr').forEach(row => {
        row.style.display = '';
    });
    
    // Reset stats to original values
    // This is a simplified reset - in a real implementation you'd want to call the original functions
    location.reload(); // Simple solution: reload the page to reset everything
};

window.toggleMonthCard = function(monthId) {
    console.log('Toggle month card called for:', monthId); // Debug log
    const content = document.getElementById('month-content-' + monthId);
    const toggleIcon = document.getElementById('month-toggle-' + monthId);
    
    console.log('Month content element:', content); // Debug log
    console.log('Month toggle icon:', toggleIcon); // Debug log
    
    if (content && toggleIcon) {
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            content.classList.add('expanded');
            toggleIcon.classList.add('rotated');
            console.log('Month expanded:', monthId); // Debug log
        } else {
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            toggleIcon.classList.remove('rotated');
            console.log('Month collapsed:', monthId); // Debug log
        }
    } else {
        console.error('Could not find month content or toggle icon elements for:', monthId);
    }
};

window.toggleSchoolCard = function(schoolId) {
    console.log('Toggle school card called for:', schoolId); // Debug log
    const content = document.getElementById('school-content-' + schoolId);
    const toggleIcon = document.getElementById('school-toggle-' + schoolId);
    
    console.log('School content element:', content); // Debug log
    console.log('School toggle icon:', toggleIcon); // Debug log
    
    if (content && toggleIcon) {
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            content.classList.add('expanded');
            toggleIcon.classList.add('rotated');
            console.log('School expanded:', schoolId); // Debug log
        } else {
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            toggleIcon.classList.remove('rotated');
            console.log('School collapsed:', schoolId); // Debug log
        }
    } else {
        console.error('Could not find school content or toggle icon elements for:', schoolId);
    }
};

window.toggleSummaryView = function() {
    const detailedBreakdown = document.getElementById('detailed-breakdown');
    const toggleBtn = document.getElementById('summary-toggle-btn');
    
    if (detailedBreakdown && toggleBtn) {
        if (detailedBreakdown.style.display === 'none') {
            detailedBreakdown.style.display = 'block';
            toggleBtn.innerHTML = '<i class="fas fa-chart-line"></i> Hide Detailed Breakdown';
        } else {
            detailedBreakdown.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Show Detailed Breakdown';
        }
    }
};

// Enhanced breakdown update functions
function updateVolunteersBreakdown(volunteers) {
    // Find the Enhanced Volunteers Breakdown section
    const volunteersSections = document.querySelectorAll('.breakdown-section');
    let volunteersSection = null;
    
    volunteersSections.forEach(section => {
        const header = section.querySelector('h3');
        if (header && header.textContent.includes('Enhanced Volunteers')) {
            volunteersSection = section;
        }
    });
    
    if (volunteersSection) {
        const cards = volunteersSection.querySelectorAll('.breakdown-card');
        if (cards.length >= 3) {
            // Engagements card
            updateBreakdownCardData(cards[0], volunteers.total, volunteers.in_person, volunteers.virtual, volunteers.in_person_pct, volunteers.virtual_pct);
            
            // Unique volunteers card
            updateBreakdownCardData(cards[1], volunteers.unique_total, volunteers.unique_in_person, volunteers.unique_virtual);
            
            // Volunteer hours card
            updateBreakdownCardData(cards[2], volunteers.hours_total.toFixed(1), volunteers.hours_in_person.toFixed(1), volunteers.hours_virtual.toFixed(1), volunteers.hours_in_person_pct, volunteers.hours_virtual_pct);
        }
    }
}

function updateOrganizationsBreakdown(organizations) {
    // Find the Enhanced Organizations Breakdown section
    const orgSections = document.querySelectorAll('.breakdown-section');
    let orgSection = null;
    
    orgSections.forEach(section => {
        const header = section.querySelector('h3');
        if (header && header.textContent.includes('Enhanced Organizations')) {
            orgSection = section;
        }
    });
    
    if (orgSection) {
        const cards = orgSection.querySelectorAll('.breakdown-card');
        if (cards.length >= 2) {
            // Unique organizations card
            updateBreakdownCardData(cards[0], organizations.unique_total, organizations.unique_in_person, organizations.unique_virtual, organizations.unique_in_person_pct, organizations.unique_virtual_pct);
            
            // Organization volunteer hours card
            updateBreakdownCardData(cards[1], organizations.volunteer_hours_total.toFixed(1), organizations.volunteer_hours_in_person.toFixed(1), organizations.volunteer_hours_virtual.toFixed(1), organizations.volunteer_hours_in_person_pct, organizations.volunteer_hours_virtual_pct);
        }
    }
}

function updateVirtualSessionsBreakdown(virtualSessions) {
    // Find the Virtual Sessions Breakdown section
    const virtualSections = document.querySelectorAll('.breakdown-section');
    let virtualSection = null;
    
    virtualSections.forEach(section => {
        const header = section.querySelector('h3');
        if (header && header.textContent.includes('Virtual Sessions')) {
            virtualSection = section;
        }
    });
    
    if (virtualSection) {
        const cards = virtualSection.querySelectorAll('.breakdown-card');
        if (cards.length >= 2) {
            // Classrooms reached card
            const classroomsCard = cards[0];
            const classroomsTotal = classroomsCard.querySelector('.breakdown-total');
            const classroomsItems = classroomsCard.querySelectorAll('.breakdown-item .breakdown-value');
            
            if (classroomsTotal) classroomsTotal.textContent = virtualSessions.classrooms_reached;
            if (classroomsItems.length >= 2) {
                classroomsItems[0].textContent = virtualSessions.registered_teachers;
                classroomsItems[1].textContent = virtualSessions.confirmed_teachers;
            }
            
            // Unique teachers card
            const teachersCard = cards[1];
            const teachersTotal = teachersCard.querySelector('.breakdown-total');
            const teachersItems = teachersCard.querySelectorAll('.breakdown-item .breakdown-value');
            
            if (teachersTotal) teachersTotal.textContent = virtualSessions.unique_teachers;
            if (teachersItems.length >= 2) {
                teachersItems[0].textContent = virtualSessions.registered_teachers;
                teachersItems[1].textContent = virtualSessions.confirmed_teachers;
            }
        }
    }
}

function updateBreakdownCardData(card, total, inPerson, virtual, inPersonPct, virtualPct) {
    const totalElement = card.querySelector('.breakdown-total');
    const items = card.querySelectorAll('.breakdown-item');
    
    if (totalElement) {
        totalElement.textContent = total;
    }
    
    if (items.length >= 2) {
        const inPersonValue = items[0].querySelector('.breakdown-value');
        const inPersonPercent = items[0].querySelector('.breakdown-percent');
        const virtualValue = items[1].querySelector('.breakdown-value');
        const virtualPercent = items[1].querySelector('.breakdown-percent');
        
        if (inPersonValue) inPersonValue.textContent = inPerson;
        if (inPersonPercent && inPersonPct !== undefined) inPersonPercent.textContent = `(${inPersonPct}%)`;
        if (virtualValue) virtualValue.textContent = virtual;
        if (virtualPercent && virtualPct !== undefined) virtualPercent.textContent = `(${virtualPct}%)`;
    }
}
</script>
{% endblock %} 