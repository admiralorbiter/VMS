{% extends 'base.html' %}
{% block title %}Volunteers by Event{% endblock %}

{% block extra_css %}
<style>
  /* Override main container constraints for better space usage */
  main {
    max-width: none !important;
    padding: 5px !important;
    margin: 0 !important;
  }

  .report-container {
    max-width: 100%;
    margin: 0;
    padding: 0 5px;
    width: 100%;
  }
  .report-header {
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom: 16px;
  }
  .report-title {
    color:#2c5aa0;
    margin:0;
    font-size: 2rem;
  }
  .filters-card {
    background:#f8f9fa;
    border:1px solid #e5e7eb;
    border-radius:8px;
    padding:16px;
    margin-bottom:16px;
  }
  .event-types {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    max-height: 240px;
    overflow:auto;
    padding:10px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius:8px;
  }
  .event-pill {
    --bs-btn-padding-y:.2rem;
    --bs-btn-padding-x:.6rem;
    --bs-btn-font-size:.85rem;
    border-radius:20px;
  }
  .btn-check:checked + .event-pill {
    background:#2c5aa0;
    color:#fff;
    border-color:#2c5aa0;
    box-shadow: 0 0 0 .15rem rgba(44,90,160,.25);
  }
  .event-pill:hover {
    border-color:#2c5aa0;
    color:#2c5aa0;
  }
  .export-btn {
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .table-card {
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:8px;
    overflow:hidden;
  }
  .table thead th {
    background:#2c5aa0;
    color:#fff;
    cursor:pointer;
    user-select:none;
    position:relative;
    white-space: nowrap;
    padding: 8px 6px;
    font-size: 0.85rem;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .table thead th:nth-child(1) { width: 12%; }
  .table thead th:nth-child(2) { width: 18%; }
  .table thead th:nth-child(3) { width: 15%; }
  .table thead th:nth-child(4) { width: 15%; }
  .table thead th:nth-child(5) { width: 20%; }
  .table thead th:nth-child(6) { width: 10%; }
  .table thead th:nth-child(7) { width: 8%; }
  .table thead th:nth-child(8) { width: 2%; }
  .table thead th.sortable::after {
    content:'\2195';
    position:absolute;
    right:10px;
    opacity:.7;
  }
  .table thead th.sort-asc::after {
    content:'\2191';
    opacity:1;
  }
  .table thead th.sort-desc::after {
    content:'\2193';
    opacity:1;
  }

  /* Compact table design to fit all columns without scrolling */
  .table-responsive {
    overflow: visible;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    width: 100%;
  }
  .table {
    margin-bottom: 0;
    width: 100%;
    table-layout: fixed; /* Fixed layout for consistent column widths */
  }
  .table td {
    vertical-align: middle;
    padding: 6px 8px;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .table .cell-name { width: 12%; }
  .table .cell-email { width: 18%; }
  .table .cell-org { width: 15%; }
  .table .cell-skills { width: 15%; white-space: normal; }
  .table .cell-events { width: 20%; white-space: normal; }
  .table .cell-last { width: 10%; text-align: center; }
  .table .cell-last-email { width: 8%; }
  .table .cell-total-volunteer { width: 2%; text-align: center; }

  /* Link styling for volunteer and organization names */
  .volunteer-link, .organization-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .volunteer-link:hover, .organization-link:hover {
    color: #0056b3;
    text-decoration: underline;
    transform: translateY(-1px);
  }

  .volunteer-link:visited, .organization-link:visited {
    color: #6f42c1;
  }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
  <div class="report-header">
    <h2 class="report-title"><i class="fa-solid fa-users"></i> Volunteers by Event</h2>
    <a class="btn btn-sm btn-outline-primary export-btn" href="{{ url_for('report.volunteers_by_event_excel', **export_params) }}">
      <i class="fa-solid fa-file-excel"></i> Export Excel
    </a>
  </div>

  <form class="filters-card" method="get" action="{{ url_for('report.volunteers_by_event_report') }}">
    <div class="row g-3 align-items-end">
      <div class="col-lg-3 col-md-6">
        <label class="form-label">School Year</label>
        <input type="text" name="school_year" value="{{ school_year }}" class="form-control" placeholder="e.g., 2324">
        <div class="form-text">Leave blank to use date range.</div>
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label">From</label>
        <input type="date" name="date_from" value="{{ date_from }}" class="form-control">
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label">To</label>
        <input type="date" name="date_to" value="{{ date_to }}" class="form-control">
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label">Event Title Contains</label>
        <input type="text" name="title" value="{{ title_contains }}" class="form-control" placeholder="Career Fair">
      </div>
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-end flex-wrap gap-2">
          <label class="form-label mb-0">Event Types</label>
          <div class="event-pills-actions d-flex align-items-center">
            <input class="form-control form-control-sm d-inline-block w-auto me-2" id="eventTypeSearch" type="text" placeholder="Search types...">
            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="btnSelectAll">Select all</button>
            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="btnClearAll">Clear</button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnDefaults">Defaults</button>
          </div>
        </div>
        <div class="event-types mt-2" id="eventTypePills">
          {% for value, label in type_choices %}
            <input class="btn-check" type="checkbox" name="event_types" value="{{ value }}" id="type_{{ value }}" {% if value in selected_types %}checked{% endif %}>
            <label class="btn btn-outline-secondary event-pill" for="type_{{ value }}" data-label="{{ label|lower }}">{{ label }}</label>
          {% endfor %}
        </div>
      </div>
      <div class="col-12">
        <button class="btn btn-primary"><i class="fa-solid fa-magnifying-glass"></i> Apply</button>
      </div>
    </div>
  </form>

  <div class="table-card">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Name</th>
            <th class="sortable" data-sort="email">Email</th>
            <th class="sortable" data-sort="organization">Organization</th>
            <th class="sortable" data-sort="skills">Skills</th>
            <th class="sortable" data-sort="events">Events</th>
            <th class="sortable" data-sort="last">Last Volunteered Date</th>
            <th class="sortable" data-sort="last_email">Last Email</th>
            <th class="sortable" data-sort="total_volunteer"># Times</th>
          </tr>
        </thead>
        <tbody>
          {% for v in volunteers %}
          <tr>
            <td class="cell-name">
              <a href="{{ url_for('volunteers.view_volunteer', id=v.id) }}" class="volunteer-link">
                {{ v.name }}
              </a>
            </td>
            <td class="cell-email">{{ v.email }}</td>
            <td class="cell-org">
              {% if v.organization_id %}
                <a href="{{ url_for('organizations.view_organization', id=v.organization_id) }}" class="organization-link">
                  {{ v.organization }}
                </a>
              {% else %}
                {{ v.organization }}
              {% endif %}
            </td>
            <td class="cell-skills">{{ v.skills }}</td>
            <td class="cell-events" data-count="{{ v.event_count }}" title="{{ v.events_display }}">
              <div style="max-height: 60px; overflow: hidden;">{{ v.events_display }}</div>
              <div class="small text-muted">({{ v.event_count }})</div>
            </td>
            <td class="cell-last" data-count="{{ v.future_events_count }}">
              <div>{{ v.last_event_date.strftime('%m/%d/%y') if v.last_event_date }}</div>
              {% if v.future_events_count > 0 %}
                <div class="text-success small">{{ v.future_events_count }} upcoming</div>
              {% endif %}
            </td>
            <td class="cell-last-email">{{ v.last_non_internal_email_date.strftime('%m/%d/%y') if v.last_non_internal_email_date }}</td>
            <td class="cell-total-volunteer" data-count="{{ v.total_volunteer_count }}">{{ v.total_volunteer_count }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">No results found for the selected filters.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Sorting logic for table
  const table = document.querySelector('.table');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  const headers = table.querySelectorAll('th.sortable');
  let currentSort = { key: null, dir: 'asc' };

  headers.forEach(h => {
    h.addEventListener('click', () => {
      const key = h.dataset.sort;
      if (currentSort.key === key) {
        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort = { key, dir: 'asc' };
      }
      headers.forEach(x => x.classList.remove('sort-asc','sort-desc'));
      h.classList.add(currentSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
      sortRows(currentSort.key, currentSort.dir);
    });
  });

  function text(el, sel) { const n = el.querySelector(sel); return (n ? n.textContent : el.querySelector(sel)?.textContent || '').trim(); }
  function sortRows(key, dir) {
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const mult = dir === 'asc' ? 1 : -1;
    rows.sort((a,b) => {
      let av='', bv='';
      switch(key){
        case 'name': av = a.querySelector('.cell-name').textContent.trim().toLowerCase(); bv = b.querySelector('.cell-name').textContent.trim().toLowerCase(); break;
        case 'email': av = a.querySelector('.cell-email').textContent.trim().toLowerCase(); bv = b.querySelector('.cell-email').textContent.trim().toLowerCase(); break;
        case 'organization': av = a.querySelector('.cell-org').textContent.trim().toLowerCase(); bv = b.querySelector('.cell-org').textContent.trim().toLowerCase(); break;
        case 'skills': av = a.querySelector('.cell-skills').textContent.trim().toLowerCase(); bv = b.querySelector('.cell-skills').textContent.trim().toLowerCase(); break;
        case 'events': av = parseInt(a.querySelector('.cell-events').dataset.count || '0'); bv = parseInt(b.querySelector('.cell-events').dataset.count || '0'); break;
        case 'last': av = a.querySelector('.cell-last').textContent.trim(); bv = b.querySelector('.cell-last').textContent.trim();
                    // convert mm/dd/yy -> Date (ignore the "upcoming" text)
                    av = av.split('\n')[0]; bv = bv.split('\n')[0];
                    av = av ? new Date(av) : new Date(0); bv = bv ? new Date(bv) : new Date(0); break;
        case 'last_email': av = a.querySelector('.cell-last-email').textContent.trim(); bv = b.querySelector('.cell-last-email').textContent.trim();
                    // convert mm/dd/yy -> Date
                    av = av ? new Date(av) : new Date(0); bv = bv ? new Date(bv) : new Date(0); break;
        case 'total_volunteer': av = parseInt(a.querySelector('.cell-total-volunteer').dataset.count || '0'); bv = parseInt(b.querySelector('.cell-total-volunteer').dataset.count || '0'); break;
      }
      if (typeof av === 'string' && typeof bv === 'string') { if (av > bv) return 1*mult; if (av < bv) return -1*mult; return 0; }
      return (av - bv) * mult;
    });
    tbody.innerHTML = '';
    rows.forEach(r => tbody.appendChild(r));
  }

  // Event type pills behavior
  const search = document.getElementById('eventTypeSearch');
  const container = document.getElementById('eventTypePills');
  const btnSelectAll = document.getElementById('btnSelectAll');
  const btnClearAll = document.getElementById('btnClearAll');
  const btnDefaults = document.getElementById('btnDefaults');

  if (search && container) {
    search.addEventListener('input', () => {
      const q = search.value.trim().toLowerCase();
      const labels = container.querySelectorAll('label.event-pill');
      labels.forEach(l => {
        const match = l.dataset.label.includes(q);
        l.style.display = match ? '' : 'none';
        const input = document.getElementById(l.getAttribute('for'));
        if (input) input.style.display = match ? 'none' : 'none'; // keep inputs hidden (controlled by labels)
      });
    });
  }

  function allInputs(){ return Array.from(container.querySelectorAll('input.btn-check')); }
  if (btnSelectAll) btnSelectAll.addEventListener('click', () => { allInputs().forEach(i => i.checked = true); });
  if (btnClearAll) btnClearAll.addEventListener('click', () => { allInputs().forEach(i => i.checked = false); });
  if (btnDefaults) btnDefaults.addEventListener('click', () => {
    const defaults = new Set(['career_fair','data_viz']);
    allInputs().forEach(i => { i.checked = defaults.has(i.value); });
  });
});
</script>
{% endblock %}
