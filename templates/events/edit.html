{#
Event Edit Template
==================

This template provides a form for editing existing events in the VMS system.

Key Features:
- Pre-populated form with existing event data
- Form validation with error display
- Skills management with dynamic add/remove functionality
- Organized sections for basic info, event details, and skills
- FontAwesome icons for visual enhancement
- Responsive grid layout for form fields
- CSRF protection for security

Template Variables:
- form: EventForm instance with validation and field definitions
- event: Event object with current data to be edited

Form Sections:
1. Basic Information: Title, type, dates, location, format, status, volunteers needed
2. Event Details: Description field for detailed event information
3. Skills Required: Dynamic skills management with add/remove functionality

Security: CSRF token included for POST request protection
#}

{% extends "base.html" %}

{% block title %}Edit Event{% endblock %}

{% block extra_css %}
{# Include events-specific CSS for styling and layout #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/events.css') }}">
{% endblock %}

{% block content %}

{# Phase D-3: Define macro for field editability check #}
{% macro can_edit(field_name) %}
{%- if editable_fields is defined and editable_fields != ['all'] -%}
{%- if field_name in editable_fields -%}true{%- else -%}false{%- endif -%}
{%- else -%}true{%- endif -%}
{% endmacro %}

{# Phase D-3: District Admin Notice Banner #}
{% if is_tenant_user is defined and is_tenant_user %}
<div
    style="background: linear-gradient(135deg, #e0f2fe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px;">
    <div style="display: flex; align-items: center; gap: 12px;">
        <i class="fa-solid fa-shield-halved" style="font-size: 1.5em; color: #1d4ed8;"></i>
        <div>
            <strong style="color: #1d4ed8;">District Admin Access</strong>
            <p style="margin: 4px 0 0 0; color: #1e40af; font-size: 0.9em;">
                You can edit: status, cancellation details, teachers, and presenters. Other fields are managed by PrepKC
                staff.
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="events-container">
    {# Header section with title and navigation actions #}
    <div class="events-header">
        <h1>Edit Event</h1>
        <div class="header-actions">
            <a href="{{ url_for('events.view_event', id=event.id) }}" class="cancel-btn">
                <i class="fa-solid fa-eye"></i> View
            </a>
            <a href="{{ url_for('events.events') }}" class="cancel-btn">
                <i class="fa-solid fa-arrow-left"></i> Back to Events
            </a>
        </div>
    </div>

    {# Main form for event editing - POST method for data submission #}
    <form method="POST" class="event-form">
        {# CSRF protection token - required for all POST requests #}
        {{ form.csrf_token }}

        {# Error display section - shows validation errors if form submission fails #}
        {% if form.errors %}
        <div class="alert alert-danger">
            <ul>
                {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                <li>{{ field }}: {{ error }}</li>
                {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {# Section 1: Basic Event Information #}
        <div class="form-section">
            <h2 class="section-title">
                <i class="fa-solid fa-info-circle"></i>
                Basic Information
            </h2>
            <div class="form-grid">
                {# Event Title - Required field with heading icon #}
                <div class="form-group required">
                    {{ form.title.label(class="form-label") }}
                    <div class="input-wrapper">
                        <i class="fa-solid fa-heading"></i>
                        {{ form.title(class="form-control") }}
                    </div>
                </div>

                {# Event Type - Required field with tag icon #}
                <div class="form-group required">
                    {{ form.type.label(class="form-label") }}
                    <div class="input-wrapper">
                        <i class="fa-solid fa-tag"></i>
                        {{ form.type(class="form-select") }}
                    </div>
                </div>

                {# Start Date - Required field with calendar icon #}
                <div class="form-group required">
                    {{ form.start_date.label(class="form-label") }}
                    <div class="input-wrapper">
                        <i class="fa-solid fa-calendar-plus"></i>
                        {{ form.start_date(class="form-control") }}
                    </div>
                </div>

                {# End Date - Required field with calendar check icon #}
                <div class="form-group required">
                    {{ form.end_date.label(class="form-label") }}
                    <div class="input-wrapper">
                        <i class="fa-solid fa-calendar-check"></i>
                        {{ form.end_date(class="form-control") }}
                    </div>
                </div>

                {# Location - Optional field with location icon #}
                <div class="form-group">
                    {{ form.location.label(class="form-label") }}
                    <div class="input-wrapper">
                        <i class="fa-solid fa-location-dot"></i>
                        {{ form.location(class="form-control") }}
                    </div>
                </div>

                {# Event Format - Optional field with desktop icon #}
                <div class="form-group">
                    {{ form.format.label(class="form-label") }}
                    <div class="input-wrapper">
                        <i class="fa-solid fa-desktop"></i>
                        {{ form.format(class="form-select") }}
                    </div>
                </div>

                {# Event Status - Optional field with info icon #}
                <div class="form-group">
                    {{ form.status.label(class="form-label") }}
                    <div class="input-wrapper">
                        <i class="fa-solid fa-circle-info"></i>
                        {{ form.status(class="form-select") }}
                    </div>
                </div>

                {# Volunteers Needed - Optional field with users icon #}
                <div class="form-group">
                    {{ form.volunteers_needed.label(class="form-label") }}
                    <div class="input-wrapper">
                        <i class="fa-solid fa-users"></i>
                        {{ form.volunteers_needed(class="form-control", min="0") }}
                    </div>
                </div>

                {# Cancellation Reason Section - Only shown when status is CANCELLED #}
                <div id="cancellation-section" class="form-group full-width" style="display: none;">
                    <div
                        style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <h4 style="color: #856404; margin: 0 0 10px 0;">
                            <i class="fa-solid fa-ban"></i> Cancellation Details
                        </h4>
                        <div class="form-grid" style="gap: 15px;">
                            <div class="form-group">
                                {{ form.cancellation_reason.label(class="form-label") }}
                                <div class="input-wrapper">
                                    <i class="fa-solid fa-question-circle"></i>
                                    {{ form.cancellation_reason(class="form-select", id="cancellation-reason") }}
                                </div>
                            </div>
                            <div class="form-group" id="notes-group">
                                {{ form.cancellation_notes.label(class="form-label") }}
                                <span id="notes-required" style="color: #dc3545; display: none;"> (Required for
                                    "Other")</span>
                                <div class="input-wrapper">
                                    {{ form.cancellation_notes(class="form-control", rows="2", placeholder="Enter reason
                                    details...") }}
                                </div>
                            </div>
                        </div>
                        {% if event.cancellation_set_at %}
                        <small style="color: #666; margin-top: 10px; display: block;">
                            Set on {{ event.cancellation_set_at.strftime('%b %d, %Y at %I:%M %p') }}
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {# Section 2: Event Details - Description field #}
        <div class="form-section">
            <h2 class="section-title">
                <i class="fa-solid fa-align-left"></i>
                Event Details
            </h2>
            <div class="form-group full-width">
                {{ form.description.label(class="form-label") }}
                <div class="input-wrapper">
                    {{ form.description(class="form-control", rows="4") }}
                </div>
            </div>
        </div>

        {# Section 2.5: Participants - Teachers and Presenters (Phase D-5) #}
        {% if event.type and event.type.value == 'Virtual Session' %}
        <div class="form-section">
            <h2 class="section-title">
                <i class="fa-solid fa-users"></i>
                Participants
            </h2>
            <div class="form-grid">
                <div class="form-group">
                    {{ form.educators.label(class="form-label") }}
                    <div class="input-wrapper">
                        {{ form.educators(class="form-control", placeholder="Jane Doe; John Smith") }}
                    </div>
                    <small class="form-text text-muted">Semicolon-separated teacher names</small>
                </div>
                <div class="form-group">
                    {{ form.professionals.label(class="form-label") }}
                    <div class="input-wrapper">
                        {{ form.professionals(class="form-control", placeholder="Presenter Name; Another Name") }}
                    </div>
                    <small class="form-text text-muted">Semicolon-separated presenter names</small>
                </div>
            </div>
        </div>
        {% endif %}

        {# Section 3: Skills Management - Dynamic skills add/remove functionality #}
        <div class="form-section">
            <h2><i class="fa-solid fa-brain"></i> Skills Required</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="skill-input">Add Skills</label>
                    {# Skills input group with add button #}
                    <div class="skill-input-group">
                        <input type="text" id="skill-input" class="form-control skill-input"
                            placeholder="Enter a skill...">
                        <button type="button" class="add-skill-btn" onclick="addSkill()">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    {# Container for existing skills with remove functionality #}
                    <div id="skills-container" class="skills-grid">
                        {% for skill in event.skills %}
                        <div class="skill-tag" data-skill-id="{{ skill.id }}">
                            <span>{{ skill.name }}</span>
                            <button type="button" onclick="removeSkill(this)">
                                <i class="fa-solid fa-times"></i>
                            </button>
                            <input type="hidden" name="skills[]" value="{{ skill.id }}">
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {# Form action buttons - Save and Cancel #}
        <div class="form-actions">
            {{ form.submit(class="save-btn") }}
            <a href="{{ url_for('events.view_event', id=event.id) }}" class="cancel-btn">
                <i class="fa-solid fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{# Include events-specific JavaScript for skills management functionality #}
<script src="{{ url_for('static', filename='js/events.js') }}"></script>
<script>
    // Cancellation section visibility toggle
    document.addEventListener('DOMContentLoaded', function () {
        const statusField = document.querySelector('select[name="status"]');
        const cancellationSection = document.getElementById('cancellation-section');
        const reasonField = document.getElementById('cancellation-reason');
        const notesRequired = document.getElementById('notes-required');

        function toggleCancellationSection() {
            if (statusField && cancellationSection) {
                const isCancelled = statusField.value.toLowerCase() === 'cancelled';
                cancellationSection.style.display = isCancelled ? 'block' : 'none';
            }
        }

        function toggleNotesRequired() {
            if (reasonField && notesRequired) {
                const isOther = reasonField.value === 'Other';
                notesRequired.style.display = isOther ? 'inline' : 'none';
            }
        }

        // Initial state
        toggleCancellationSection();
        toggleNotesRequired();

        // Listen for changes
        if (statusField) statusField.addEventListener('change', toggleCancellationSection);
        if (reasonField) reasonField.addEventListener('change', toggleNotesRequired);

        // Phase D-3: Apply field restrictions for tenant users
        {% if is_tenant_user is defined and is_tenant_user and editable_fields is defined and editable_fields != ['all'] %}
        const editableFields = {{ editable_fields | tojson
    }};
    const allFormInputs = document.querySelectorAll('.event-form input, .event-form select, .event-form textarea');
    const disabledInputs = [];

    allFormInputs.forEach(function (input) {
        const fieldName = input.name;
        // Skip CSRF token, submit buttons, and hidden inputs
        if (fieldName === 'csrf_token') return;
        if (input.type === 'submit' || input.type === 'button' || input.type === 'hidden') return;

        // Check if field is editable
        if (!editableFields.includes(fieldName) && fieldName) {
            input.disabled = true;
            input.style.backgroundColor = '#f3f4f6';
            input.style.cursor = 'not-allowed';
            input.title = 'This field is managed by PrepKC staff';
            disabledInputs.push(input);
        }
    });

    // Add visual indicator to disabled field groups
    document.querySelectorAll('.event-form input:disabled, .event-form select:disabled').forEach(function (input) {
        const formGroup = input.closest('.form-group');
        if (formGroup) {
            formGroup.style.opacity = '0.7';
        }
    });

    // IMPORTANT: Re-enable disabled fields before form submission
    // Disabled fields don't submit their values, so we need to enable them first
    const form = document.querySelector('.event-form');
    if (form) {
        form.addEventListener('submit', function (e) {
            // Re-enable all the fields we disabled so their values are submitted
            disabledInputs.forEach(function (input) {
                input.disabled = false;
            });
        });
    }
    {% endif %}
    });
</script>
{% endblock %}
